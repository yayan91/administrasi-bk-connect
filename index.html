<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAP-BK Connect</title>
    
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Menggunakan font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Library untuk generate PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Library untuk membaca file Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Menerapkan font Inter sebagai font utama */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
        }
        /* Style untuk notifikasi dan transisi lainnya */
        #notification, #deleteModal, #studentDetailModal, #deleteAllDataModal, #counselingDetailModal, #consultationDetailModal, #classicalServiceDetailModal, #groupGuidanceDetailModal, #groupCounselingDetailModal, #mailOutDetailModal, #mailInDetailModal {
            transition: opacity 0.3s, transform 0.3s;
        }
        .tab-button.active, .nav-trigger.active {
            border-bottom-color: #f59e0b; /* amber-500 */
            color: #f59e0b;
        }
        .sub-tab-button.active {
            background-color: #475569; /* slate-600 */
            color: #f1f5f9; /* slate-100 */
        }
        /* Custom scrollbar styling for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Style untuk input form agar lebih konsisten */
        input, select, textarea {
             transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            outline: 0;
            border-color: #f59e0b !important; /* amber-500 */
            box-shadow: 0 0 0 0.2rem rgb(245 158 11 / 25%);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

    <!-- Halaman Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 rounded-2xl shadow-2xl p-8 space-y-6 text-center">
            <div>
                <h1 class="text-3xl font-bold text-slate-100">SIAP - BK 2.0</h1>
				<h3 class="text-3xl font-bold text-slate-100">"MASA UJI COBA"</h3>
                <p class="text-slate-400 mt-2">Sistem Informasi Administrasi Pelayanan Bimbingan dan Konseling Digital (SIAP-BK)</p>
            </div>
            <div class="space-y-4">
                 <div>
                    <label for="tokenInput" class="block text-sm font-medium text-slate-300 text-left">Token Akses</label>
                    <input type="password" id="tokenInput" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-3 border focus:border-amber-500" placeholder="Masukkan token Anda">
                </div>
                <button id="loginButton" class="w-full px-6 py-3 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 transition-colors shadow-lg shadow-amber-900/30">Masuk Aplikasi</button>
                <p class="text-xs text-slate-500 pt-2">Token default adalah: 123456</p>
				<p class="text-xs text-slate-500 pt-2">Hak Cipta Muhammad Hasratul - 085259259767</p>
            </div>
        </div>
    </div>


    <!-- Kontainer utama aplikasi -->
    <div id="mainApp" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <div class="max-w-7xl mx-auto bg-slate-800 rounded-2xl shadow-2xl shadow-black/30">
            
            <!-- Header dan Navigasi -->
            <header class="p-6 sm:p-8 border-b border-slate-700 relative">
                <button id="logoutButton" class="absolute top-6 right-6 px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"></path></svg>
                    <span>Keluar</span>
                </button>
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-slate-100">SIAP - BK 2.0</h1>
                    <p id="headerSchoolName" class="text-lg font-semibold text-amber-400 mt-2">Nama Sekolah Belum Diatur</p>
                    <p id="headerTeacherName" class="text-sm text-slate-300 mt-1">Guru BK: Nama Guru Belum Diatur</p>
                    <p class="text-slate-400 mt-2">Pilih menu di bawah untuk mengelola data.</p>
                </div>
                <nav class="flex justify-center space-x-1 sm:space-x-2 flex-wrap text-sm sm:text-base">
                    <!-- Tombol navigasi diperbaiki dengan data-target -->
                    <button data-target="dashboardSection" class="tab-button active py-3 px-2 sm:px-4 font-semibold text-slate-400 border-b-2 border-transparent hover:text-amber-500 transition-colors">Dashboard</button>
                    <button data-target="schoolProfileSection" class="tab-button py-3 px-2 sm:px-4 font-semibold text-slate-400 border-b-2 border-transparent hover:text-amber-500 transition-colors">Profil Sekolah</button>
                    <button data-target="studentProfileSection" class="tab-button py-3 px-2 sm:px-4 font-semibold text-slate-400 border-b-2 border-transparent hover:text-amber-500 transition-colors">Profil Siswa</button>
                    <!-- Dropdown Layanan BK -->
                    <div class="relative" id="layananBkDropdownContainer">
                        <button id="layananBkDropdownButton" class="nav-trigger py-3 px-2 sm:px-4 font-semibold text-slate-400 border-b-2 border-transparent hover:text-amber-500 transition-colors flex items-center space-x-1">
                            <span>Layanan BK</span>
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div id="layananBkDropdownContent" class="absolute z-20 mt-2 w-56 rounded-md shadow-lg bg-slate-700 ring-1 ring-black ring-opacity-5 hidden origin-top-right right-0 sm:right-auto sm:left-0">
                            <div class="py-1">
                                <button data-target="individualCounselingSection" class="tab-button text-left w-full block px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 hover:text-amber-500">Konseling Individu</button>
                                <button data-target="consultationSection" class="tab-button text-left w-full block px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 hover:text-amber-500">Konsultasi</button>
                                <button data-target="classicalServiceSection" class="tab-button text-left w-full block px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 hover:text-amber-500">Layanan Klasikal</button>
                                <button data-target="groupGuidanceSection" class="tab-button text-left w-full block px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 hover:text-amber-500">Bimbingan Kelompok</button>
                                <button data-target="groupCounselingSection" class="tab-button text-left w-full block px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 hover:text-amber-500">Konseling Kelompok</button>
                                <button data-target="journalSection" class="tab-button text-left w-full block px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 hover:text-amber-500">Jurnal</button>
                            </div>
                        </div>
                    </div>
                    <button data-target="mailSection" class="tab-button py-3 px-2 sm:px-4 font-semibold text-slate-400 border-b-2 border-transparent hover:text-amber-500 transition-colors">Surat Keluar/Masuk</button>
                    <button data-target="settingsSection" class="tab-button py-3 px-2 sm:px-4 font-semibold text-slate-400 border-b-2 border-transparent hover:text-amber-500 transition-colors">Pengaturan</button>
                </nav>
            </header>

             <!-- Header Tanggal -->
            <div id="dateHeader" class="text-center py-4 text-sm font-medium text-slate-400 border-b border-slate-700"></div>

            <!-- Konten Aplikasi -->
            <main class="p-6 sm:p-8">

                 <!-- Bagian Dashboard -->
                <section id="dashboardSection">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-100">Rekapitulasi Data</h2>
                        <button id="printDashboardPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 sm:gap-6">
                        <!-- Card Total Siswa -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-amber-400" id="totalSiswa">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Total Siswa</p>
                        </div>
                        <!-- Card Siswa Laki-laki -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-blue-400" id="totalSiswaLaki">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Siswa Laki-laki</p>
                        </div>
                        <!-- Card Siswa Perempuan -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-pink-400" id="totalSiswaPerempuan">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Siswa Perempuan</p>
                        </div>
                         <!-- Card Konseling Individu -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-sky-400" id="totalKonselingIndividu">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Konseling Individu</p>
                        </div>
                         <!-- Card Konsultasi -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-emerald-400" id="totalKonsultasi">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Sesi Konsultasi</p>
                        </div>
                         <!-- Card Layanan Klasikal -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-rose-400" id="totalLayananKlasikal">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Layanan Klasikal</p>
                        </div>
                         <!-- Card Bimbingan Kelompok -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-violet-400" id="totalBimbinganKelompok">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Bimbingan Kelompok</p>
                        </div>
                         <!-- Card Konseling Kelompok -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-fuchsia-400" id="totalKonselingKelompok">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Konseling Kelompok</p>
                        </div>
                        <!-- Card Surat Keluar -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-orange-400" id="totalSuratKeluar">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Surat Keluar</p>
                        </div>
                        <!-- Card Surat Masuk -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-lime-400" id="totalSuratMasuk">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Surat Masuk</p>
                        </div>
                        <!-- Card Kunjungan Rumah -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-teal-400" id="totalKunjunganRumah">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Kunjungan Rumah</p>
                        </div>
                        <!-- Card Kontrak Perilaku -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-yellow-400" id="totalKontrakPerilaku">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Kontrak Perilaku</p>
                        </div>
                        <!-- Card Surat Izin Keluar -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center">
                            <h3 class="font-bold text-3xl sm:text-4xl text-indigo-400" id="totalSuratIzinKeluar">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Surat Izin Keluar</p>
                        </div>
                         <!-- Card Jurnal -->
                        <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center text-center col-span-2 md:col-span-1">
                            <h3 class="font-bold text-3xl sm:text-4xl text-cyan-400" id="totalJurnal">0</h3>
                            <p class="text-sm font-semibold text-slate-300 mt-2">Catatan Jurnal</p>
                        </div>
                    </div>
                </section>

                <!-- Bagian Profil Sekolah -->
                <section id="schoolProfileSection" class="hidden">
                    <!-- Tampilan Data Sekolah (Default jika ada data) -->
                    <div id="schoolProfileDisplay" class="hidden">
                        <h2 class="text-2xl font-bold text-slate-100 mb-6">Profil Sekolah Tersimpan</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                            <div><strong class="font-medium text-slate-400">Provinsi/Kota:</strong> <span id="display_provinsiKota" class="text-slate-200"></span></div>
                            <div><strong class="font-medium text-slate-400">Tahun Ajaran:</strong> <span id="display_tahunAjaran" class="text-slate-200"></span></div>
                            <div><strong class="font-medium text-slate-400">Dinas:</strong> <span id="display_dinas" class="text-slate-200"></span></div>
                            <div>
                                <strong class="font-medium text-slate-400">Daftar Semester:</strong>
                                <div id="display_semesterList" class="flex flex-wrap gap-2 mt-1"></div>
                            </div>
                            <div><strong class="font-medium text-slate-400">Nama Sekolah:</strong> <span id="display_namaSekolah" class="text-slate-200"></span></div>
                             <div><strong class="font-medium text-slate-400">Kepala Sekolah:</strong> <span id="display_kepalaSekolah" class="text-slate-200"></span></div>
                            <div><strong class="font-medium text-slate-400">Alamat Sekolah:</strong> <span id="display_alamatSekolah" class="text-slate-200"></span></div>
                            <div><strong class="font-medium text-slate-400">NIP Kepala Sekolah:</strong> <span id="display_nipKepalaSekolah" class="text-slate-200"></span></div>
                            <div><strong class="font-medium text-slate-400">Asal Sekolah:</strong> <span id="display_asalSekolah" class="text-slate-200"></span></div>
                            <div><strong class="font-medium text-slate-400">Nama Guru BK:</strong> <span id="display_namaGuruBk" class="text-slate-200"></span></div>
                            <div><strong class="font-medium text-slate-400">NIP Guru BK:</strong> <span id="display_nipGuruBk" class="text-slate-200"></span></div>
                        </div>
                        <!-- Visi Misi and Deskripsi Display -->
                        <div class="mt-6 space-y-4 text-sm">
                            <div>
                                <strong class="font-medium text-slate-400">Visi & Misi Sekolah:</strong>
                                <p id="display_visiMisiSekolah" class="text-slate-200 mt-1 whitespace-pre-wrap bg-slate-700/50 p-3 rounded-md"></p>
                            </div>
                            <div>
                                <strong class="font-medium text-slate-400">Visi & Misi Bimbingan dan Konseling:</strong>
                                <p id="display_visiMisiBk" class="text-slate-200 mt-1 whitespace-pre-wrap bg-slate-700/50 p-3 rounded-md"></p>
                            </div>
                            <div>
                                <strong class="font-medium text-slate-400">Deskripsi Layanan Bimbingan dan Konseling:</strong>
                                <p id="display_deskripsiLayananBk" class="text-slate-200 mt-1 whitespace-pre-wrap bg-slate-700/50 p-3 rounded-md"></p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <strong class="font-medium text-slate-400 text-sm">Kelas Asuh & Wali Kelas:</strong>
                            <div id="display_kelasAsuhList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 mt-2"></div>
                        </div>
                        <div class="pt-6 flex justify-end items-center border-t border-slate-700 mt-8">
                            <button type="button" id="editSchoolProfileButton" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 transition-colors shadow-sm">Edit Profil Sekolah</button>
                        </div>
                    </div>

                    <!-- Form Edit Data Sekolah (Default jika tidak ada data) -->
                    <form id="schoolProfileForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-6">
                                <div><label for="provinsiKota" class="block text-sm font-medium text-slate-300">Provinsi/Kota</label><input type="text" id="provinsiKota" name="provinsiKota" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Contoh: Sulawesi Selatan/Makassar"></div>
                                <div><label for="dinas" class="block text-sm font-medium text-slate-300">Dinas</label><input type="text" id="dinas" name="dinas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Contoh: Dinas Pendidikan..."></div>
                                <div><label for="namaSekolah" class="block text-sm font-medium text-slate-300">Nama Sekolah</label><input type="text" id="namaSekolah" name="namaSekolah" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Masukkan nama sekolah"></div>
                                <div><label for="alamatSekolah" class="block text-sm font-medium text-slate-300">Alamat Sekolah</label><textarea id="alamatSekolah" name="alamatSekolah" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Masukkan alamat lengkap sekolah"></textarea></div>
                                <div><label for="asalSekolah" class="block text-sm font-medium text-slate-300">Asal Sekolah</label><input type="text" id="asalSekolah" name="asalSekolah" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Contoh: Makassar"></div>
                            </div>
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="tahunAjaran" class="block text-sm font-medium text-slate-300">Tahun Ajaran</label><input type="text" id="tahunAjaran" name="tahunAjaran" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Contoh: 2024/2025"></div>
                                    <div>
                                        <label for="semesterInput" class="block text-sm font-medium text-slate-300">Tambah Semester</label>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <input type="text" id="semesterInput" class="block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Contoh: Ganjil 2024/2025">
                                            <button type="button" id="addSemesterButton" class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700">Tambah</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="semesterList" class="space-y-2"></div>
                                <div><label for="kepalaSekolah" class="block text-sm font-medium text-slate-300">Kepala Sekolah</label><input type="text" id="kepalaSekolah" name="kepalaSekolah" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Nama lengkap kepala sekolah"></div>
                                <div><label for="nipKepalaSekolah" class="block text-sm font-medium text-slate-300">NIP Kepala Sekolah</label><input type="text" id="nipKepalaSekolah" name="nipKepalaSekolah" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Masukkan NIP"></div>
                                <div><label for="namaGuruBk" class="block text-sm font-medium text-slate-300">Nama Guru BK</label><input type="text" id="namaGuruBk" name="namaGuruBk" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Nama lengkap guru BK"></div>
                                <div><label for="nipGuruBk" class="block text-sm font-medium text-slate-300">NIP Guru BK</label><input type="text" id="nipGuruBk" name="nipGuruBk" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Masukkan NIP"></div>
                                <div>
                                    <label for="kelasAsuhInput" class="block text-sm font-medium text-slate-300">Tambah Kelas Asuh</label>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <input type="text" id="kelasAsuhInput" class="block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Contoh: X-A">
                                        <button type="button" id="addKelasAsuhButton" class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700">Tambah</button>
                                    </div>
                                    <div id="kelasAsuhList" class="mt-3 space-y-2"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Visi Misi and Deskripsi Form Inputs -->
                        <div class="space-y-6 pt-6 border-t border-slate-700">
                             <div>
                                <label for="visiMisiSekolah" class="block text-sm font-medium text-slate-300">Visi & Misi Sekolah</label>
                                <textarea id="visiMisiSekolah" name="visiMisiSekolah" rows="4" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Masukkan visi dan misi sekolah"></textarea>
                            </div>
                             <div>
                                <label for="visiMisiBk" class="block text-sm font-medium text-slate-300">Visi & Misi Bimbingan dan Konseling</label>
                                <textarea id="visiMisiBk" name="visiMisiBk" rows="4" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Masukkan visi dan misi BK"></textarea>
                            </div>
                             <div>
                                <label for="deskripsiLayananBk" class="block text-sm font-medium text-slate-300">Deskripsi Layanan Bimbingan dan Konseling</label>
                                <textarea id="deskripsiLayananBk" name="deskripsiLayananBk" rows="4" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 border" placeholder="Jelaskan deskripsi layanan BK secara umum"></textarea>
                            </div>
                        </div>
                        <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700">
                            <button type="button" id="cancelSchoolEditButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                            <button type="submit" id="saveSchoolButton" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Perubahan</button>
                        </div>
                    </form>
                </section>

                <!-- Bagian Profil Siswa -->
                <section id="studentProfileSection" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                           <div class="bg-slate-800/50 p-6 rounded-lg border border-slate-700 max-h-[calc(100vh-20rem)] overflow-y-auto">
                             <form id="studentProfileForm" class="space-y-6">
                                <input type="hidden" id="studentId">
                                <h2 id="studentFormTitle" class="text-xl font-bold text-slate-100 sticky top-0 bg-slate-800/50 pb-4 -mt-6 pt-6">Tambah Siswa Baru</h2>
                                <div><label for="namaSiswa" class="block text-sm font-medium text-slate-300">Nama Lengkap</label><input type="text" id="namaSiswa" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></div>
                                <div><label for="nisn" class="block text-sm font-medium text-slate-300">NISN</label><input type="text" id="nisn" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                                <div><label for="kelas" class="block text-sm font-medium text-slate-300">Kelas</label><select id="kelas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option value="">Pilih Kelas</option></select></div>
                                <div><label for="jenisKelamin" class="block text-sm font-medium text-slate-300">Jenis Kelamin</label><select id="jenisKelamin" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Laki-laki</option><option>Perempuan</option></select></div>
                                <div><label for="alamatSiswa" class="block text-sm font-medium text-slate-300">Alamat</label><textarea id="alamatSiswa" rows="2" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                                <hr class="border-slate-700"/>
                                <div><label for="namaAyah" class="block text-sm font-medium text-slate-300">Nama Ayah</label><input type="text" id="namaAyah" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                                <div><label for="hpAyah" class="block text-sm font-medium text-slate-300">No. HP Ayah</label><input type="tel" id="hpAyah" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                                <div><label for="namaIbu" class="block text-sm font-medium text-slate-300">Nama Ibu</label><input type="text" id="namaIbu" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                                <div><label for="hpIbu" class="block text-sm font-medium text-slate-300">No. HP Ibu</label><input type="tel" id="hpIbu" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                                <div><label for="hpSiswa" class="block text-sm font-medium text-slate-300">No. HP Siswa</label><input type="tel" id="hpSiswa" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                                <div><label for="statusAnak" class="block text-sm font-medium text-slate-300">Status dalam Keluarga</label><input type="text" id="statusAnak" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Contoh: Anak Kandung, Anak ke-1"></div>
                                <div class="flex items-center justify-end space-x-4 pt-4 border-t border-slate-700 sticky bottom-0 bg-slate-800/50 -mb-6 pb-6">
                                    <button type="button" id="cancelEditButton" class="px-4 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500 hidden">Batal</button>
                                    <button type="submit" id="saveStudentButton" class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700">Simpan Siswa</button>
                                </div>
                            </form>
                           </div>
                        </div>
                        <div class="lg:col-span-2">
                            <!-- Bulk Upload Section -->
                            <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 mb-6">
                                <h3 class="font-semibold text-slate-100">Unggah Siswa Massal</h3>
                                <p class="text-sm text-slate-400 mt-1 mb-4">Unggah berkas Excel (.xlsx) untuk menambahkan banyak siswa sekaligus. Pastikan kolom sesuai dengan template (Penulisan jenis kelamin adalah : Laki-laki dan Perempuan).</p>
                                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2 space-y-2 sm:space-y-0">
                                    <input type="file" id="bulkStudentUploadInput" accept=".xlsx, .xls" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100/10 file:text-amber-300 hover:file:bg-amber-100/20">
                                    <button id="processBulkUploadButton" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 whitespace-nowrap">Proses Unggahan</button>
                                </div>
                                <a href="#" id="downloadTemplateLink" class="text-sm text-amber-400 hover:underline mt-3 inline-block">Unduh Template Excel</a>
                            </div>

                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-slate-100">Daftar Siswa</h2>
                                <button id="printStudentListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Daftar PDF</button>
                             </div>
                             <div id="studentListContainer" class="space-y-4"></div>
                        </div>
                    </div>
                </section>

                <!-- Bagian Konseling Individu -->
                <section id="individualCounselingSection" class="hidden">
                    <div id="counselingDisplay" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-slate-100">Riwayat Konseling Individu</h2>
                            <div class="flex items-center space-x-2">
                                <button id="printIndividualCounselingPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                <button id="addNewCounselingButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Tambah Sesi Baru</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">Masalah</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                <tbody id="counselingTableBody" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <form id="counselingForm" class="space-y-6">
                        <input type="hidden" id="counselingId">
                        <h2 id="counselingFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Konseling Individu</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div><label for="counseling_tanggal" class="block text-sm font-medium text-slate-300">Tanggal</label><input type="date" id="counseling_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></div>
                            <div><label for="counseling_ke" class="block text-sm font-medium text-slate-300">Konseling Ke-</label><input type="number" id="counseling_ke" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                            <div><label for="counseling_semester" class="block text-sm font-medium text-slate-300">Semester</label><select id="counseling_semester" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></select></div>
                             <div><label for="counseling_ruang" class="block text-sm font-medium text-slate-300">Ruang</label><input type="text" id="counseling_ruang" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" value="Ruang BK"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="counseling_studentId" class="block text-sm font-medium text-slate-300">Pilih Siswa</label><select id="counseling_studentId" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></select></div>
                            <div><label for="counseling_studentClass" class="block text-sm font-medium text-slate-300">Kelas</label><input type="text" id="counseling_studentClass" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" readonly></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div class="space-y-4">
                            <div><label for="counseling_identifikasiMasalah" class="block text-sm font-medium text-slate-300">Identifikasi Masalah</label><textarea id="counseling_identifikasiMasalah" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                            <div><label for="counseling_penjelasanMasalah" class="block text-sm font-medium text-slate-300">Penjelasan Masalah</label><textarea id="counseling_penjelasanMasalah" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div>
                                <label for="counseling_pendekatan" class="block text-sm font-medium text-slate-300">Pendekatan</label>
                                <select id="counseling_pendekatan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                    <option>Aldrean dan Psikodinamik</option>
                                    <option>Belajar Sosial</option>
                                    <option>Gestalt dan Psikodrama</option>
                                    <option>Humanistik dan Fenomenologis</option>
                                    <option>Mindfulness</option>
                                    <option>Perilaku yang menggunakan Hukuman</option>
                                    <option>Perilaku Kognitif</option>
                                    <option>Perilaku yang Menggunakan Reinforcement Positif</option>
                                    <option>Solution Focused Counseling</option>
                                </select>
                             </div>
                             <div>
                                 <label for="counseling_teknik" class="block text-sm font-medium text-slate-300">Teknik</label>
                                 <select id="counseling_teknik" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                        <option>Massages</option>
                                        <option>Acting As If</option>
                                        <option>Spitting in The soup</option>
                                        <option>Mutual Storytelling</option>
                                        <option>Paradoxical Intention</option>
                                        <option>Modeling</option>
                                        <option>Behavioral Rehearsal</option>
                                        <option>Role Play</option>
                                        <option>Empty Chair</option>
                                        <option>Body Movement & Exaggeration</option>
                                        <option>Self-Disclosure</option>
                                        <option>Confrontation</option>
                                        <option>Motivational Interviewing</option>
                                        <option>Strength Bombardment</option>
                                        <option>Visual/Guided Imagery</option>
                                        <option>Deep Breathing</option>
                                        <option>Progressive Muscle Relaxation Training</option>
                                        <option>Extinction</option>
                                        <option>Time Out</option>
                                        <option>Response Cost</option>
                                        <option>Overcorrection</option>
                                        <option>Self-Talk</option>
                                        <option>Reframing</option>
                                        <option>Thought Stopping</option>
                                        <option>Cognitive Restructuring</option>
                                        <option>Rational Emotive Behavior Therapy</option>
                                        <option>Biblioterapy</option>
                                        <option>Journaling</option>
                                        <option>Systematic Desensitization</option>
                                        <option>Premack Principle</option>
                                        <option>Behavior Chart</option>
                                        <option>Token Economy</option>
                                        <option>Behavioral Contract</option>
                                        <option>Scaling;Exceptions</option>
                                        <option>Problem Free Talk</option>
                                        <option>Miracle Question</option>
                                        <option>Flagging the Minefield</option>
                                     </select>
                             </div>
                             <div>
                                <label for="counseling_aspekLayanan" class="block text-sm font-medium text-slate-300">Aspek Layanan</label>
                                <select id="counseling_aspekLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                    <option>Landasan Hidup Religius</option>
                                    <option>Landasan Perilaku Etis</option>
                                    <option>Kematangan Emosi</option>
                                    <option>Kematangan Intelektual</option>
                                    <option>Tanggung Jawab Sosial</option>
                                    <option>Kesadaran Gender</option>
                                    <option>Pengembangan Pribadi</option>
                                    <option>Perilaku Kewirausahaan</option>
                                    <option>Wawasan dan Kesiapan Karir</option>
                                    <option>Kematangan Hubungan Teman Sebaya</option>
                                    <option>Kematangan untuk Menikah dan Berkeluarga</option>
                                </select>
                             </div>
                         </div>
                        <hr class="border-slate-700"/>
                        <div class="space-y-4">
                            <div><label for="counseling_alternatif" class="block text-sm font-medium text-slate-300">Alternatif Pemecahan Masalah</label><textarea id="counseling_alternatif" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                            <div><label for="counseling_hasil" class="block text-sm font-medium text-slate-300">Hasil</label><textarea id="counseling_hasil" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div><label for="counseling_komponenLayanan" class="block text-sm font-medium text-slate-300">Komponen Layanan</label><select id="counseling_komponenLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Layanan Dasar</option><option>Layanan Responsif</option><option>Layanan Peminatan & Perencanaan Individual</option><option>Dukungan Sistem</option></select></div>
                             <div><label for="counseling_bidangBimbingan" class="block text-sm font-medium text-slate-300">Bidang Bimbingan</label><select id="counseling_bidangBimbingan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Pribadi</option><option>Sosial</option><option>Belajar</option><option>Karir</option></select></div>
                             <div><label for="counseling_statusKonseling" class="block text-sm font-medium text-slate-300">Status Konseling</label><select id="counseling_statusKonseling" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Selesai</option><option>Proses</option><option>Rujukan</option></select></div>
                         </div>
                        <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                            <button type="button" id="cancelCounselingButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Sesi</button>
                        </div>
                    </form>
                </section>

                <!-- Bagian Konsultasi -->
                <section id="consultationSection" class="hidden">
                    <div id="consultationDisplay" class="hidden">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-slate-100">Riwayat Konsultasi</h2>
                            <div class="flex items-center space-x-2">
                                <button id="printConsultationListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                <button id="addNewConsultationButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Tambah Sesi Baru</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Nama Konsulti</th><th scope="col" class="px-6 py-3">Topik</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                <tbody id="consultationTableBody" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <form id="consultationForm" class="space-y-6">
                        <input type="hidden" id="consultationId">
                        <h2 id="consultationFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Konsultasi</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="consultation_namaKonsulti" class="block text-sm font-medium text-slate-300">Nama Konsulti</label><input type="text" id="consultation_namaKonsulti" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required placeholder="Nama orang tua, guru, dll."></div>
                             <div><label for="consultation_statusKonsulti" class="block text-sm font-medium text-slate-300">Status Konsulti</label><input type="text" id="consultation_statusKonsulti" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Contoh: Orang Tua dari Siswa X"></div>
                        </div>
                        <div><label for="consultation_namaKonsultan" class="block text-sm font-medium text-slate-300">Nama Konsultan (Guru BK)</label><input type="text" id="consultation_namaKonsultan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" readonly></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div><label for="consultation_hari" class="block text-sm font-medium text-slate-300">Hari</label><input type="text" id="consultation_hari" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                             <div><label for="consultation_tanggal" class="block text-sm font-medium text-slate-300">Tanggal</label><input type="date" id="consultation_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></div>
                             <div><label for="consultation_durasiKonsultasi" class="block text-sm font-medium text-slate-300">Durasi</label><input type="text" id="consultation_durasiKonsultasi" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Contoh: 60 Menit"></div>
                         </div>
                        <hr class="border-slate-700"/>
                        <div class="space-y-4">
                           <div><label for="consultation_uraianTopik" class="block text-sm font-medium text-slate-300">Uraian Topik Pembicaraan</label><textarea id="consultation_uraianTopik" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="consultation_hasilKonsultasi" class="block text-sm font-medium text-slate-300">Hasil Konsultasi</label><textarea id="consultation_hasilKonsultasi" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="consultation_followUp" class="block text-sm font-medium text-slate-300">Follow Up / Tindak Lanjut</label><textarea id="consultation_followUp" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div><label for="consultation_komponenLayanan" class="block text-sm font-medium text-slate-300">Komponen Layanan</label><select id="consultation_komponenLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Layanan Dasar</option><option>Layanan Responsif</option><option>Layanan Peminatan & Perencanaan Individual</option><option>Dukungan Sistem</option></select></div>
                             <div><label for="consultation_bidangBimbingan" class="block text-sm font-medium text-slate-300">Bidang Bimbingan</label><select id="consultation_bidangBimbingan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Pribadi</option><option>Sosial</option><option>Belajar</option><option>Karir</option></select></div>
                         </div>
                        <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                             <button type="button" id="cancelConsultationButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Sesi</button>
                        </div>
                    </form>
                </section>

                <!-- Bagian Layanan Klasikal -->
                <section id="classicalServiceSection" class="hidden">
                    <div id="classicalServiceDisplay" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold text-slate-100">Daftar Layanan Klasikal</h2>
                             <div class="flex items-center space-x-2">
                                <button id="printClassicalServiceListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                <button id="addNewClassicalServiceButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Tambah Layanan Baru</button>
                             </div>
                        </div>
                        <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Topik Layanan</th><th scope="col" class="px-6 py-3">Sasaran</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                <tbody id="classicalServiceTableBody" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <form id="classicalServiceForm" class="space-y-6">
                        <input type="hidden" id="classicalId">
                        <h2 id="classicalServiceFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Layanan Klasikal</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div><label for="classical_tanggal" class="block text-sm font-medium text-slate-300">Tanggal Layanan</label><input type="date" id="classical_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></div>
                            <div><label for="classical_semester" class="block text-sm font-medium text-slate-300">Semester</label><select id="classical_semester" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></select></div>
                             <div class="md:col-span-2"><label for="classical_sasaran" class="block text-sm font-medium text-slate-300">Sasaran Layanan</label><input type="text" id="classical_sasaran" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Contoh: Kelas X-A"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-3"><label for="classical_topik" class="block text-sm font-medium text-slate-300">Topik Layanan</label><input type="text" id="classical_topik" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                            <div><label for="classical_bidangLayanan" class="block text-sm font-medium text-slate-300">Bidang Layanan</label><select id="classical_bidangLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Pribadi</option><option>Sosial</option><option>Belajar</option><option>Karir</option></select></div>
                            <div><label for="classical_metode" class="block text-sm font-medium text-slate-300">Metode Layanan</label><input type="text" id="classical_metode" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                            <div><label for="classical_media" class="block text-sm font-medium text-slate-300">Media/Sumber</label><input type="text" id="classical_media" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div class="space-y-4">
                           <div><label for="classical_tujuan" class="block text-sm font-medium text-slate-300">Tujuan Layanan</label><textarea id="classical_tujuan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div>
                                <label for="classical_aspekLayanan" class="block text-sm font-medium text-slate-300">Aspek Layanan</label>
                                <select id="classical_aspekLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                    <option>Landasan Hidup Religius</option>
                                    <option>Landasan Perilaku Etis</option>
                                    <option>Kematangan Emosi</option>
                                    <option>Kematangan Intelektual</option>
                                    <option>Tanggung Jawab Sosial</option>
                                    <option>Kesadaran Gender</option>
                                    <option>Pengembangan Pribadi</option>
                                    <option>Perilaku Kewirausahaan</option>
                                    <option>Wawasan dan Kesiapan Karir</option>
                                    <option>Kematangan Hubungan Teman Sebaya</option>
                                    <option>Kematangan untuk Menikah dan Berkeluarga</option>
                                </select>
                           </div>
                           <div><label for="classical_capaian" class="block text-sm font-medium text-slate-300">Capaian Layanan</label><textarea id="classical_capaian" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="classical_evaluasi" class="block text-sm font-medium text-slate-300">Evaluasi & Tindak Lanjut</label><textarea id="classical_evaluasi" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="classical_dokumentasi" class="block text-sm font-medium text-slate-300">Dokumentasi</label><textarea id="classical_dokumentasi" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Catatan atau link dokumentasi..."></textarea></div>
                        </div>
                        <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                             <button type="button" id="cancelClassicalServiceButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Layanan</button>
                        </div>
                    </form>
                </section>

                <!-- Bagian Bimbingan Kelompok -->
                <section id="groupGuidanceSection" class="hidden">
                     <div id="groupGuidanceDisplay" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold text-slate-100">Daftar Bimbingan Kelompok</h2>
                             <div class="flex items-center space-x-2">
                                <button id="printGroupGuidanceListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                <button id="addNewGroupGuidanceButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Tambah Bimbingan Baru</button>
                             </div>
                        </div>
                        <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Jumlah Siswa</th><th scope="col" class="px-6 py-3">Aspek Layanan</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                <tbody id="groupGuidanceTableBody" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <form id="groupGuidanceForm" class="space-y-6">
                        <input type="hidden" id="groupGuidanceId">
                        <h2 id="groupGuidanceFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Bimbingan Kelompok</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div><label for="group_guidance_tanggal" class="block text-sm font-medium text-slate-300">Tanggal Bimbingan</label><input type="date" id="group_guidance_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></div>
                            <div><label for="group_guidance_semester" class="block text-sm font-medium text-slate-300">Semester</label><select id="group_guidance_semester" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></select></div>
                             <div class="md:col-span-2"><label for="group_guidance_durasi" class="block text-sm font-medium text-slate-300">Durasi</label><input type="text" id="group_guidance_durasi" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Contoh: 2 x 45 Menit"></div>
                        </div>
                        
                        <!-- Pemilihan Siswa -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Anggota Kelompok</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <select id="group_guidance_studentSelector" class="block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option value="">Pilih Siswa...</option></select>
                                <button type="button" id="addGroupGuidanceStudentButton" class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 whitespace-nowrap">Tambah Siswa</button>
                            </div>
                            <div id="group_guidance_studentList" class="mt-3 space-y-2"></div>
                        </div>
                        <hr class="border-slate-700"/>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label for="group_guidance_komponenLayanan" class="block text-sm font-medium text-slate-300">Komponen Layanan</label><select id="group_guidance_komponenLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Layanan Dasar</option><option>Layanan Responsif</option><option>Layanan Peminatan & Perencanaan Individual</option><option>Dukungan Sistem</option></select></div>
                            <div><label for="group_guidance_bidangBimbingan" class="block text-sm font-medium text-slate-300">Bidang Bimbingan</label><select id="group_guidance_bidangBimbingan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Pribadi</option><option>Sosial</option><option>Belajar</option><option>Karir</option></select></div>
                            <div>
                                <label for="group_guidance_aspekLayanan" class="block text-sm font-medium text-slate-300">Aspek Layanan</label>
                                <select id="group_guidance_aspekLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                    <option>Landasan Hidup Religius</option>
                                    <option>Landasan Perilaku Etis</option>
                                    <option>Kematangan Emosi</option>
                                    <option>Kematangan Intelektual</option>
                                    <option>Tanggung Jawab Sosial</option>
                                    <option>Kesadaran Gender</option>
                                    <option>Pengembangan Pribadi</option>
                                    <option>Perilaku Kewirausahaan</option>
                                    <option>Wawasan dan Kesiapan Karir</option>
                                    <option>Kematangan Hubungan Teman Sebaya</option>
                                    <option>Kematangan untuk Menikah dan Berkeluarga</option>
                                </select>
                            </div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div class="space-y-4">
                           <div><label for="group_guidance_tujuanLayanan" class="block text-sm font-medium text-slate-300">Tujuan Layanan</label><textarea id="group_guidance_tujuanLayanan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="group_guidance_eksperientasi" class="block text-sm font-medium text-slate-300">Eksperientasi (Awal)</label><textarea id="group_guidance_eksperientasi" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="group_guidance_identifikasi" class="block text-sm font-medium text-slate-300">Identifikasi (Tahap Dua)</label><textarea id="group_guidance_identifikasi" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="group_guidance_analisis" class="block text-sm font-medium text-slate-300">Analisis (Tahap Tiga)</label><textarea id="group_guidance_analisis" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="group_guidance_generalisasi" class="block text-sm font-medium text-slate-300">Generalisasi (Penutup)</label><textarea id="group_guidance_generalisasi" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                        </div>
                        <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                             <button type="button" id="cancelGroupGuidanceButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Bimbingan</button>
                        </div>
                    </form>
                </section>

                <!-- Bagian Konseling Kelompok -->
                <section id="groupCounselingSection" class="hidden">
                     <div id="groupCounselingDisplay" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold text-slate-100">Daftar Konseling Kelompok</h2>
                             <div class="flex items-center space-x-2">
                                <button id="printGroupCounselingListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                <button id="addNewGroupCounselingButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Tambah Sesi Baru</button>
                             </div>
                        </div>
                        <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Jumlah Siswa</th><th scope="col" class="px-6 py-3">Identifikasi Masalah</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                <tbody id="groupCounselingTableBody" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <form id="groupCounselingForm" class="space-y-6">
                        <input type="hidden" id="groupCounselingId">
                        <h2 id="groupCounselingFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Konseling Kelompok</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div><label for="group_counseling_tanggal" class="block text-sm font-medium text-slate-300">Tanggal Layanan</label><input type="date" id="group_counseling_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></div>
                            <div><label for="group_counseling_semester" class="block text-sm font-medium text-slate-300">Semester</label><select id="group_counseling_semester" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></select></div>
                             <div><label for="group_counseling_durasi" class="block text-sm font-medium text-slate-300">Durasi</label><input type="text" id="group_counseling_durasi" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Contoh: 2 x 45 Menit"></div>
                             <div><label for="group_counseling_tempat" class="block text-sm font-medium text-slate-300">Tempat</label><input type="text" id="group_counseling_tempat" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" value="Ruang BK"></div>
                        </div>
                        
                        <!-- Pemilihan Siswa -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Anggota Kelompok</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <select id="group_counseling_studentSelector" class="block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option value="">Pilih Siswa...</option></select>
                                <button type="button" id="addGroupCounselingStudentButton" class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 whitespace-nowrap">Tambah Siswa</button>
                            </div>
                            <div id="group_counseling_studentList" class="mt-3 space-y-2"></div>
                        </div>
                        <hr class="border-slate-700"/>

                        <div><label for="group_counseling_identifikasiMasalah" class="block text-sm font-medium text-slate-300">Identifikasi Masalah</label><textarea id="group_counseling_identifikasiMasalah" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="group_counseling_pendekatan" class="block text-sm font-medium text-slate-300">Pendekatan</label>
                                <select id="group_counseling_pendekatan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                    <option>Aldrean dan Psikodinamik</option>
                                    <option>Belajar Sosial</option>
                                    <option>Gestalt dan Psikodrama</option>
                                    <option>Humanistik dan Fenomenologis</option>
                                    <option>Mindfulness</option>
                                    <option>Perilaku yang menggunakan Hukuman</option>
                                    <option>Perilaku Kognitif</option>
                                    <option>Perilaku yang Menggunakan Reinforcement Positif</option>
                                    <option>Solution Focused Counseling</option>
                                </select>
                            </div>
                            <div>
                                <label for="group_counseling_teknik" class="block text-sm font-medium text-slate-300">Teknik Konseling</label>
                                <select id="group_counseling_teknik" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                    <option>Massages</option>
                                    <option>Acting As If</option>
                                    <option>Spitting in The soup</option>
                                    <option>Mutual Storytelling</option>
                                    <option>Paradoxical Intention</option>
                                    <option>Modeling</option>
                                    <option>Behavioral Rehearsal</option>
                                    <option>Role Play</option>
                                    <option>Empty Chair</option>
                                    <option>Body Movement & Exaggeration</option>
                                    <option>Self-Disclosure</option>
                                    <option>Confrontation</option>
                                    <option>Motivational Interviewing</option>
                                    <option>Strength Bombardment</option>
                                    <option>Visual/Guided Imagery</option>
                                    <option>Deep Breathing</option>
                                    <option>Progressive Muscle Relaxation Training</option>
                                    <option>Extinction</option>
                                    <option>Time Out</option>
                                    <option>Response Cost</option>
                                    <option>Overcorrection</option>
                                    <option>Self-Talk</option>
                                    <option>Reframing</option>
                                    <option>Thought Stopping</option>
                                    <option>Cognitive Restructuring</option>
                                    <option>Rational Emotive Behavior Therapy</option>
                                    <option>Biblioterapy</option>
                                    <option>Journaling</option>
                                    <option>Systematic Desensitization</option>
                                    <option>Premack Principle</option>
                                    <option>Behavior Chart</option>
                                    <option>Token Economy</option>
                                    <option>Behavioral Contract</option>
                                    <option>Scaling;Exceptions</option>
                                    <option>Problem Free Talk</option>
                                    <option>Miracle Question</option>
                                    <option>Flagging the Minefield</option>
                                </select>
                            </div>
                             <div>
                                <label for="group_counseling_aspekLayanan" class="block text-sm font-medium text-slate-300">Aspek Layanan</label>
                                <select id="group_counseling_aspekLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border">
                                    <option>Landasan Hidup Religius</option>
                                    <option>Landasan Perilaku Etis</option>
                                    <option>Kematangan Emosi</option>
                                    <option>Kematangan Intelektual</option>
                                    <option>Tanggung Jawab Sosial</option>
                                    <option>Kesadaran Gender</option>
                                    <option>Pengembangan Pribadi</option>
                                    <option>Perilaku Kewirausahaan</option>
                                    <option>Wawasan dan Kesiapan Karir</option>
                                    <option>Kematangan Hubungan Teman Sebaya</option>
                                    <option>Kematangan untuk Menikah dan Berkeluarga</option>
                                </select>
                             </div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div class="space-y-4">
                           <div><label for="group_counseling_penyebabMasalah" class="block text-sm font-medium text-slate-300">Penyebab Masalah</label><textarea id="group_counseling_penyebabMasalah" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="group_counseling_alternatif" class="block text-sm font-medium text-slate-300">Alternatif Pemecahan Masalah</label><textarea id="group_counseling_alternatif" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="group_counseling_hasil" class="block text-sm font-medium text-slate-300">Hasil</label><textarea id="group_counseling_hasil" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                        </div>
                        <hr class="border-slate-700"/>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div><label for="group_counseling_komponenLayanan" class="block text-sm font-medium text-slate-300">Komponen Layanan</label><select id="group_counseling_komponenLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Layanan Dasar</option><option>Layanan Responsif</option><option>Layanan Peminatan & Perencanaan Individual</option><option>Dukungan Sistem</option></select></div>
                             <div><label for="group_counseling_bidangLayanan" class="block text-sm font-medium text-slate-300">Bidang Layanan</label><select id="group_counseling_bidangLayanan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Pribadi</option><option>Sosial</option><option>Belajar</option><option>Karir</option></select></div>
                             <div><label for="group_counseling_status" class="block text-sm font-medium text-slate-300">Status Proses</label><select id="group_counseling_status" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"><option>Selesai</option><option>Proses</option><option>Rujukan</option></select></div>
                         </div>
                        <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                             <button type="button" id="cancelGroupCounselingButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Sesi</button>
                        </div>
                    </form>
                </section>
                
                <!-- Bagian Jurnal -->
                <section id="journalSection" class="hidden">
                    <div id="journalDisplay" class="hidden">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-slate-100">Jurnal Kegiatan Harian</h2>
                            <div class="flex items-center space-x-2">
                                <button id="printJournalListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                <button id="addNewJournalButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Tambah Catatan Baru</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tanggal</th><th scope="col" class="px-6 py-3">Uraian Kegiatan</th><th scope="col" class="px-6 py-3">Tindak Lanjut</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                <tbody id="journalTableBody" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <form id="journalForm" class="space-y-6">
                        <input type="hidden" id="journalId">
                        <h2 id="journalFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Jurnal Kegiatan</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="journal_tanggal" class="block text-sm font-medium text-slate-300">Tanggal</label><input type="date" id="journal_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" required></div>
                            <div><label for="journal_semester" class="block text-sm font-medium text-slate-300">Semester</label><select id="journal_semester" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></select></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div class="space-y-4">
                           <div><label for="journal_kegiatan" class="block text-sm font-medium text-slate-300">Uraian Kegiatan / Materi Layanan</label><textarea id="journal_kegiatan" rows="4" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="journal_catatan" class="block text-sm font-medium text-slate-300">Catatan Kejadian</label><textarea id="journal_catatan" rows="4" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="journal_tindakLanjut" class="block text-sm font-medium text-slate-300">Tindak Lanjut</label><textarea id="journal_tindakLanjut" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                           <div><label for="journal_keterangan" class="block text-sm font-medium text-slate-300">Keterangan</label><textarea id="journal_keterangan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border"></textarea></div>
                        </div>
                        <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                             <button type="button" id="cancelJournalButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Catatan</button>
                        </div>
                    </form>
                </section>

                <!-- Bagian Surat Keluar/Masuk -->
                <section id="mailSection" class="hidden">
                    <div class="mb-6 flex justify-center border-b border-slate-700">
                        <button id="showOutgoingMailBtn" class="sub-tab-button active py-2 px-6 font-semibold rounded-t-lg bg-slate-700 hover:bg-slate-600">Surat Keluar</button>
                        <button id="showIncomingMailBtn" class="sub-tab-button py-2 px-6 font-semibold rounded-t-lg bg-slate-900/50 hover:bg-slate-600">Surat Masuk</button>
                        <button id="showHomeVisitBtn" class="sub-tab-button py-2 px-6 font-semibold rounded-t-lg bg-slate-900/50 hover:bg-slate-600">Kunjungan Rumah</button>
                        <button id="showBehaviorContractBtn" class="sub-tab-button py-2 px-6 font-semibold rounded-t-lg bg-slate-900/50 hover:bg-slate-600">Kontrak Perilaku</button>
                        <button id="showStudentPermitOutBtn" class="sub-tab-button py-2 px-6 font-semibold rounded-t-lg bg-slate-900/50 hover:bg-slate-600">Izin Keluar</button>
                    </div>

                    <!-- Konten Surat Keluar -->
                    <div id="outgoingMailContent">
                        <div id="mailOutDisplay" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-slate-100">Daftar Surat Keluar</h2>
                                <div class="flex items-center space-x-2">
                                    <button id="printMailOutListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                    <button id="addNewMailOutButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Buat Surat Baru</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tgl Surat</th><th scope="col" class="px-6 py-3">No. Surat</th><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">Perihal</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                    <tbody id="mailOutTableBody" class="divide-y divide-slate-700"></tbody>
                                </table>
                            </div>
                        </div>

                        <form id="mailOutForm" class="space-y-6">
                            <input type="hidden" id="mailOutId">
                            <h2 id="mailOutFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Surat Keluar (Panggilan)</h2>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div><label for="mailOut_nomorSurat" class="block text-sm font-medium text-slate-300">Nomor Surat</label><input type="text" id="mailOut_nomorSurat" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></div>
                                <div><label for="mailOut_lampiran" class="block text-sm font-medium text-slate-300">Lampiran</label><input type="text" id="mailOut_lampiran" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" value="-"></div>
                                <div><label for="mailOut_tanggalSurat" class="block text-sm font-medium text-slate-300">Tanggal Surat</label><input type="date" id="mailOut_tanggalSurat" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></div>
                             </div>
                             <div><label for="mailOut_perihal" class="block text-sm font-medium text-slate-300">Perihal</label><input type="text" id="mailOut_perihal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" value="Panggilan Orang Tua/Wali"></div>
                             <hr class="border-slate-700"/>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div><label for="mailOut_studentId" class="block text-sm font-medium text-slate-300">Pilih Siswa</label><select id="mailOut_studentId" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></select></div>
                                <div><label for="mailOut_nisn" class="block text-sm font-medium text-slate-300">NISN</label><input type="text" id="mailOut_nisn" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" readonly></div>
                                <div><label for="mailOut_kelas" class="block text-sm font-medium text-slate-300">Kelas</label><input type="text" id="mailOut_kelas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" readonly></div>
                             </div>
                             <div><label for="mailOut_namaWaliKelas" class="block text-sm font-medium text-slate-300">Nama Wali Kelas</label><input type="text" id="mailOut_namaWaliKelas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" readonly></div>
                             <hr class="border-slate-700"/>
                              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div><label for="mailOut_panggilanKe" class="block text-sm font-medium text-slate-300">Panggilan Ke-</label><input type="number" id="mailOut_panggilanKe" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></div>
                                <div class="md:col-span-2"><label for="mailOut_hariTanggalPertemuan" class="block text-sm font-medium text-slate-300">Hari & Tanggal Pertemuan</label><input type="text" id="mailOut_hariTanggalPertemuan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" placeholder="Contoh: Senin, 10 Oktober 2024"></div>
                                <div><label for="mailOut_waktuPertemuan" class="block text-sm font-medium text-slate-300">Waktu Pertemuan</label><input type="text" id="mailOut_waktuPertemuan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" placeholder="Contoh: 09:00 WITA"></div>
                             </div>
                             <div><label for="mailOut_tempatPertemuan" class="block text-sm font-medium text-slate-300">Tempat Pertemuan</label><input type="text" id="mailOut_tempatPertemuan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" value="Ruang BK"></div>
                             <div><label for="mailOut_alasanPemanggilan" class="block text-sm font-medium text-slate-300">Alasan Pemanggilan</label><textarea id="mailOut_alasanPemanggilan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                            <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                                <button type="button" id="cancelMailOutButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                                <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Surat</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Konten Surat Masuk -->
                    <div id="incomingMailContent" class="hidden">
                        <div id="mailInDisplay" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-slate-100">Daftar Surat Masuk</h2>
                                <button id="addNewMailInButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Tambah Surat Baru</button>
                            </div>
                            <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tgl Surat</th><th scope="col" class="px-6 py-3">No. Surat</th><th scope="col" class="px-6 py-3">Perihal</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                    <tbody id="mailInTableBody" class="divide-y divide-slate-700"></tbody>
                                </table>
                            </div>
                        </div>

                        <form id="mailInForm" class="space-y-6">
                            <input type="hidden" id="mailInId">
                            <h2 id="mailInFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Surat Masuk</h2>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="mailIn_nomorSurat" class="block text-sm font-medium text-slate-300">Nomor Surat</label><input type="text" id="mailIn_nomorSurat" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></div>
                                <div><label for="mailIn_tanggalSurat" class="block text-sm font-medium text-slate-300">Tanggal Surat</label><input type="date" id="mailIn_tanggalSurat" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></div>
                             </div>
                             <div><label for="mailIn_perihal" class="block text-sm font-medium text-slate-300">Perihal</label><input type="text" id="mailIn_perihal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></div>
                             <div><label for="mailIn_keterangan" class="block text-sm font-medium text-slate-300">Keterangan</label><textarea id="mailIn_keterangan" rows="4" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                            <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                                <button type="button" id="cancelMailInButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                                <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Surat</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Konten Kunjungan Rumah -->
                    <div id="homeVisitContent" class="hidden">
                        <div id="homeVisitDisplay" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-slate-100">Daftar Kunjungan Rumah</h2>
                                <div class="flex items-center space-x-2">
                                    <button id="printHomeVisitListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                    <button id="addNewHomeVisitButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Buat Laporan Baru</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tgl Kunjungan</th><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">Petugas</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                    <tbody id="homeVisitTableBody" class="divide-y divide-slate-700"></tbody>
                                </table>
                            </div>
                        </div>

                        <form id="homeVisitForm" class="space-y-6">
                            <input type="hidden" id="homeVisitId">
                            <h2 id="homeVisitFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Laporan Kunjungan Rumah</h2>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="homeVisit_nomorSurat" class="block text-sm font-medium text-slate-300">Nomor Surat Tugas (jika ada)</label><input type="text" id="homeVisit_nomorSurat" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></div>
                                <div><label for="homeVisit_tanggal" class="block text-sm font-medium text-slate-300">Tanggal Kunjungan</label><input type="date" id="homeVisit_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></div>
                             </div>
                             <hr class="border-slate-700"/>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div><label for="homeVisit_studentId" class="block text-sm font-medium text-slate-300">Pilih Siswa</label><select id="homeVisit_studentId" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></select></div>
                                <div><label for="homeVisit_nisn" class="block text-sm font-medium text-slate-300">NISN</label><input type="text" id="homeVisit_nisn" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" readonly></div>
                                <div><label for="homeVisit_kelas" class="block text-sm font-medium text-slate-300">Kelas</label><input type="text" id="homeVisit_kelas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" readonly></div>
                             </div>
                             <hr class="border-slate-700"/>
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="homeVisit_petugas" class="block text-sm font-medium text-slate-300">Petugas Kunjungan</label><input type="text" id="homeVisit_petugas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" placeholder="Nama Guru BK, Wali Kelas, dll."></div>
                                <div><label for="homeVisit_waktu" class="block text-sm font-medium text-slate-300">Waktu Kunjungan</label><input type="text" id="homeVisit_waktu" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" placeholder="Contoh: 10:00 WITA"></div>
                             </div>
                             <div><label for="homeVisit_hasil" class="block text-sm font-medium text-slate-300">Uraian Hasil Kunjungan</label><textarea id="homeVisit_hasil" rows="4" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                             <div><label for="homeVisit_tindakLanjut" class="block text-sm font-medium text-slate-300">Tindak Lanjut</label><textarea id="homeVisit_tindakLanjut" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                            <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                                <button type="button" id="cancelHomeVisitButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                                <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Laporan</button>
                            </div>
                        </form>
                    </div>

                    <!-- Konten Kontrak Perilaku -->
                    <div id="behaviorContractContent" class="hidden">
                        <div id="behaviorContractDisplay" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-slate-100">Daftar Kontrak Perilaku Siswa</h2>
                                <div class="flex items-center space-x-2">
                                    <button id="printBehaviorContractListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                    <button id="addNewBehaviorContractButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Buat Kontrak Baru</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tgl Kontrak</th><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">Perilaku</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                    <tbody id="behaviorContractTableBody" class="divide-y divide-slate-700"></tbody>
                                </table>
                            </div>
                        </div>

                        <form id="behaviorContractForm" class="space-y-6">
                            <input type="hidden" id="behaviorContractId">
                            <h2 id="behaviorContractFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Kontrak Perilaku Siswa</h2>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="behaviorContract_tanggal" class="block text-sm font-medium text-slate-300">Tanggal Kontrak</label><input type="date" id="behaviorContract_tanggal" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></div>
                                <div><label for="behaviorContract_tanggalTinjauan" class="block text-sm font-medium text-slate-300">Tanggal Tinjauan</label><input type="date" id="behaviorContract_tanggalTinjauan" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></div>
                             </div>
                             <hr class="border-slate-700"/>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2"><label for="behaviorContract_studentId" class="block text-sm font-medium text-slate-300">Pilih Siswa</label><select id="behaviorContract_studentId" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></select></div>
                                <div><label for="behaviorContract_kelas" class="block text-sm font-medium text-slate-300">Kelas</label><input type="text" id="behaviorContract_kelas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" readonly></div>
                             </div>
                             <hr class="border-slate-700"/>
                             <div class="space-y-4">
                                <div><label for="behaviorContract_deskripsiPerilaku" class="block text-sm font-medium text-slate-300">Deskripsi Perilaku yang Akan Diubah</label><textarea id="behaviorContract_deskripsiPerilaku" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                                <div><label for="behaviorContract_tujuanPerubahan" class="block text-sm font-medium text-slate-300">Tujuan Perubahan Perilaku</label><textarea id="behaviorContract_tujuanPerubahan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                                <div><label for="behaviorContract_rencanaTindakan" class="block text-sm font-medium text-slate-300">Rencana Tindakan Siswa</label><textarea id="behaviorContract_rencanaTindakan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                                <div><label for="behaviorContract_konsekuensi" class="block text-sm font-medium text-slate-300">Konsekuensi (Positif/Negatif)</label><textarea id="behaviorContract_konsekuensi" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                             </div>
                              <div><label for="behaviorContract_status" class="block text-sm font-medium text-slate-300">Status Kontrak</label><select id="behaviorContract_status" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"><option>Aktif</option><option>Selesai</option><option>Dilanggar</option></select></div>
                            <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                                <button type="button" id="cancelBehaviorContractButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                                <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Kontrak</button>
                            </div>
                        </form>
                    </div>

                    <!-- Konten Surat Izin Keluar Siswa -->
                    <div id="studentPermitOutContent" class="hidden">
                        <div id="studentPermitOutDisplay" class="hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-slate-100">Daftar Surat Izin Keluar Siswa</h2>
                                <div class="flex items-center space-x-2">
                                    <button id="printStudentPermitOutListPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 text-sm shadow-sm">Cetak Rekap PDF</button>
                                    <button id="addNewStudentPermitOutButton" class="px-5 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Buat Surat Izin Baru</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Tgl Izin</th><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">Alasan</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                    <tbody id="studentPermitOutTableBody" class="divide-y divide-slate-700"></tbody>
                                </table>
                            </div>
                        </div>

                        <form id="studentPermitOutForm" class="space-y-6">
                            <input type="hidden" id="studentPermitOutId">
                            <h2 id="studentPermitOutFormTitle" class="text-2xl font-bold text-slate-100 mb-2">Formulir Surat Izin Keluar Siswa</h2>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="studentPermitOut_tanggalIzin" class="block text-sm font-medium text-slate-300">Tanggal Izin</label><input type="date" id="studentPermitOut_tanggalIzin" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></div>
                                <div><label for="studentPermitOut_durasi" class="block text-sm font-medium text-slate-300">Durasi Izin</label><input type="text" id="studentPermitOut_durasi" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" placeholder="Contoh: 1 Hari / 2 Jam Pelajaran"></div>
                             </div>
                             <hr class="border-slate-700"/>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2"><label for="studentPermitOut_studentId" class="block text-sm font-medium text-slate-300">Pilih Siswa</label><select id="studentPermitOut_studentId" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" required></select></div>
                                <div><label for="studentPermitOut_kelas" class="block text-sm font-medium text-slate-300">Kelas</label><input type="text" id="studentPermitOut_kelas" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border" readonly></div>
                             </div>
                             <hr class="border-slate-700"/>
                             <div><label for="studentPermitOut_alasan" class="block text-sm font-medium text-slate-300">Alasan Izin</label><textarea id="studentPermitOut_alasan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                             <div><label for="studentPermitOut_keterangan" class="block text-sm font-medium text-slate-300">Keterangan Tambahan</label><textarea id="studentPermitOut_keterangan" rows="3" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 p-2 border"></textarea></div>
                            <div class="pt-6 flex justify-end items-center space-x-4 border-t border-slate-700 mt-8">
                                <button type="button" id="cancelStudentPermitOutButton" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg font-medium hover:bg-slate-500">Batal</button>
                                <button type="submit" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 shadow-sm">Simpan Surat Izin</button>
                            </div>
                        </form>
                    </div>
                </section>


                <!-- Bagian Pengaturan -->
                <section id="settingsSection" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6">Pengaturan Data</h2>
                    <div class="space-y-6 max-w-xl">
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <h3 class="font-semibold text-slate-100">Ubah Token Akses</h3>
                            <p class="text-sm text-slate-400 mt-1 mb-4">Ganti token default untuk meningkatkan keamanan.</p>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="newTokenInput" class="block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 p-2 border" placeholder="Masukkan token baru">
                                <button id="saveTokenButton" class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 whitespace-nowrap">Simpan Token</button>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <h3 class="font-semibold text-slate-100">Logo Kop Surat</h3>
                            <p class="text-sm text-slate-400 mt-1 mb-4">Unggah logo sekolah (format .png) untuk kop surat PDF.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="logoKiriInput" class="block text-sm font-medium text-slate-300">Logo Kiri</label>
                                    <input type="file" id="logoKiriInput" accept=".png" class="mt-1 block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100/10 file:text-amber-300 hover:file:bg-amber-100/20">
                                    <img id="logoKiriPreview" class="mt-2 h-20 w-20 object-contain bg-slate-700 rounded hidden">
                                </div>
                                <div>
                                    <label for="logoKananInput" class="block text-sm font-medium text-slate-300">Logo Kanan</label>
                                    <input type="file" id="logoKananInput" accept=".png" class="mt-1 block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100/10 file:text-amber-300 hover:file:bg-amber-100/20">
                                    <img id="logoKananPreview" class="mt-2 h-20 w-20 object-contain bg-slate-700 rounded hidden">
                                </div>
                            </div>
                             <div class="flex justify-end mt-4">
                                <button id="saveLogosButton" class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 whitespace-nowrap">Simpan Logo</button>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex justify-between items-center"><div><h3 class="font-semibold text-slate-100">Backup Data</h3><p class="text-sm text-slate-400 mt-1">Simpan semua data ke dalam sebuah berkas.</p></div><button id="backupButton" class="px-4 py-2 bg-sky-600 text-white rounded-lg font-semibold hover:bg-sky-700 whitespace-nowrap">Unduh Backup</button></div>
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex justify-between items-center"><div><h3 class="font-semibold text-slate-100">Restore Data</h3><p class="text-sm text-slate-400 mt-1">Pulihkan data dari berkas backup.</p></div><button id="restoreButton" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 whitespace-nowrap">Unggah Data</button><input type="file" id="restoreFileInput" class="hidden" accept=".json"></div>
                        <div class="bg-rose-900/30 border-l-4 border-rose-500 p-4 rounded-r-lg flex justify-between items-center"><div><h3 class="font-semibold text-rose-300">Hapus Semua Data</h3><p class="text-sm text-rose-400 mt-1">Tindakan ini tidak dapat diurungkan.</p></div><button id="deleteAllButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 whitespace-nowrap">Hapus Data</button></div>
                    </div>
                </section>
            </main>
            <footer class="text-center text-xs text-slate-500 p-4 border-t border-slate-700">
                Aplikasi Administrasi BK | Dibuat oleh Muhammad Hasratul
            </footer>
        </div>
    </div>

    <!-- Elemen Notifikasi -->
    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transform -translate-y-10"></div>
    
    <!-- Modal placeholders -->
    <div id="deleteModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="deleteAllDataModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="studentDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="counselingDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="consultationDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="classicalServiceDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="groupGuidanceDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="groupCounselingDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="mailOutDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="mailInDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="journalDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="homeVisitDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="behaviorContractDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    <div id="studentPermitOutDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0 z-50"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State Aplikasi
            let currentItemIdToDelete = null;
            let currentItemTypeToDelete = '';
            let kelasAsuhData = [];
            let semesterData = [];
            let selectedStudentsForGuidance = [];
            let selectedStudentsForCounseling = [];

            // --- FUNGSI LOGIN ---
            function setupLogin() {
                const loginButton = document.getElementById('loginButton');
                const tokenInput = document.getElementById('tokenInput');
                
                const handleLogin = () => {
                    const storedToken = localStorage.getItem('appToken') || '123456';
                    if (tokenInput.value === storedToken) {
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        initializeApp();
                    } else {
                        showNotification('Token tidak valid!', true);
                        tokenInput.value = '';
                    }
                };

                loginButton.addEventListener('click', handleLogin);
                tokenInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }

            // --- FUNGSI DASHBOARD & TANGGAL ---
            function renderDashboard() {
                const students = getStudents();
                const totalStudents = students.length;
                const maleStudents = students.filter(s => s.jenisKelamin === 'Laki-laki').length;
                const femaleStudents = totalStudents - maleStudents;

                document.getElementById('totalSiswa').textContent = totalStudents;
                document.getElementById('totalSiswaLaki').textContent = maleStudents;
                document.getElementById('totalSiswaPerempuan').textContent = femaleStudents;

                document.getElementById('totalKonselingIndividu').textContent = getCounselingSessions().length;
                document.getElementById('totalKonsultasi').textContent = getConsultations().length;
                document.getElementById('totalLayananKlasikal').textContent = getClassicalServices().length;
                document.getElementById('totalBimbinganKelompok').textContent = getGroupGuidanceSessions().length;
                document.getElementById('totalKonselingKelompok').textContent = getGroupCounselingSessions().length;
                document.getElementById('totalSuratKeluar').textContent = getOutgoingMail().length;
                document.getElementById('totalSuratMasuk').textContent = getIncomingMail().length;
                document.getElementById('totalJurnal').textContent = getJournals().length;
                document.getElementById('totalKunjunganRumah').textContent = getHomeVisits().length;
                document.getElementById('totalKontrakPerilaku').textContent = getBehaviorContracts().length;
                document.getElementById('totalSuratIzinKeluar').textContent = getStudentPermitsOut().length;
            }

            function displayCurrentDate() {
                const dateHeader = document.getElementById('dateHeader');
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateHeader.textContent = now.toLocaleDateString('id-ID', options);
            }

            // --- FUNGSI GENERIC & MODAL ---
            function showNotification(message, isError = false) {
                const el = document.getElementById('notification');
                el.textContent = message;
                el.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transform -translate-y-10 z-50 ${isError ? 'bg-rose-500' : 'bg-emerald-500'}`;
                el.classList.remove('opacity-0', '-translate-y-10');
                setTimeout(() => el.classList.add('opacity-0', '-translate-y-10'), 3000);
            }
            function showModal(modalId, content) {
                const modal = document.getElementById(modalId);
                modal.innerHTML = content;
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                
                modal.querySelectorAll('.close-modal-btn, .cancel-modal-btn').forEach(btn => {
                    btn.addEventListener('click', () => hideModal(modalId));
                });
            }
            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.add('opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); modal.innerHTML = ''; }, 300);
            }
            function setupNavigation() {
                const tabs = document.querySelectorAll('.tab-button');
                const sections = document.querySelectorAll('main > section');
                const layananBkDropdownButton = document.getElementById('layananBkDropdownButton');
                const layananBkDropdownContent = document.getElementById('layananBkDropdownContent');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Deactivate all other main tabs and the dropdown trigger
                        document.querySelectorAll('.tab-button, .nav-trigger').forEach(t => t.classList.remove('active'));
                        
                        // If the clicked tab is inside the dropdown...
                        if (tab.closest('#layananBkDropdownContent')) {
                            // Activate the main dropdown trigger
                            layananBkDropdownButton.classList.add('active');
                        } else {
                            // Otherwise, it's a normal tab, activate it
                            tab.classList.add('active');
                        }
                        
                        // Hide dropdown after selection
                        layananBkDropdownContent.classList.add('hidden');

                        // Show the correct section
                        sections.forEach(sec => sec.classList.add('hidden'));
                        document.getElementById(tab.dataset.target).classList.remove('hidden');
                        
                        const targetId = tab.dataset.target;
                        if (targetId === 'dashboardSection') {
                            renderDashboard();
                        } else if (targetId === 'individualCounselingSection') {
                           populateCounselingStudentDropdown();
                           const sessions = getCounselingSessions();
                           toggleCounselingView(sessions.length === 0 && getStudents().length > 0);
                        } else if (targetId === 'consultationSection') {
                           const consultations = getConsultations();
                           toggleConsultationView(consultations.length === 0);
                           resetConsultationForm(); // to auto-fill consultant name
                        } else if (targetId === 'classicalServiceSection') {
                           const services = getClassicalServices();
                           toggleClassicalServiceView(services.length === 0);
                           resetClassicalServiceForm();
                        } else if (targetId === 'groupGuidanceSection') {
                           const sessions = getGroupGuidanceSessions();
                           toggleGroupGuidanceView(sessions.length === 0 && getStudents().length > 0);
                           populateGroupGuidanceStudentDropdown();
                        } else if (targetId === 'groupCounselingSection') {
                           const sessions = getGroupCounselingSessions();
                           toggleGroupCounselingView(sessions.length === 0 && getStudents().length > 0);
                           populateGroupCounselingStudentDropdown();
                        } else if (targetId === 'journalSection') {
                           const journals = getJournals();
                           toggleJournalView(journals.length === 0);
                        } else if (targetId === 'mailSection') {
                            const mailOut = getOutgoingMail();
                            toggleMailOutView(mailOut.length === 0 && getStudents().length > 0);
                            populateMailOutStudentDropdown();
                            
                            // Reset to default tab
                            document.getElementById('outgoingMailContent').classList.remove('hidden');
                            document.getElementById('incomingMailContent').classList.add('hidden');
                            document.getElementById('homeVisitContent').classList.add('hidden');
                            document.getElementById('behaviorContractContent').classList.add('hidden');
                            document.getElementById('studentPermitOutContent').classList.add('hidden');
                            document.getElementById('showOutgoingMailBtn').classList.add('active', 'bg-slate-700');
                            document.getElementById('showIncomingMailBtn').classList.remove('active', 'bg-slate-700');
                            document.getElementById('showHomeVisitBtn').classList.remove('active', 'bg-slate-700');
                            document.getElementById('showBehaviorContractBtn').classList.remove('active', 'bg-slate-700');
                            document.getElementById('showStudentPermitOutBtn').classList.remove('active', 'bg-slate-700');
                        }
                    });
                });
            }
            function formatDateIndonesian(dateString) {
                if (!dateString) return new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const date = new Date(dateString);
                const options = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' };
                return date.toLocaleDateString('id-ID', options);
            }

            // --- FUNGSI PROFIL SEKOLAH ---
            function toggleSchoolProfileView(showForm) {
                document.getElementById('schoolProfileForm').classList.toggle('hidden', !showForm);
                document.getElementById('schoolProfileDisplay').classList.toggle('hidden', showForm);
            }
            function renderSchoolProfileDisplay(data) {
                for (const key in data) {
                    if (key !== 'kelasAsuh' && key !== 'semesters') {
                         const el = document.getElementById(`display_${key}`);
                         if (el) el.textContent = data[key] || '-';
                    }
                }
                document.getElementById('display_visiMisiSekolah').textContent = data.visiMisiSekolah || 'Belum diisi.';
                document.getElementById('display_visiMisiBk').textContent = data.visiMisiBk || 'Belum diisi.';
                document.getElementById('display_deskripsiLayananBk').textContent = data.deskripsiLayananBk || 'Belum diisi.';
                const listContainer = document.getElementById('display_kelasAsuhList');
                listContainer.innerHTML = '';
                if (data.kelasAsuh && data.kelasAsuh.length > 0) {
                    data.kelasAsuh.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'bg-slate-700 p-2 rounded-md text-sm';
                        div.innerHTML = `<span class="font-semibold text-slate-200">${item.kelas}:</span> <span class="text-slate-300">${item.wali || 'Belum diisi'}</span>`;
                        listContainer.appendChild(div);
                    });
                } else {
                    listContainer.innerHTML = '<span class="text-xs text-slate-500">Belum ada kelas asuh.</span>';
                }
                const semesterListContainer = document.getElementById('display_semesterList');
                semesterListContainer.innerHTML = '';
                if (data.semesters && data.semesters.length > 0) {
                    data.semesters.forEach(item => {
                        const span = document.createElement('span');
                        span.className = 'inline-block bg-slate-700 text-slate-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full';
                        span.textContent = item;
                        semesterListContainer.appendChild(span);
                    });
                } else {
                    semesterListContainer.innerHTML = '<span class="text-xs text-slate-500">Belum ada semester.</span>';
                }
            }
            function renderKelasAsuhList() {
                const listContainer = document.getElementById('kelasAsuhList');
                listContainer.innerHTML = '';
                kelasAsuhData.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2 bg-slate-700 p-2 rounded-md';
                    div.innerHTML = `
                        <span class="text-sm font-medium text-slate-200 flex-1">${item.kelas}</span>
                        <input type="text" placeholder="Nama Wali Kelas" class="wali-kelas-input block w-full flex-2 rounded-md border-slate-600 bg-slate-900 text-slate-200 p-1.5 border text-sm" value="${item.wali || ''}" data-index="${index}">
                        <button type="button" class="delete-kelas-btn text-xl font-bold text-rose-500 hover:text-rose-400" data-index="${index}">&times;</button>
                    `;
                    listContainer.appendChild(div);
                });
            }
            function renderSemesterList() {
                const listContainer = document.getElementById('semesterList');
                listContainer.innerHTML = '';
                semesterData.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-slate-700 p-2 rounded-md text-sm';
                    div.innerHTML = `
                        <span>${item}</span>
                        <button type="button" class="delete-semester-btn font-bold text-rose-400 hover:text-rose-300" data-index="${index}">&times;</button>
                    `;
                    listContainer.appendChild(div);
                });
            }
            function populateKelasDropdown() {
                const schoolData = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const kelasOptions = schoolData.kelasAsuh || [];
                const selectEl = document.getElementById('kelas');
                if (!selectEl) return;
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">Pilih Kelas</option>';
                if (kelasOptions.length > 0) {
                    kelasOptions.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.kelas;
                        option.textContent = item.kelas;
                        selectEl.appendChild(option);
                    });
                }
                selectEl.value = currentVal;
            }
            function populateAllSemesterDropdowns() {
                const schoolData = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const semesterOptions = schoolData.semesters || [];
                const semesterSelects = document.querySelectorAll('#counseling_semester, #classical_semester, #group_guidance_semester, #group_counseling_semester, #journal_semester');
                
                semesterSelects.forEach(selectEl => {
                    const currentVal = selectEl.value;
                    selectEl.innerHTML = '<option value="">Pilih Semester</option>';
                    if (semesterOptions.length > 0) {
                        semesterOptions.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item;
                            option.textContent = item;
                            selectEl.appendChild(option);
                        });
                    }
                    if (currentVal && semesterOptions.includes(currentVal)) {
                         selectEl.value = currentVal;
                    } else if (semesterOptions.length > 0) {
                        selectEl.value = semesterOptions[semesterOptions.length - 1];
                    }
                });
            }
            function loadProfileData() {
                const data = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                kelasAsuhData = data.kelasAsuh || [];
                semesterData = data.semesters || [];
                
                // Populate header elements
                const headerSchoolName = document.getElementById('headerSchoolName');
                const headerTeacherName = document.getElementById('headerTeacherName');
                if (headerSchoolName) { headerSchoolName.textContent = data.namaSekolah || 'Nama Sekolah Belum Diatur'; }
                if (headerTeacherName) { headerTeacherName.textContent = data.namaGuruBk ? `Guru BK: ${data.namaGuruBk}` : 'Guru BK: Belum Diatur'; }

                for (const key in data) {
                    if (key !== 'kelasAsuh' && key !== 'semesters' && document.getElementById(key)) {
                        document.getElementById(key).value = data[key];
                    }
                }
                renderKelasAsuhList();
                renderSemesterList();
                if (Object.keys(data).length > 0) {
                    renderSchoolProfileDisplay(data);
                    toggleSchoolProfileView(false);
                } else {
                    toggleSchoolProfileView(true);
                }
                populateKelasDropdown();
                populateAllSemesterDropdowns();
            }
            function saveProfileData(e) {
                e.preventDefault();
                const formData = {};
                const form = document.getElementById('schoolProfileForm');
                form.querySelectorAll('input, textarea, select').forEach(input => {
                    if (input.id !== 'kelasAsuhInput' && input.id !== 'semesterInput' && input.type !== 'file') formData[input.id] = input.value;
                });
                formData.kelasAsuh = kelasAsuhData;
                formData.semesters = semesterData;
                localStorage.setItem('schoolProfile', JSON.stringify(formData));
                showNotification('Data sekolah berhasil disimpan!');
                renderSchoolProfileDisplay(formData);
                toggleSchoolProfileView(false);
                populateKelasDropdown();
                populateAllSemesterDropdowns();
            }
            function addKelasAsuh() {
                const input = document.getElementById('kelasAsuhInput');
                const className = input.value.trim().toUpperCase();
                if (className && !kelasAsuhData.some(item => item.kelas === className)) {
                    kelasAsuhData.push({ kelas: className, wali: '' });
                    renderKelasAsuhList();
                    input.value = '';
                    input.focus();
                } else if (className) {
                    showNotification('Kelas tersebut sudah ada!', true);
                }
            }
            function addSemester() {
                const input = document.getElementById('semesterInput');
                const semesterName = input.value.trim();
                if (semesterName && !semesterData.includes(semesterName)) {
                    semesterData.push(semesterName);
                    renderSemesterList();
                    input.value = '';
                    input.focus();
                } else if (semesterName) {
                    showNotification('Semester tersebut sudah ada!', true);
                }
            }
            function deleteKelasAsuh(index) {
                kelasAsuhData.splice(index, 1);
                renderKelasAsuhList();
            }
            function deleteSemester(index) {
                semesterData.splice(index, 1);
                renderSemesterList();
            }

            // --- FUNGSI PROFIL SISWA ---
            function getStudents() { return JSON.parse(localStorage.getItem('students')) || []; }
            function saveStudents(students) { localStorage.setItem('students', JSON.stringify(students)); }
            function renderStudentTable() {
                const students = getStudents();
                const container = document.getElementById('studentListContainer');
                container.innerHTML = '';

                if (students.length === 0) {
                    container.innerHTML = '<div class="text-center p-6 text-slate-500 bg-slate-800/50 rounded-lg shadow-sm border border-slate-700">Belum ada data siswa.</div>';
                    return;
                }

                // Mengelompokkan siswa berdasarkan kelas
                const studentsByClass = students.reduce((acc, student) => {
                    const className = student.kelas || 'Tanpa Kelas';
                    if (!acc[className]) {
                        acc[className] = [];
                    }
                    acc[className].push(student);
                    return acc;
                }, {});

                // Mengurutkan nama kelas secara alfabetis
                const sortedClasses = Object.keys(studentsByClass).sort();

                sortedClasses.forEach(className => {
                    const classStudents = studentsByClass[className].sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa));
                    const contentId = `class-content-${className.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const classWrapper = document.createElement('div');
                    classWrapper.className = 'bg-slate-800/50 rounded-lg shadow-sm border border-slate-700 overflow-hidden';
                    
                    classWrapper.innerHTML = `
                        <button class="w-full flex justify-between items-center p-4 text-left hover:bg-slate-700/50 transition-colors" data-toggle-collapse="${contentId}">
                            <span class="font-semibold text-slate-200">${className}</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-medium bg-slate-600 text-slate-300 rounded-full px-2 py-0.5">${classStudents.length} siswa</span>
                                <svg class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </button>
                    `;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.id = contentId;
                    contentDiv.className = 'p-4 pt-0 hidden';

                    let tableRows = '';
                    classStudents.forEach(student => {
                        tableRows += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-3 font-medium text-slate-200">${student.namaSiswa}</td><td class="px-6 py-3">${student.nisn || '-'}</td><td class="px-6 py-3 text-center whitespace-nowrap"><button class="detail-student-btn font-medium text-sky-400 hover:underline mr-3" data-id="${student.id}">Detail</button><button class="edit-student-btn font-medium text-amber-400 hover:underline mr-3" data-id="${student.id}">Edit</button><button class="delete-student-btn font-medium text-rose-400 hover:underline" data-id="${student.id}">Hapus</button></td></tr>`;
                    });

                    contentDiv.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50 font-medium"><tr><th scope="col" class="px-6 py-3">Nama Siswa</th><th scope="col" class="px-6 py-3">NISN</th><th scope="col" class="px-6 py-3 text-center">Aksi</th></tr></thead>
                                <tbody class="divide-y divide-slate-700">${tableRows}</tbody>
                            </table>
                        </div>
                    `;
                    
                    classWrapper.appendChild(contentDiv);
                    container.appendChild(classWrapper);
                });

                // Menambahkan event listener untuk semua tombol collapse
                container.querySelectorAll('[data-toggle-collapse]').forEach(button => {
                    button.addEventListener('click', () => {
                        const content = document.getElementById(button.dataset.toggleCollapse);
                        const icon = button.querySelector('svg');
                        content.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                    });
                });
            }
            function handleStudentFormSubmit(e) {
                e.preventDefault();
                const studentId = document.getElementById('studentId').value;
                const studentData = {namaSiswa: document.getElementById('namaSiswa').value, nisn: document.getElementById('nisn').value, kelas: document.getElementById('kelas').value, jenisKelamin: document.getElementById('jenisKelamin').value, namaAyah: document.getElementById('namaAyah').value, namaIbu: document.getElementById('namaIbu').value, alamatSiswa: document.getElementById('alamatSiswa').value, hpAyah: document.getElementById('hpAyah').value, hpIbu: document.getElementById('hpIbu').value, hpSiswa: document.getElementById('hpSiswa').value, statusAnak: document.getElementById('statusAnak').value};
                let students = getStudents();
                if (studentId) {
                    const index = students.findIndex(s => s.id == studentId);
                    if (index !== -1) {
                        students[index] = { ...students[index], ...studentData, id: parseInt(studentId) };
                        showNotification('Data siswa berhasil diperbarui!');
                    }
                } else {
                    studentData.id = Date.now();
                    students.push(studentData);
                    showNotification('Siswa baru berhasil ditambahkan!');
                }
                saveStudents(students);
                renderStudentTable();
                resetStudentForm();
                renderDashboard();
            }
            function resetStudentForm() {
                document.getElementById('studentProfileForm').reset();
                document.getElementById('studentId').value = '';
                document.getElementById('studentFormTitle').textContent = 'Tambah Siswa Baru';
                document.getElementById('saveStudentButton').textContent = 'Simpan Siswa';
                document.getElementById('cancelEditButton').classList.add('hidden');
            }
            function editStudent(studentId) {
                const student = getStudents().find(s => s.id == studentId);
                if (student) {
                    for (const key in student) { if (document.getElementById(key)) document.getElementById(key).value = student[key]; }
                    document.getElementById('studentId').value = student.id;
                    document.getElementById('studentFormTitle').textContent = 'Edit Data Siswa';
                    document.getElementById('saveStudentButton').textContent = 'Update Data';
                    document.getElementById('cancelEditButton').classList.remove('hidden');
                    // No scroll to top to keep context
                }
            }
            function showStudentDetail(studentId) {
                const student = getStudents().find(s => s.id == studentId);
                if (!student) return;
                const content = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-2xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Profil Siswa</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                        <div><strong class="font-medium text-slate-400">Nama Lengkap:</strong> <p class="text-slate-200 mt-1">${student.namaSiswa || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">NISN:</strong> <p class="text-slate-200 mt-1">${student.nisn || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Kelas:</strong> <p class="text-slate-200 mt-1">${student.kelas || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Jenis Kelamin:</strong> <p class="text-slate-200 mt-1">${student.jenisKelamin || '-'}</p></div>
                        <div class="md:col-span-2"><strong class="font-medium text-slate-400">Alamat:</strong> <p class="text-slate-200 mt-1">${student.alamatSiswa || '-'}</p></div>
                        <hr class="md:col-span-2 my-2 border-slate-700">
                        <div><strong class="font-medium text-slate-400">Nama Ayah:</strong> <p class="text-slate-200 mt-1">${student.namaAyah || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">No. HP Ayah:</strong> <p class="text-slate-200 mt-1">${student.hpAyah || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Nama Ibu:</strong> <p class="text-slate-200 mt-1">${student.namaIbu || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">No. HP Ibu:</strong> <p class="text-slate-200 mt-1">${student.hpIbu || '-'}</p></div>
                        <hr class="md:col-span-2 my-2 border-slate-700">
                        <div><strong class="font-medium text-slate-400">No. HP Siswa:</strong> <p class="text-slate-200 mt-1">${student.hpSiswa || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Status dalam Keluarga:</strong> <p class="text-slate-200 mt-1">${student.statusAnak || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button id="printStudentDetailPdfButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm">Ekspor PDF</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('studentDetailModal', content);
                document.getElementById('printStudentDetailPdfButton').addEventListener('click', () => exportStudentDetailToPDF(studentId));
            }
            
            // --- FUNGSI KONSELING INDIVIDU ---
            function getCounselingSessions() { return JSON.parse(localStorage.getItem('counselingSessions')) || []; }
            function saveCounselingSessions(sessions) { localStorage.setItem('counselingSessions', JSON.stringify(sessions)); }
            function toggleCounselingView(showForm) {
                document.getElementById('counselingForm').classList.toggle('hidden', !showForm);
                document.getElementById('counselingDisplay').classList.toggle('hidden', showForm);
            }
            function populateCounselingStudentDropdown() {
                const students = getStudents();
                const selectEl = document.getElementById('counseling_studentId');
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">Pilih Siswa</option>';
                students.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)).forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = `${s.namaSiswa} - ${s.kelas}`;
                    selectEl.appendChild(option);
                });
                selectEl.value = currentVal;
            }
            function renderCounselingTable() {
                const sessions = getCounselingSessions();
                const students = getStudents();
                const tableBody = document.getElementById('counselingTableBody');
                tableBody.innerHTML = '';
                if (sessions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Belum ada data konseling.</td></tr>';
                    return;
                }
                sessions.forEach(session => {
                    const student = students.find(s => s.id == session.studentId) || { namaSiswa: 'Siswa Dihapus' };
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${session.tanggal || ''}</td><td class="px-6 py-4 font-medium text-slate-200">${student.namaSiswa}</td><td class="px-6 py-4 truncate max-w-xs">${session.identifikasiMasalah || ''}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-amber-200/20 text-amber-300">${session.statusKonseling || ''}</span></td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-counseling-btn font-medium text-sky-400 hover:underline mr-3" data-id="${session.id}">Detail</button><button class="edit-counseling-btn font-medium text-amber-400 hover:underline mr-3" data-id="${session.id}">Edit</button><button class="delete-counseling-btn font-medium text-rose-400 hover:underline" data-id="${session.id}">Hapus</button></td></tr>`;
                });
            }
            function resetCounselingForm() {
                document.getElementById('counselingForm').reset();
                document.getElementById('counselingId').value = '';
                document.getElementById('counselingFormTitle').textContent = 'Formulir Konseling Individu';
                document.getElementById('counseling_studentClass').value = '';
                populateAllSemesterDropdowns();
            }
            function handleCounselingFormSubmit(e) {
                e.preventDefault();
                const counselingId = document.getElementById('counselingId').value;
                const form = document.getElementById('counselingForm');
                const sessionData = {};
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id.startsWith('counseling_')) {
                        sessionData[el.id.replace('counseling_', '')] = el.value;
                    }
                });
                let sessions = getCounselingSessions();
                if (counselingId) {
                    const index = sessions.findIndex(s => s.id == counselingId);
                    if (index !== -1) {
                        sessions[index] = { ...sessions[index], ...sessionData, id: parseInt(counselingId) };
                        showNotification('Sesi konseling berhasil diperbarui!');
                    }
                } else {
                    sessionData.id = Date.now();
                    sessions.push(sessionData);
                    showNotification('Sesi konseling baru berhasil ditambahkan!');
                }
                saveCounselingSessions(sessions);
                renderCounselingTable();
                toggleCounselingView(false);
                renderDashboard();
            }
            function editCounseling(sessionId) {
                const session = getCounselingSessions().find(s => s.id == sessionId);
                if (session) {
                    for (const key in session) {
                        const el = document.getElementById(`counseling_${key}`);
                        if (el) el.value = session[key];
                    }
                    document.getElementById('counselingId').value = session.id;
                    document.getElementById('counselingFormTitle').textContent = 'Edit Sesi Konseling';
                    document.getElementById('counseling_studentId').dispatchEvent(new Event('change'));
                    toggleCounselingView(true);
                }
            }
            function showCounselingDetail(sessionId) {
                const session = getCounselingSessions().find(s => s.id == sessionId);
                if (!session) return;
                const student = getStudents().find(s => s.id == session.studentId) || { namaSiswa: 'Siswa Dihapus', kelas: '-'};
                const content = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Sesi Konseling</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="md:col-span-2"><strong class="font-medium text-slate-400">Nama Siswa:</strong><p class="text-slate-200 mt-1">${student.namaSiswa}</p></div>
                        <div><strong class="font-medium text-slate-400">Kelas:</strong><p class="text-slate-200 mt-1">${student.kelas}</p></div>
                        <div><strong class="font-medium text-slate-400">Tanggal:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(session.tanggal) || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Konseling Ke-:</strong><p class="text-slate-200 mt-1">${session.ke || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Semester:</strong><p class="text-slate-200 mt-1">${session.semester || '-'}</p></div>
                        <div class="md:col-span-3"><hr class="my-2 border-slate-700"></div>
                        <div class="md:col-span-3"><strong class="font-medium text-slate-400">Identifikasi Masalah:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.identifikasiMasalah || '-'}</p></div>
                        <div class="md:col-span-3"><strong class="font-medium text-slate-400">Penjelasan Masalah:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.penjelasanMasalah || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Pendekatan:</strong><p class="text-slate-200 mt-1">${session.pendekatan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Teknik:</strong><p class="text-slate-200 mt-1">${session.teknik || '-'}</p></div>
                         <div><strong class="font-medium text-slate-400">Aspek Layanan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.aspekLayanan || '-'}</p></div>
                        <div class="md:col-span-3"><hr class="my-2 border-slate-700"></div>
                        <div class="md:col-span-3"><strong class="font-medium text-slate-400">Alternatif Pemecahan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.alternatif || '-'}</p></div>
                        <div class="md:col-span-3"><strong class="font-medium text-slate-400">Hasil:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.hasil || '-'}</p></div>
                        <div class="md:col-span-3"><hr class="my-2 border-slate-700"></div>
                        <div><strong class="font-medium text-slate-400">Komponen Layanan:</strong><p class="text-slate-200 mt-1">${session.komponenLayanan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Bidang Bimbingan:</strong><p class="text-slate-200 mt-1">${session.bidangBimbingan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Status Konseling:</strong><p class="text-slate-200 mt-1">${session.statusKonseling || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button id="exportPdfBtn" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm">Ekspor PDF</button>
                        <button id="exportExcelBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold text-sm">Ekspor Excel</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('counselingDetailModal', content);
                document.getElementById('exportPdfBtn').addEventListener('click', () => exportCounselingToPDF(sessionId));
                document.getElementById('exportExcelBtn').addEventListener('click', () => exportCounselingToExcel(sessionId));
            }

            // --- FUNGSI KONSULTASI ---
            function getConsultations() { return JSON.parse(localStorage.getItem('consultations')) || []; }
            function saveConsultations(consultations) { localStorage.setItem('consultations', JSON.stringify(consultations)); }
            function toggleConsultationView(showForm) {
                document.getElementById('consultationForm').classList.toggle('hidden', !showForm);
                document.getElementById('consultationDisplay').classList.toggle('hidden', showForm);
            }
             function renderConsultationTable() {
                const consultations = getConsultations();
                const tableBody = document.getElementById('consultationTableBody');
                tableBody.innerHTML = '';
                if (consultations.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-slate-500">Belum ada data konsultasi.</td></tr>';
                    return;
                }
                consultations.forEach(item => {
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${item.tanggal || ''}</td><td class="px-6 py-4 font-medium text-slate-200">${item.namaKonsulti}</td><td class="px-6 py-4 truncate max-w-xs">${item.uraianTopik || ''}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-consultation-btn font-medium text-sky-400 hover:underline mr-3" data-id="${item.id}">Detail</button><button class="edit-consultation-btn font-medium text-amber-400 hover:underline mr-3" data-id="${item.id}">Edit</button><button class="delete-consultation-btn font-medium text-rose-400 hover:underline" data-id="${item.id}">Hapus</button></td></tr>`;
                });
            }
            function resetConsultationForm() {
                document.getElementById('consultationForm').reset();
                document.getElementById('consultationId').value = '';
                document.getElementById('consultationFormTitle').textContent = 'Formulir Konsultasi';
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                document.getElementById('consultation_namaKonsultan').value = schoolProfile.namaGuruBk || '';
            }
            function handleConsultationFormSubmit(e) {
                e.preventDefault();
                const consultationId = document.getElementById('consultationId').value;
                const form = document.getElementById('consultationForm');
                const consultationData = {};
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id.startsWith('consultation_')) {
                        consultationData[el.id.replace('consultation_', '')] = el.value;
                    }
                });
                let consultations = getConsultations();
                if (consultationId) {
                    const index = consultations.findIndex(c => c.id == consultationId);
                    if (index !== -1) {
                        consultations[index] = { ...consultations[index], ...consultationData, id: parseInt(consultationId) };
                        showNotification('Sesi konsultasi berhasil diperbarui!');
                    }
                } else {
                    consultationData.id = Date.now();
                    consultations.push(consultationData);
                    showNotification('Sesi konsultasi baru berhasil ditambahkan!');
                }
                saveConsultations(consultations);
                renderConsultationTable();
                toggleConsultationView(false);
                renderDashboard();
            }
            function editConsultation(consultationId) {
                const consultation = getConsultations().find(c => c.id == consultationId);
                if (consultation) {
                    for (const key in consultation) {
                        const el = document.getElementById(`consultation_${key}`);
                        if (el) el.value = consultation[key];
                    }
                    document.getElementById('consultationId').value = consultation.id;
                    document.getElementById('consultationFormTitle').textContent = 'Edit Sesi Konsultasi';
                    toggleConsultationView(true);
                }
            }
            function showConsultationDetail(consultationId) {
                const consultation = getConsultations().find(c => c.id == consultationId);
                if (!consultation) return;
                const content = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Sesi Konsultasi</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div><strong class="font-medium text-slate-400">Nama Konsulti:</strong><p class="text-slate-200 mt-1">${consultation.namaKonsulti || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Status Konsulti:</strong><p class="text-slate-200 mt-1">${consultation.statusKonsulti || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Nama Konsultan:</strong><p class="text-slate-200 mt-1">${consultation.namaKonsultan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Hari / Tanggal:</strong><p class="text-slate-200 mt-1">${consultation.hari || ''}, ${formatDateIndonesian(consultation.tanggal) || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Durasi:</strong><p class="text-slate-200 mt-1">${consultation.durasiKonsultasi || '-'}</p></div>
                        <div class="md:col-span-2"><hr class="my-2 border-slate-700"></div>
                        <div class="md:col-span-2"><strong class="font-medium text-slate-400">Uraian Topik:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${consultation.uraianTopik || '-'}</p></div>
                        <div class="md:col-span-2"><strong class="font-medium text-slate-400">Hasil Konsultasi:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${consultation.hasilKonsultasi || '-'}</p></div>
                        <div class="md:col-span-2"><strong class="font-medium text-slate-400">Follow Up:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${consultation.followUp || '-'}</p></div>
                         <div class="md:col-span-2"><hr class="my-2 border-slate-700"></div>
                        <div><strong class="font-medium text-slate-400">Komponen Layanan:</strong><p class="text-slate-200 mt-1">${consultation.komponenLayanan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Bidang Bimbingan:</strong><p class="text-slate-200 mt-1">${consultation.bidangBimbingan || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button id="exportConsultationPdfBtn" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm">Ekspor PDF</button>
                        <button id="exportConsultationExcelBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold text-sm">Ekspor Excel</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('consultationDetailModal', content);
                document.getElementById('exportConsultationPdfBtn').addEventListener('click', () => exportConsultationToPDF(consultationId));
                document.getElementById('exportConsultationExcelBtn').addEventListener('click', () => exportConsultationToExcel(consultationId));
            }
            
            // --- FUNGSI LAYANAN KLASIKAL ---
            function getClassicalServices() { return JSON.parse(localStorage.getItem('classicalServices')) || []; }
            function saveClassicalServices(services) { localStorage.setItem('classicalServices', JSON.stringify(services)); }
            function toggleClassicalServiceView(showForm) {
                document.getElementById('classicalServiceForm').classList.toggle('hidden', !showForm);
                document.getElementById('classicalServiceDisplay').classList.toggle('hidden', showForm);
            }
            function renderClassicalServiceTable() {
                const services = getClassicalServices();
                const tableBody = document.getElementById('classicalServiceTableBody');
                tableBody.innerHTML = '';
                if (services.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-slate-500">Belum ada data layanan klasikal.</td></tr>';
                    return;
                }
                services.forEach(item => {
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${item.tanggal || ''}</td><td class="px-6 py-4 font-medium text-slate-200 truncate max-w-xs">${item.topik}</td><td class="px-6 py-4">${item.sasaran || ''}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-classical-btn font-medium text-sky-400 hover:underline mr-3" data-id="${item.id}">Detail</button><button class="edit-classical-btn font-medium text-amber-400 hover:underline mr-3" data-id="${item.id}">Edit</button><button class="delete-classical-btn font-medium text-rose-400 hover:underline" data-id="${item.id}">Hapus</button></td></tr>`;
                });
            }
            function resetClassicalServiceForm() {
                document.getElementById('classicalServiceForm').reset();
                document.getElementById('classicalId').value = '';
                document.getElementById('classicalServiceFormTitle').textContent = 'Formulir Layanan Klasikal';
                populateAllSemesterDropdowns();
            }
            function handleClassicalServiceFormSubmit(e) {
                e.preventDefault();
                const classicalId = document.getElementById('classicalId').value;
                const form = document.getElementById('classicalServiceForm');
                const serviceData = {};
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id.startsWith('classical_')) {
                        serviceData[el.id.replace('classical_', '')] = el.value;
                    }
                });
                let services = getClassicalServices();
                if (classicalId) {
                    const index = services.findIndex(c => c.id == classicalId);
                    if (index !== -1) {
                        services[index] = { ...services[index], ...serviceData, id: parseInt(classicalId) };
                        showNotification('Layanan klasikal berhasil diperbarui!');
                    }
                } else {
                    serviceData.id = Date.now();
                    services.push(serviceData);
                    showNotification('Layanan klasikal baru berhasil ditambahkan!');
                }
                saveClassicalServices(services);
                renderClassicalServiceTable();
                toggleClassicalServiceView(false);
                renderDashboard();
            }
            function editClassicalService(serviceId) {
                const service = getClassicalServices().find(s => s.id == serviceId);
                if (service) {
                    for (const key in service) {
                        const el = document.getElementById(`classical_${key}`);
                        if (el) el.value = service[key];
                    }
                    document.getElementById('classicalId').value = service.id;
                    document.getElementById('classicalServiceFormTitle').textContent = 'Edit Layanan Klasikal';
                    toggleClassicalServiceView(true);
                }
            }
            function showClassicalServiceDetail(serviceId) {
                const service = getClassicalServices().find(s => s.id == serviceId);
                if (!service) return;
                const content = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Layanan Klasikal</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong class="font-medium text-slate-400">Tanggal:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(service.tanggal) || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Semester:</strong><p class="text-slate-200 mt-1">${service.semester || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Sasaran:</strong><p class="text-slate-200 mt-1">${service.sasaran || '-'}</p></div>
                        </div>
                        <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Topik Layanan:</strong><p class="text-slate-200 mt-1">${service.topik || '-'}</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong class="font-medium text-slate-400">Bidang Layanan:</strong><p class="text-slate-200 mt-1">${service.bidangLayanan || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Metode:</strong><p class="text-slate-200 mt-1">${service.metode || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Media/Sumber:</strong><p class="text-slate-200 mt-1">${service.media || '-'}</p></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Tujuan Layanan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${service.tujuan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Aspek Layanan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${service.aspekLayanan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Capaian Layanan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${service.capaian || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Evaluasi & Tindak Lanjut:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${service.evaluasi || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Dokumentasi:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${service.dokumentasi || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button id="exportClassicalPdfBtn" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm">Ekspor PDF</button>
                        <button id="exportClassicalExcelBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold text-sm">Ekspor Excel</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('classicalServiceDetailModal', content);
                document.getElementById('exportClassicalPdfBtn').addEventListener('click', () => exportClassicalServiceToPDF(serviceId));
                document.getElementById('exportClassicalExcelBtn').addEventListener('click', () => exportClassicalServiceToExcel(serviceId));
            }

            // --- FUNGSI BIMBINGAN KELOMPOK ---
            function getGroupGuidanceSessions() { return JSON.parse(localStorage.getItem('groupGuidanceSessions')) || []; }
            function saveGroupGuidanceSessions(sessions) { localStorage.setItem('groupGuidanceSessions', JSON.stringify(sessions)); }
            function toggleGroupGuidanceView(showForm) {
                document.getElementById('groupGuidanceForm').classList.toggle('hidden', !showForm);
                document.getElementById('groupGuidanceDisplay').classList.toggle('hidden', showForm);
                if (showForm) resetGroupGuidanceForm();
            }
             function populateGroupGuidanceStudentDropdown() {
                const students = getStudents();
                const selectEl = document.getElementById('group_guidance_studentSelector');
                selectEl.innerHTML = '<option value="">Pilih Siswa...</option>';
                students.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)).forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = `${s.namaSiswa} - ${s.kelas}`;
                    selectEl.appendChild(option);
                });
            }
             function renderSelectedStudentsForGuidance() {
                const listContainer = document.getElementById('group_guidance_studentList');
                listContainer.innerHTML = '';
                if (selectedStudentsForGuidance.length === 0) {
                    listContainer.innerHTML = '<p class="text-xs text-slate-500">Belum ada siswa yang ditambahkan.</p>';
                    return;
                }
                selectedStudentsForGuidance.forEach((student, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-slate-700 p-2 rounded-md text-sm';
                    div.innerHTML = `<span>${student.namaSiswa} (${student.kelas})</span><button type="button" class="remove-guidance-student-btn font-bold text-rose-400 hover:text-rose-300" data-index="${index}">&times;</button>`;
                    listContainer.appendChild(div);
                });
            }
            function renderGroupGuidanceTable() {
                const sessions = getGroupGuidanceSessions();
                const tableBody = document.getElementById('groupGuidanceTableBody');
                tableBody.innerHTML = '';
                if (sessions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-slate-500">Belum ada data bimbingan kelompok.</td></tr>';
                    return;
                }
                sessions.forEach(item => {
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${item.tanggal || ''}</td><td class="px-6 py-4">${item.students.length} Siswa</td><td class="px-6 py-4 font-medium text-slate-200 truncate max-w-xs">${item.aspekLayanan}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-group-guidance-btn font-medium text-sky-400 hover:underline mr-3" data-id="${item.id}">Detail</button><button class="edit-group-guidance-btn font-medium text-amber-400 hover:underline mr-3" data-id="${item.id}">Edit</button><button class="delete-group-guidance-btn font-medium text-rose-400 hover:underline" data-id="${item.id}">Hapus</button></td></tr>`;
                });
            }
            function resetGroupGuidanceForm() {
                document.getElementById('groupGuidanceForm').reset();
                document.getElementById('groupGuidanceId').value = '';
                document.getElementById('groupGuidanceFormTitle').textContent = 'Formulir Bimbingan Kelompok';
                populateAllSemesterDropdowns();
                selectedStudentsForGuidance = [];
                renderSelectedStudentsForGuidance();
            }
            function handleGroupGuidanceFormSubmit(e) {
                e.preventDefault();
                if (selectedStudentsForGuidance.length === 0) {
                    showNotification('Harap tambahkan setidaknya satu siswa.', true);
                    return;
                }
                const guidanceId = document.getElementById('groupGuidanceId').value;
                const form = document.getElementById('groupGuidanceForm');
                const sessionData = { students: selectedStudentsForGuidance };
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id.startsWith('group_guidance_') && !el.id.includes('studentSelector')) {
                        sessionData[el.id.replace('group_guidance_', '')] = el.value;
                    }
                });
                let sessions = getGroupGuidanceSessions();
                if (guidanceId) {
                    const index = sessions.findIndex(c => c.id == guidanceId);
                    if (index !== -1) {
                        sessions[index] = { ...sessions[index], ...sessionData, id: parseInt(guidanceId) };
                        showNotification('Bimbingan kelompok berhasil diperbarui!');
                    }
                } else {
                    sessionData.id = Date.now();
                    sessions.push(sessionData);
                    showNotification('Bimbingan kelompok baru berhasil ditambahkan!');
                }
                saveGroupGuidanceSessions(sessions);
                renderGroupGuidanceTable();
                toggleGroupGuidanceView(false);
                renderDashboard();
            }
            function editGroupGuidance(sessionId) {
                const session = getGroupGuidanceSessions().find(s => s.id == sessionId);
                if (session) {
                    for (const key in session) {
                        if (key !== 'students') {
                            const el = document.getElementById(`group_guidance_${key}`);
                            if (el) el.value = session[key];
                        }
                    }
                    document.getElementById('groupGuidanceId').value = session.id;
                    document.getElementById('groupGuidanceFormTitle').textContent = 'Edit Bimbingan Kelompok';
                    selectedStudentsForGuidance = [...session.students];
                    renderSelectedStudentsForGuidance();
                    toggleGroupGuidanceView(true);
                }
            }
            function showGroupGuidanceDetail(sessionId) {
                const session = getGroupGuidanceSessions().find(s => s.id == sessionId);
                if (!session) return;
                let studentListHtml = session.students.map(s => `<li>${s.namaSiswa} (${s.kelas})</li>`).join('');

                const content = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Bimbingan Kelompok</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong class="font-medium text-slate-400">Tanggal:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(session.tanggal) || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Semester:</strong><p class="text-slate-200 mt-1">${session.semester || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Durasi:</strong><p class="text-slate-200 mt-1">${session.durasi || '-'}</p></div>
                        </div>
                        <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Anggota Kelompok (${session.students.length} siswa):</strong><ul class="list-disc list-inside text-slate-200 mt-1">${studentListHtml}</ul></div>
                        <hr class="border-slate-700"/>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong class="font-medium text-slate-400">Komponen:</strong><p class="text-slate-200 mt-1">${session.komponenLayanan || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Bidang:</strong><p class="text-slate-200 mt-1">${session.bidangBimbingan || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Aspek:</strong><p class="text-slate-200 mt-1">${session.aspekLayanan || '-'}</p></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Tujuan Layanan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.tujuanLayanan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Eksperientasi (Awal):</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.eksperientasi || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Identifikasi (Tahap Dua):</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.identifikasi || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Analisis (Tahap Tiga):</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.analisis || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Generalisasi (Penutup):</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.generalisasi || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button id="exportGroupGuidancePdfBtn" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm">Ekspor PDF</button>
                        <button id="exportGroupGuidanceExcelBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold text-sm">Ekspor Excel</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('groupGuidanceDetailModal', content);
                document.getElementById('exportGroupGuidancePdfBtn').addEventListener('click', () => exportGroupGuidanceToPDF(sessionId));
                document.getElementById('exportGroupGuidanceExcelBtn').addEventListener('click', () => exportGroupGuidanceToExcel(sessionId));
            }

            // --- FUNGSI KONSELING KELOMPOK ---
            function getGroupCounselingSessions() { return JSON.parse(localStorage.getItem('groupCounselingSessions')) || []; }
            function saveGroupCounselingSessions(sessions) { localStorage.setItem('groupCounselingSessions', JSON.stringify(sessions)); }
            function toggleGroupCounselingView(showForm) {
                document.getElementById('groupCounselingForm').classList.toggle('hidden', !showForm);
                document.getElementById('groupCounselingDisplay').classList.toggle('hidden', showForm);
                if (showForm) resetGroupCounselingForm();
            }
             function populateGroupCounselingStudentDropdown() {
                const students = getStudents();
                const selectEl = document.getElementById('group_counseling_studentSelector');
                selectEl.innerHTML = '<option value="">Pilih Siswa...</option>';
                students.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)).forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = `${s.namaSiswa} - ${s.kelas}`;
                    selectEl.appendChild(option);
                });
            }
            function renderSelectedStudentsForCounseling() {
                const listContainer = document.getElementById('group_counseling_studentList');
                listContainer.innerHTML = '';
                if (selectedStudentsForCounseling.length === 0) {
                    listContainer.innerHTML = '<p class="text-xs text-slate-500">Belum ada siswa yang ditambahkan.</p>';
                    return;
                }
                selectedStudentsForCounseling.forEach((student, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-slate-700 p-2 rounded-md text-sm';
                    div.innerHTML = `<span>${student.namaSiswa} (${student.kelas})</span><button type="button" class="remove-counseling-student-btn font-bold text-rose-400 hover:text-rose-300" data-index="${index}">&times;</button>`;
                    listContainer.appendChild(div);
                });
            }
            function renderGroupCounselingTable() {
                const sessions = getGroupCounselingSessions();
                const tableBody = document.getElementById('groupCounselingTableBody');
                tableBody.innerHTML = '';
                if (sessions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Belum ada data konseling kelompok.</td></tr>';
                    return;
                }
                sessions.forEach(item => {
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${item.tanggal || ''}</td><td class="px-6 py-4">${item.students.length} Siswa</td><td class="px-6 py-4 font-medium text-slate-200 truncate max-w-xs">${item.identifikasiMasalah}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-amber-200/20 text-amber-300">${item.status || ''}</span></td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-group-counseling-btn font-medium text-sky-400 hover:underline mr-3" data-id="${item.id}">Detail</button><button class="edit-group-counseling-btn font-medium text-amber-400 hover:underline mr-3" data-id="${item.id}">Edit</button><button class="delete-group-counseling-btn font-medium text-rose-400 hover:underline" data-id="${item.id}">Hapus</button></td></tr>`;
                });
            }
            function resetGroupCounselingForm() {
                document.getElementById('groupCounselingForm').reset();
                document.getElementById('groupCounselingId').value = '';
                document.getElementById('groupCounselingFormTitle').textContent = 'Formulir Konseling Kelompok';
                populateAllSemesterDropdowns();
                selectedStudentsForCounseling = [];
                renderSelectedStudentsForCounseling();
            }
            function handleGroupCounselingFormSubmit(e) {
                e.preventDefault();
                if (selectedStudentsForCounseling.length === 0) {
                    showNotification('Harap tambahkan setidaknya satu siswa.', true);
                    return;
                }
                const counselingId = document.getElementById('groupCounselingId').value;
                const form = document.getElementById('groupCounselingForm');
                const sessionData = { students: selectedStudentsForCounseling };
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id.startsWith('group_counseling_') && !el.id.includes('studentSelector')) {
                        sessionData[el.id.replace('group_counseling_', '')] = el.value;
                    }
                });
                let sessions = getGroupCounselingSessions();
                if (counselingId) {
                    const index = sessions.findIndex(c => c.id == counselingId);
                    if (index !== -1) {
                        sessions[index] = { ...sessions[index], ...sessionData, id: parseInt(counselingId) };
                        showNotification('Konseling kelompok berhasil diperbarui!');
                    }
                } else {
                    sessionData.id = Date.now();
                    sessions.push(sessionData);
                    showNotification('Konseling kelompok baru berhasil ditambahkan!');
                }
                saveGroupCounselingSessions(sessions);
                renderGroupCounselingTable();
                toggleGroupCounselingView(false);
                renderDashboard();
            }
             function editGroupCounseling(sessionId) {
                const session = getGroupCounselingSessions().find(s => s.id == sessionId);
                if (session) {
                    for (const key in session) {
                        if (key !== 'students') {
                            const el = document.getElementById(`group_counseling_${key}`);
                            if (el) el.value = session[key];
                        }
                    }
                    document.getElementById('groupCounselingId').value = session.id;
                    document.getElementById('groupCounselingFormTitle').textContent = 'Edit Konseling Kelompok';
                    selectedStudentsForCounseling = [...session.students];
                    renderSelectedStudentsForCounseling();
                    toggleGroupCounselingView(true);
                }
            }
            function showGroupCounselingDetail(sessionId) {
                const session = getGroupCounselingSessions().find(s => s.id == sessionId);
                if (!session) return;
                let studentListHtml = session.students.map(s => `<li>${s.namaSiswa} (${s.kelas})</li>`).join('');

                const content = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Konseling Kelompok</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong class="font-medium text-slate-400">Tanggal:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(session.tanggal) || '-'}</p></div>
                             <div><strong class="font-medium text-slate-400">Semester:</strong><p class="text-slate-200 mt-1">${session.semester || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Durasi:</strong><p class="text-slate-200 mt-1">${session.durasi || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Tempat:</strong><p class="text-slate-200 mt-1">${session.tempat || '-'}</p></div>
                        </div>
                        <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Anggota Kelompok (${session.students.length} siswa):</strong><ul class="list-disc list-inside text-slate-200 mt-1">${studentListHtml}</ul></div>
                        <hr class="border-slate-700"/>
                         <div><strong class="font-medium text-slate-400">Identifikasi Masalah:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.identifikasiMasalah || '-'}</p></div>
                         <div><strong class="font-medium text-slate-400">Penyebab Masalah:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.penyebabMasalah || '-'}</p></div>
                         <div><strong class="font-medium text-slate-400">Alternatif Pemecahan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.alternatif || '-'}</p></div>
                         <div><strong class="font-medium text-slate-400">Hasil:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${session.hasil || '-'}</p></div>
                         <hr class="border-slate-700"/>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><strong class="font-medium text-slate-400">Pendekatan:</strong><p class="text-slate-200 mt-1">${session.pendekatan || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Teknik:</strong><p class="text-slate-200 mt-1">${session.teknik || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Aspek:</strong><p class="text-slate-200 mt-1">${session.aspekLayanan || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Komponen:</strong><p class="text-slate-200 mt-1">${session.komponenLayanan || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Bidang:</strong><p class="text-slate-200 mt-1">${session.bidangLayanan || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Status:</strong><p class="text-slate-200 mt-1">${session.status || '-'}</p></div>
                        </div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button id="exportGroupCounselingPdfBtn" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm">Ekspor PDF</button>
                        <button id="exportGroupCounselingExcelBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold text-sm">Ekspor Excel</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('groupCounselingDetailModal', content);
                document.getElementById('exportGroupCounselingPdfBtn').addEventListener('click', () => exportGroupCounselingToPDF(sessionId));
                document.getElementById('exportGroupCounselingExcelBtn').addEventListener('click', () => exportGroupCounselingToExcel(sessionId));
            }
            
            // --- FUNGSI JURNAL ---
            function getJournals() { return JSON.parse(localStorage.getItem('journals')) || []; }
            function saveJournals(journals) { localStorage.setItem('journals', JSON.stringify(journals)); }
            function toggleJournalView(showForm) {
                document.getElementById('journalForm').classList.toggle('hidden', !showForm);
                document.getElementById('journalDisplay').classList.toggle('hidden', showForm);
            }
            function renderJournalTable() {
                const journals = getJournals();
                const tableBody = document.getElementById('journalTableBody');
                tableBody.innerHTML = '';
                if (journals.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-slate-500">Belum ada catatan jurnal.</td></tr>';
                    return;
                }
                journals.forEach(item => {
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${item.tanggal || ''}</td><td class="px-6 py-4 font-medium text-slate-200 truncate max-w-xs">${item.kegiatan}</td><td class="px-6 py-4 truncate max-w-xs">${item.tindakLanjut || ''}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-journal-btn font-medium text-sky-400 hover:underline mr-3" data-id="${item.id}">Detail</button><button class="edit-journal-btn font-medium text-amber-400 hover:underline mr-3" data-id="${item.id}">Edit</button><button class="delete-journal-btn font-medium text-rose-400 hover:underline" data-id="${item.id}">Hapus</button></td></tr>`;
                });
            }
            function resetJournalForm() {
                document.getElementById('journalForm').reset();
                document.getElementById('journalId').value = '';
                document.getElementById('journalFormTitle').textContent = 'Formulir Jurnal Kegiatan';
                populateAllSemesterDropdowns();
            }
            function handleJournalFormSubmit(e) {
                e.preventDefault();
                const journalId = document.getElementById('journalId').value;
                const form = document.getElementById('journalForm');
                const journalData = {};
                form.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id.startsWith('journal_')) {
                        journalData[el.id.replace('journal_', '')] = el.value;
                    }
                });
                let journals = getJournals();
                if (journalId) {
                    const index = journals.findIndex(j => j.id == journalId);
                    if (index !== -1) {
                        journals[index] = { ...journals[index], ...journalData, id: parseInt(journalId) };
                        showNotification('Catatan jurnal berhasil diperbarui!');
                    }
                } else {
                    journalData.id = Date.now();
                    journals.push(journalData);
                    showNotification('Catatan jurnal baru berhasil ditambahkan!');
                }
                saveJournals(journals);
                renderJournalTable();
                toggleJournalView(false);
                renderDashboard();
            }
            function editJournal(journalId) {
                const journal = getJournals().find(j => j.id == journalId);
                if (journal) {
                    for (const key in journal) {
                        const el = document.getElementById(`journal_${key}`);
                        if (el) el.value = journal[key];
                    }
                    document.getElementById('journalId').value = journal.id;
                    document.getElementById('journalFormTitle').textContent = 'Edit Catatan Jurnal';
                    toggleJournalView(true);
                }
            }
            function showJournalDetail(journalId) {
                const journal = getJournals().find(j => j.id == journalId);
                if (!journal) return;
                const content = `
                <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Jurnal Kegiatan</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><strong class="font-medium text-slate-400">Tanggal:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(journal.tanggal) || '-'}</p></div>
                            <div><strong class="font-medium text-slate-400">Semester:</strong><p class="text-slate-200 mt-1">${journal.semester || '-'}</p></div>
                        </div>
                        <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Uraian Kegiatan / Materi Layanan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${journal.kegiatan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Catatan Kejadian:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${journal.catatan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Tindak Lanjut:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${journal.tindakLanjut || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Keterangan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${journal.keterangan || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button id="exportJournalPdfBtn" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm">Ekspor PDF</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('journalDetailModal', content);
                document.getElementById('exportJournalPdfBtn').addEventListener('click', () => exportJournalToPDF(journalId));
            }
             function exportJournalListToPDF() {
                const { jsPDF } = window.jspdf;
                const journals = getJournals();
                if (journals.length === 0) {
                    showNotification('Tidak ada data untuk dicetak.', true);
                    return;
                }
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI JURNAL KEGIATAN HARIAN', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = journals.map((s, index) => [
                    index + 1,
                    s.tanggal || '',
                    s.kegiatan || '',
                    s.catatan || '',
                    s.tindakLanjut || '',
                    s.keterangan || ''
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tanggal', 'Uraian Kegiatan', 'Catatan Kejadian', 'Tindak Lanjut', 'Keterangan']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 20;
                if(doc.internal.pageSize.height < signY + 30) { doc.addPage(); signY = 20; }
                const signX = doc.internal.pageSize.width - 70;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, signX, signY, { align: 'center' });
                doc.text(`Guru BK,`, signX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signX, signY, { align: 'center' });
                
                doc.save('Rekap_Jurnal_Harian.pdf');
            }

            // --- FUNGSI SURAT KELUAR/MASUK ---
            function getOutgoingMail() { return JSON.parse(localStorage.getItem('outgoingMail')) || []; }
            function saveOutgoingMail(mails) { localStorage.setItem('outgoingMail', JSON.stringify(mails)); }
            function getIncomingMail() { return JSON.parse(localStorage.getItem('incomingMail')) || []; }
            function saveIncomingMail(mails) { localStorage.setItem('incomingMail', JSON.stringify(mails)); }
            function getHomeVisits() { return JSON.parse(localStorage.getItem('homeVisits')) || []; }
            function saveHomeVisits(visits) { localStorage.setItem('homeVisits', JSON.stringify(visits)); }
            function getBehaviorContracts() { return JSON.parse(localStorage.getItem('behaviorContracts')) || []; }
            function saveBehaviorContracts(contracts) { localStorage.setItem('behaviorContracts', JSON.stringify(contracts)); }
            function getStudentPermitsOut() { return JSON.parse(localStorage.getItem('studentPermitsOut')) || []; } 
            function saveStudentPermitsOut(permits) { localStorage.setItem('studentPermitsOut', JSON.stringify(permits)); } 
            function toggleMailOutView(showForm) { document.getElementById('mailOutForm').classList.toggle('hidden', !showForm); document.getElementById('mailOutDisplay').classList.toggle('hidden', showForm); }
            function toggleMailInView(showForm) { document.getElementById('mailInForm').classList.toggle('hidden', !showForm); document.getElementById('mailInDisplay').classList.toggle('hidden', showForm); }
            function toggleHomeVisitView(showForm) { document.getElementById('homeVisitForm').classList.toggle('hidden', !showForm); document.getElementById('homeVisitDisplay').classList.toggle('hidden', showForm); }
            function toggleBehaviorContractView(showForm) { document.getElementById('behaviorContractForm').classList.toggle('hidden', !showForm); document.getElementById('behaviorContractDisplay').classList.toggle('hidden', showForm); }
            function toggleStudentPermitOutView(showForm) { document.getElementById('studentPermitOutForm').classList.toggle('hidden', !showForm); document.getElementById('studentPermitOutDisplay').classList.toggle('hidden', showForm); } 

            function renderMailOutTable() {
                const mails = getOutgoingMail();
                const students = getStudents();
                const tableBody = document.getElementById('mailOutTableBody');
                tableBody.innerHTML = '';
                if (mails.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Belum ada data surat keluar.</td></tr>'; return; }
                mails.forEach(mail => {
                    const student = students.find(s => s.id == mail.studentId) || { namaSiswa: 'Siswa Dihapus' };
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${mail.tanggalSurat || ''}</td><td class="px-6 py-4">${mail.nomorSurat || ''}</td><td class="px-6 py-4 font-medium text-slate-200">${student.namaSiswa}</td><td class="px-6 py-4">${mail.perihal || ''}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-mailOut-btn font-medium text-sky-400 hover:underline mr-3" data-id="${mail.id}">Detail</button><button class="edit-mailOut-btn font-medium text-amber-400 hover:underline mr-3" data-id="${mail.id}">Edit</button><button class="delete-mailOut-btn font-medium text-rose-400 hover:underline" data-id="${mail.id}">Hapus</button></td></tr>`;
                });
            }
             function renderMailInTable() {
                const mails = getIncomingMail();
                const tableBody = document.getElementById('mailInTableBody');
                tableBody.innerHTML = '';
                if (mails.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-slate-500">Belum ada data surat masuk.</td></tr>'; return; }
                mails.forEach(mail => {
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${mail.tanggalSurat || ''}</td><td class="px-6 py-4">${mail.nomorSurat || ''}</td><td class="px-6 py-4 font-medium text-slate-200">${mail.perihal || ''}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-mailIn-btn font-medium text-sky-400 hover:underline mr-3" data-id="${mail.id}">Detail</button><button class="edit-mailIn-btn font-medium text-amber-400 hover:underline mr-3" data-id="${mail.id}">Edit</button><button class="delete-mailIn-btn font-medium text-rose-400 hover:underline" data-id="${mail.id}">Hapus</button></td></tr>`;
                });
            }
            function renderHomeVisitTable() {
                const visits = getHomeVisits();
                const students = getStudents();
                const tableBody = document.getElementById('homeVisitTableBody');
                tableBody.innerHTML = '';
                if (visits.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-slate-500">Belum ada data kunjungan rumah.</td></tr>'; return; }
                visits.forEach(visit => {
                    const student = students.find(s => s.id == visit.studentId) || { namaSiswa: 'Siswa Dihapus' };
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${visit.tanggal || ''}</td><td class="px-6 py-4 font-medium text-slate-200">${student.namaSiswa}</td><td class="px-6 py-4">${visit.petugas || ''}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-homeVisit-btn font-medium text-sky-400 hover:underline mr-3" data-id="${visit.id}">Detail</button><button class="edit-homeVisit-btn font-medium text-amber-400 hover:underline mr-3" data-id="${visit.id}">Edit</button><button class="delete-homeVisit-btn font-medium text-rose-400 hover:underline" data-id="${visit.id}">Hapus</button></td></tr>`;
                });
            }
            function renderBehaviorContractTable() {
                const contracts = getBehaviorContracts();
                const students = getStudents();
                const tableBody = document.getElementById('behaviorContractTableBody');
                tableBody.innerHTML = '';
                if (contracts.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Belum ada data kontrak perilaku.</td></tr>'; return; }
                contracts.forEach(contract => {
                    const student = students.find(s => s.id == contract.studentId) || { namaSiswa: 'Siswa Dihapus' };
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${contract.tanggal || ''}</td><td class="px-6 py-4 font-medium text-slate-200">${student.namaSiswa}</td><td class="px-6 py-4 truncate max-w-xs">${contract.deskripsiPerilaku || ''}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-amber-200/20 text-amber-300">${contract.status || ''}</span></td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-behaviorContract-btn font-medium text-sky-400 hover:underline mr-3" data-id="${contract.id}">Detail</button><button class="edit-behaviorContract-btn font-medium text-amber-400 hover:underline mr-3" data-id="${contract.id}">Edit</button><button class="delete-behaviorContract-btn font-medium text-rose-400 hover:underline" data-id="${contract.id}">Hapus</button></td></tr>`;
                });
            }
            function renderStudentPermitOutTable() {
                const permits = getStudentPermitsOut();
                const students = getStudents();
                const tableBody = document.getElementById('studentPermitOutTableBody');
                tableBody.innerHTML = '';
                if (permits.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-slate-500">Belum ada data surat izin.</td></tr>'; return; }
                permits.forEach(permit => {
                    const student = students.find(s => s.id == permit.studentId) || { namaSiswa: 'Siswa Dihapus' };
                    tableBody.innerHTML += `<tr class="hover:bg-slate-700/50"><td class="px-6 py-4">${permit.tanggalIzin || ''}</td><td class="px-6 py-4 font-medium text-slate-200">${student.namaSiswa}</td><td class="px-6 py-4 truncate max-w-xs">${permit.alasan || ''}</td><td class="px-6 py-4 text-center whitespace-nowrap"><button class="detail-studentPermitOut-btn font-medium text-sky-400 hover:underline mr-3" data-id="${permit.id}">Detail</button><button class="edit-studentPermitOut-btn font-medium text-amber-400 hover:underline mr-3" data-id="${permit.id}">Edit</button><button class="delete-studentPermitOut-btn font-medium text-rose-400 hover:underline" data-id="${permit.id}">Hapus</button></td></tr>`;
                });
            }
            function populateMailOutStudentDropdown() {
                const students = getStudents();
                const selectEl = document.getElementById('mailOut_studentId');
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">Pilih Siswa...</option>';
                students.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)).forEach(s => {
                    selectEl.innerHTML += `<option value="${s.id}">${s.namaSiswa} - ${s.kelas}</option>`;
                });
                selectEl.value = currentVal;
            }
            function populateStudentPermitOutStudentDropdown() {
                const students = getStudents();
                const selectEl = document.getElementById('studentPermitOut_studentId');
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">Pilih Siswa...</option>';
                students.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)).forEach(s => {
                    selectEl.innerHTML += `<option value="${s.id}">${s.namaSiswa} - ${s.kelas}</option>`;
                });
                selectEl.value = currentVal;
            }
            function resetMailOutForm() { document.getElementById('mailOutForm').reset(); document.getElementById('mailOutId').value = ''; document.getElementById('mailOutFormTitle').textContent = 'Formulir Surat Keluar (Panggilan)'; }
            function resetMailInForm() { document.getElementById('mailInForm').reset(); document.getElementById('mailInId').value = ''; document.getElementById('mailInFormTitle').textContent = 'Formulir Surat Masuk'; }
            function resetHomeVisitForm() { 
                document.getElementById('homeVisitForm').reset(); 
                document.getElementById('homeVisitId').value = ''; 
                document.getElementById('homeVisitFormTitle').textContent = 'Formulir Laporan Kunjungan Rumah'; 
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                document.getElementById('homeVisit_petugas').value = schoolProfile.namaGuruBk || '';
            }
            function resetBehaviorContractForm() { 
                document.getElementById('behaviorContractForm').reset(); 
                document.getElementById('behaviorContractId').value = ''; 
                document.getElementById('behaviorContractFormTitle').textContent = 'Formulir Kontrak Perilaku Siswa'; 
            }
            function resetStudentPermitOutForm() { 
                document.getElementById('studentPermitOutForm').reset(); 
                document.getElementById('studentPermitOutId').value = ''; 
                document.getElementById('studentPermitOutFormTitle').textContent = 'Formulir Surat Izin Keluar Siswa'; 
            }

            function handleMailOutFormSubmit(e) {
                e.preventDefault();
                const mailId = document.getElementById('mailOutId').value;
                const mailData = {};
                document.getElementById('mailOutForm').querySelectorAll('[id^="mailOut_"]').forEach(el => { mailData[el.id.replace('mailOut_', '')] = el.value; });
                let mails = getOutgoingMail();
                if (mailId) {
                    const index = mails.findIndex(m => m.id == mailId);
                    if (index !== -1) { mails[index] = { ...mails[index], ...mailData, id: parseInt(mailId) }; showNotification('Surat keluar berhasil diperbarui!'); }
                } else { mailData.id = Date.now(); mails.push(mailData); showNotification('Surat keluar berhasil disimpan!'); }
                saveOutgoingMail(mails); renderMailOutTable(); toggleMailOutView(false); renderDashboard();
            }
            function handleMailInFormSubmit(e) {
                e.preventDefault();
                const mailId = document.getElementById('mailInId').value;
                const mailData = {};
                document.getElementById('mailInForm').querySelectorAll('[id^="mailIn_"]').forEach(el => { mailData[el.id.replace('mailIn_', '')] = el.value; });
                let mails = getIncomingMail();
                if (mailId) {
                    const index = mails.findIndex(m => m.id == mailId);
                    if (index !== -1) { mails[index] = { ...mails[index], ...mailData, id: parseInt(mailId) }; showNotification('Surat masuk berhasil diperbarui!'); }
                } else { mailData.id = Date.now(); mails.push(mailData); showNotification('Surat masuk berhasil disimpan!'); }
                saveIncomingMail(mails); renderMailInTable(); toggleMailInView(false); renderDashboard();
            }
            function handleHomeVisitFormSubmit(e) {
                e.preventDefault();
                const visitId = document.getElementById('homeVisitId').value;
                const visitData = {};
                document.getElementById('homeVisitForm').querySelectorAll('[id^="homeVisit_"]').forEach(el => { visitData[el.id.replace('homeVisit_', '')] = el.value; });
                let visits = getHomeVisits();
                if (visitId) {
                    const index = visits.findIndex(v => v.id == visitId);
                    if (index !== -1) { visits[index] = { ...visits[index], ...visitData, id: parseInt(visitId) }; showNotification('Laporan kunjungan berhasil diperbarui!'); }
                } else { visitData.id = Date.now(); visits.push(visitData); showNotification('Laporan kunjungan berhasil disimpan!'); }
                saveHomeVisits(visits); renderHomeVisitTable(); toggleHomeVisitView(false); renderDashboard();
            }
            function handleBehaviorContractFormSubmit(e) {
                e.preventDefault();
                const contractId = document.getElementById('behaviorContractId').value;
                const contractData = {};
                document.getElementById('behaviorContractForm').querySelectorAll('[id^="behaviorContract_"]').forEach(el => { contractData[el.id.replace('behaviorContract_', '')] = el.value; });
                let contracts = getBehaviorContracts();
                if (contractId) {
                    const index = contracts.findIndex(v => v.id == contractId);
                    if (index !== -1) { contracts[index] = { ...contracts[index], ...contractData, id: parseInt(contractId) }; showNotification('Kontrak perilaku berhasil diperbarui!'); }
                } else { contractData.id = Date.now(); contracts.push(contractData); showNotification('Kontrak perilaku berhasil disimpan!'); }
                saveBehaviorContracts(contracts); renderBehaviorContractTable(); toggleBehaviorContractView(false); renderDashboard();
            }
            function handleStudentPermitOutFormSubmit(e) {
                e.preventDefault();
                const permitId = document.getElementById('studentPermitOutId').value;
                const permitData = {};
                document.getElementById('studentPermitOutForm').querySelectorAll('[id^="studentPermitOut_"]').forEach(el => { permitData[el.id.replace('studentPermitOut_', '')] = el.value; });
                let permits = getStudentPermitsOut();
                if (permitId) {
                    const index = permits.findIndex(v => v.id == permitId);
                    if (index !== -1) { permits[index] = { ...permits[index], ...permitData, id: parseInt(permitId) }; showNotification('Surat izin berhasil diperbarui!'); }
                } else { permitData.id = Date.now(); permits.push(permitData); showNotification('Surat izin berhasil disimpan!'); }
                saveStudentPermitsOut(permits); renderStudentPermitOutTable(); toggleStudentPermitOutView(false); renderDashboard();
            }
            function editMailOut(mailId) {
                const mail = getOutgoingMail().find(m => m.id == mailId);
                if (mail) {
                    for (const key in mail) { const el = document.getElementById(`mailOut_${key}`); if (el) el.value = mail[key]; }
                    document.getElementById('mailOutId').value = mail.id;
                    document.getElementById('mailOutFormTitle').textContent = 'Edit Surat Keluar';
                    toggleMailOutView(true);
                }
            }
             function editMailIn(mailId) {
                const mail = getIncomingMail().find(m => m.id == mailId);
                if (mail) {
                    for (const key in mail) { const el = document.getElementById(`mailIn_${key}`); if (el) el.value = mail[key]; }
                    document.getElementById('mailInId').value = mail.id;
                    document.getElementById('mailInFormTitle').textContent = 'Edit Surat Masuk';
                    toggleMailInView(true);
                }
            }
            function editHomeVisit(visitId) {
                const visit = getHomeVisits().find(v => v.id == visitId);
                if (visit) {
                    for (const key in visit) { const el = document.getElementById(`homeVisit_${key}`); if (el) el.value = visit[key]; }
                    document.getElementById('homeVisitId').value = visit.id;
                    document.getElementById('homeVisitFormTitle').textContent = 'Edit Laporan Kunjungan Rumah';
                    toggleHomeVisitView(true);
                }
            }
            function editBehaviorContract(contractId) {
                const contract = getBehaviorContracts().find(v => v.id == contractId);
                if (contract) {
                    for (const key in contract) { const el = document.getElementById(`behaviorContract_${key}`); if (el) el.value = contract[key]; }
                    document.getElementById('behaviorContractId').value = contract.id;
                    document.getElementById('behaviorContractFormTitle').textContent = 'Edit Kontrak Perilaku Siswa';
                    toggleBehaviorContractView(true);
                }
            }
            function editStudentPermitOut(permitId) {
                const permit = getStudentPermitsOut().find(v => v.id == permitId);
                if (permit) {
                    for (const key in permit) { const el = document.getElementById(`studentPermitOut_${key}`); if (el) el.value = permit[key]; }
                    document.getElementById('studentPermitOutId').value = permit.id;
                    document.getElementById('studentPermitOutFormTitle').textContent = 'Edit Surat Izin Keluar Siswa';
                    document.getElementById('studentPermitOut_studentId').dispatchEvent(new Event('change'));
                    toggleStudentPermitOutView(true);
                }
            }
            function showMailOutDetail(mailId) {
                const mail = getOutgoingMail().find(m => m.id == mailId);
                if(!mail) return;
                const student = getStudents().find(s => s.id == mail.studentId) || {};
                const content = `<div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Surat Keluar</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                           <div><strong class="font-medium text-slate-400">No. Surat:</strong><p class="text-slate-200 mt-1">${mail.nomorSurat || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Lampiran:</strong><p class="text-slate-200 mt-1">${mail.lampiran || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Tgl Surat:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(mail.tanggalSurat) || '-'}</p></div>
                        </div>
                        <div><strong class="font-medium text-slate-400">Perihal:</strong><p class="text-slate-200 mt-1">${mail.perihal || '-'}</p></div>
                        <hr class="border-slate-700"/>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                           <div><strong class="font-medium text-slate-400">Nama Siswa:</strong><p class="text-slate-200 mt-1">${student.namaSiswa || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">NISN:</strong><p class="text-slate-200 mt-1">${student.nisn || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Kelas:</strong><p class="text-slate-200 mt-1">${student.kelas || '-'}</p></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                           <div><strong class="font-medium text-slate-400">Panggilan Ke-:</strong><p class="text-slate-200 mt-1">${mail.panggilanKe || '-'}</p></div>
                           <div class="md:col-span-2"><strong class="font-medium text-slate-400">Waktu Pertemuan:</strong><p class="text-slate-200 mt-1">${mail.hariTanggalPertemuan || ''}, Pukul ${mail.waktuPertemuan || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Tempat:</strong><p class="text-slate-200 mt-1">${mail.tempatPertemuan || '-'}</p></div>
                        </div>
                        <div><strong class="font-medium text-slate-400">Alasan Pemanggilan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${mail.alasanPemanggilan || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button class="export-pdf-btn px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm" data-id="${mailId}" data-type="mailOut">Ekspor PDF</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('mailOutDetailModal', content);
                document.querySelector('#mailOutDetailModal .export-pdf-btn').addEventListener('click', () => exportMailOutToPDF(mailId));
            }
            function showMailInDetail(mailId) {
                const mail = getIncomingMail().find(m => m.id == mailId);
                if(!mail) return;
                const content = `<div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-2xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Surat Masuk</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div><strong class="font-medium text-slate-400">No. Surat:</strong><p class="text-slate-200 mt-1">${mail.nomorSurat || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Tgl Surat:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(mail.tanggalSurat) || '-'}</p></div>
                        </div>
                        <div><strong class="font-medium text-slate-400">Perihal:</strong><p class="text-slate-200 mt-1">${mail.perihal || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Keterangan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${mail.keterangan || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700">
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('mailInDetailModal', content);
            }
            function showHomeVisitDetail(visitId) {
                const visit = getHomeVisits().find(v => v.id == visitId);
                if(!visit) return;
                const student = getStudents().find(s => s.id == visit.studentId) || {};
                const content = `<div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Kunjungan Rumah</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div><strong class="font-medium text-slate-400">No. Surat Tugas:</strong><p class="text-slate-200 mt-1">${visit.nomorSurat || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Tgl Kunjungan:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(visit.tanggal) || '-'}</p></div>
                        </div>
                        <hr class="border-slate-700"/>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                           <div><strong class="font-medium text-slate-400">Nama Siswa:</strong><p class="text-slate-200 mt-1">${student.namaSiswa || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">NISN:</strong><p class="text-slate-200 mt-1">${student.nisn || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Kelas:</strong><p class="text-slate-200 mt-1">${student.kelas || '-'}</p></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div><strong class="font-medium text-slate-400">Petugas:</strong><p class="text-slate-200 mt-1">${visit.petugas || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Waktu:</strong><p class="text-slate-200 mt-1">${visit.waktu || '-'}</p></div>
                        </div>
                        <div><strong class="font-medium text-slate-400">Uraian Hasil Kunjungan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${visit.hasil || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Tindak Lanjut:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${visit.tindakLanjut || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button class="export-pdf-btn px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm" data-id="${visitId}">Ekspor PDF</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('homeVisitDetailModal', content);
                document.querySelector('#homeVisitDetailModal .export-pdf-btn').addEventListener('click', () => exportHomeVisitToPDF(visitId));
            }
            function showBehaviorContractDetail(contractId) {
                const contract = getBehaviorContracts().find(v => v.id == contractId);
                if(!contract) return;
                const student = getStudents().find(s => s.id == contract.studentId) || {};
                const content = `<div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Kontrak Perilaku</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div><strong class="font-medium text-slate-400">Nama Siswa:</strong><p class="text-slate-200 mt-1">${student.namaSiswa || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Kelas:</strong><p class="text-slate-200 mt-1">${student.kelas || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Tgl Kontrak:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(contract.tanggal) || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Tgl Tinjauan:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(contract.tanggalTinjauan) || '-'}</p></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Perilaku yang Akan Diubah:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${contract.deskripsiPerilaku || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Tujuan Perubahan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${contract.tujuanPerubahan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Rencana Tindakan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${contract.rencanaTindakan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Konsekuensi:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${contract.konsekuensi || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Status:</strong><p class="text-slate-200 mt-1">${contract.status || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button class="export-pdf-btn px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm" data-id="${contractId}">Ekspor PDF</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('behaviorContractDetailModal', content);
                document.querySelector('#behaviorContractDetailModal .export-pdf-btn').addEventListener('click', () => exportBehaviorContractToPDF(contractId));
            }
            function showStudentPermitOutDetail(permitId) {
                const permit = getStudentPermitsOut().find(v => v.id == permitId);
                if(!permit) return;
                const student = getStudents().find(s => s.id == permit.studentId) || {};
                const content = `<div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-3xl mx-auto w-full border border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-700">
                        <h3 class="text-xl font-bold text-slate-100">Detail Surat Izin Keluar Siswa</h3>
                        <button class="close-modal-btn text-slate-400 hover:text-white text-3xl">&times;</button>
                    </div>
                    <div class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div><strong class="font-medium text-slate-400">Nama Siswa:</strong><p class="text-slate-200 mt-1">${student.namaSiswa || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Kelas:</strong><p class="text-slate-200 mt-1">${student.kelas || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Tgl Izin:</strong><p class="text-slate-200 mt-1">${formatDateIndonesian(permit.tanggalIzin) || '-'}</p></div>
                           <div><strong class="font-medium text-slate-400">Durasi:</strong><p class="text-slate-200 mt-1">${permit.durasi || '-'}</p></div>
                        </div>
                         <hr class="border-slate-700"/>
                        <div><strong class="font-medium text-slate-400">Alasan Izin:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${permit.alasan || '-'}</p></div>
                        <div><strong class="font-medium text-slate-400">Keterangan Tambahan:</strong><p class="text-slate-200 mt-1 whitespace-pre-wrap">${permit.keterangan || '-'}</p></div>
                    </div>
                    <div class="flex justify-end mt-8 pt-4 border-t border-slate-700 items-center space-x-3">
                        <button class="export-pdf-btn px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold text-sm" data-id="${permitId}">Ekspor PDF</button>
                        <button class="close-modal-btn px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500 font-medium text-sm">Tutup</button>
                    </div>
                </div>`;
                showModal('studentPermitOutDetailModal', content);
                document.querySelector('#studentPermitOutDetailModal .export-pdf-btn').addEventListener('click', () => exportStudentPermitOutToPDF(permitId));
            }
            function populateHomeVisitStudentDropdown() {
                const students = getStudents();
                const selectEl = document.getElementById('homeVisit_studentId');
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">Pilih Siswa...</option>';
                students.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)).forEach(s => {
                    selectEl.innerHTML += `<option value="${s.id}">${s.namaSiswa} - ${s.kelas}</option>`;
                });
                selectEl.value = currentVal;
            }

            function populateBehaviorContractStudentDropdown() {
                const students = getStudents();
                const selectEl = document.getElementById('behaviorContract_studentId');
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">Pilih Siswa...</option>';
                students.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)).forEach(s => {
                    selectEl.innerHTML += `<option value="${s.id}">${s.namaSiswa} - ${s.kelas}</option>`;
                });
                selectEl.value = currentVal;
            }

            // --- FUNGSI EKSPOR PDF & EXCEL LAINNYA ---
            function drawPdfHeader(doc, schoolProfile) {
                const logoKiri = localStorage.getItem('schoolLogoLeft');
                const logoKanan = localStorage.getItem('schoolLogoRight');
                const pageWidth = doc.internal.pageSize.width;
                let yPos = 15;

                if (logoKiri) doc.addImage(logoKiri, 'PNG', 15, 10, 20, 20);
                if (logoKanan) doc.addImage(logoKanan, 'PNG', pageWidth - 35, 10, 20, 20);

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                const provKotaText = (schoolProfile.provinsiKota || 'PEMERINTAH PROVINSI/KOTA').toUpperCase();
                doc.text(provKotaText, pageWidth / 2, yPos, { align: 'center' });
                yPos += 6;
                
                doc.setFontSize(14);
                doc.text(schoolProfile.dinas || 'DINAS PENDIDIKAN', pageWidth / 2, yPos, { align: 'center' });
                yPos += 7;
                doc.setFontSize(16);
                doc.text(schoolProfile.namaSekolah || 'NAMA SEKOLAH', pageWidth / 2, yPos, { align: 'center' });
                yPos += 6;
                doc.setFontSize(14);
                doc.text('BIMBINGAN DAN KONSELING', pageWidth / 2, yPos, { align: 'center' });
                yPos += 7;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(schoolProfile.alamatSekolah || 'Alamat Sekolah, Telp. (xxx) xxx-xxxx', pageWidth / 2, yPos, { align: 'center' });
                yPos += 5;
                doc.setLineWidth(1);
                doc.line(10, yPos, pageWidth - 10, yPos);
                
                return yPos + 10;
            }

            function exportCounselingToPDF(sessionId) {
                const { jsPDF } = window.jspdf;
                const session = getCounselingSessions().find(s => s.id == sessionId);
                if (!session) return;
                const student = getStudents().find(s => s.id == session.studentId) || {};
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};

                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN KONSELING INDIVIDU', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const data = [
                    ['Nama Siswa', student.namaSiswa || ''],
                    ['Kelas / Semester', `${student.kelas || ''} / ${session.semester || ''}`],
                    ['Tanggal Konseling', formatDateIndonesian(session.tanggal)],
                    ['Pertemuan Ke-', session.ke || ''],
                    ['Identifikasi Masalah', session.identifikasiMasalah || ''],
                    ['Penjelasan Masalah', session.penjelasanMasalah || ''],
                    ['Pendekatan / Teknik', `${session.pendekatan || ''} / ${session.teknik || ''}`],
                    ['Alternatif Pemecahan', session.alternatif || ''],
                    ['Hasil', session.hasil || ''],
                    ['Bidang / Komponen', `${session.bidangBimbingan || ''} / ${session.komponenLayanan || ''}`],
                    ['Status', session.statusKonseling || ''],
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [['Deskripsi', 'Keterangan']],
                    body: data,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] }, // slate-600
                    styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });

                let signY = doc.autoTable.previous.finalY + 15;
                const pageWidth = doc.internal.pageSize.width;
                const centerX = pageWidth / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(session.tanggal)}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });


                doc.save(`Konseling_${student.namaSiswa.replace(/\s+/g, '_')}.pdf`);
            }
            
            function exportToExcel(data, headers, filename) {
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan");
                XLSX.utils.sheet_add_aoa(worksheet, [headers], { origin: "A1" });
                XLSX.writeFile(workbook, `${filename}.xlsx`);
            }
            
            function exportCounselingToExcel(sessionId) {
                const session = getCounselingSessions().find(s => s.id == sessionId);
                if (!session) return;
                const student = getStudents().find(s => s.id == session.studentId) || {};
                const data = [{
                    "Nama Siswa": student.namaSiswa, "Kelas": student.kelas, "Tanggal": session.tanggal,
                    "Masalah": session.identifikasiMasalah, "Hasil": session.hasil, "Status": session.statusKonseling
                }];
                const headers = ["Nama Siswa", "Kelas", "Tanggal", "Masalah", "Hasil", "Status"];
                exportToExcel(data, headers, `Konseling_${student.namaSiswa}`);
            }
            function exportConsultationToPDF(consultationId) { 
                const { jsPDF } = window.jspdf;
                const consultation = getConsultations().find(c => c.id == consultationId);
                if (!consultation) return;
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};

                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN KONSULTASI', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const data = [
                    ['Nama Konsulti', consultation.namaKonsulti || ''],
                    ['Status Konsulti', consultation.statusKonsulti || ''],
                    ['Tanggal', formatDateIndonesian(consultation.tanggal)],
                    ['Durasi', consultation.durasiKonsultasi || ''],
                    ['Uraian Topik', consultation.uraianTopik || ''],
                    ['Hasil Konsultasi', consultation.hasilKonsultasi || ''],
                    ['Tindak Lanjut', consultation.followUp || '']
                ];
                doc.autoTable({
                    startY: yPos,
                    head: [['Deskripsi', 'Keterangan']],
                    body: data,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] }, // slate-600
                    styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });

                let signY = doc.autoTable.previous.finalY + 15;
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(consultation.tanggal)}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save(`Konsultasi_${consultation.namaKonsulti.replace(/\s+/g, '_')}.pdf`);
            }
            function exportConsultationToExcel(consultationId) {
                const item = getConsultations().find(c => c.id == consultationId);
                if (!item) return;
                const data = [{
                    "Tanggal": item.tanggal, "Nama Konsulti": item.namaKonsulti, "Status": item.statusKonsulti,
                    "Topik": item.uraianTopik, "Hasil": item.hasilKonsultasi, "Follow Up": item.followUp
                }];
                const headers = ["Tanggal", "Nama Konsulti", "Status", "Topik", "Hasil", "Follow Up"];
                exportToExcel(data, headers, `Konsultasi_${item.namaKonsulti}`);
            }
            function exportClassicalServiceToPDF(serviceId) {
                const { jsPDF } = window.jspdf;
                const service = getClassicalServices().find(s => s.id == serviceId);
                if (!service) return;
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};

                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN LAYANAN KLASIKAL', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const data = [
                    ['Tanggal', formatDateIndonesian(service.tanggal)],
                    ['Sasaran', service.sasaran || ''],
                    ['Topik', service.topik || ''],
                    ['Bidang Layanan', service.bidangLayanan || ''],
                    ['Tujuan', service.tujuan || ''],
                    ['Capaian', service.capaian || '']
                ];
                 doc.autoTable({
                    startY: yPos,
                    head: [['Deskripsi', 'Keterangan']],
                    body: data,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] }, // slate-600
                    styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });

                let signY = doc.autoTable.previous.finalY + 15;
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(service.tanggal)}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save(`Layanan_Klasikal_${service.sasaran.replace(/\s+/g, '_')}.pdf`);
            }
            function exportClassicalServiceToExcel(serviceId) {
                const item = getClassicalServices().find(s => s.id == serviceId);
                if (!item) return;
                const data = [{
                    "Tanggal": item.tanggal, "Sasaran": item.sasaran, "Topik": item.topik,
                    "Bidang": item.bidangLayanan, "Tujuan": item.tujuan, "Capaian": item.capaian
                }];
                const headers = ["Tanggal", "Sasaran", "Topik", "Bidang", "Tujuan", "Capaian"];
                exportToExcel(data, headers, `LayananKlasikal_${item.sasaran}`);
            }
            function exportGroupGuidanceToPDF(sessionId) { 
                const { jsPDF } = window.jspdf;
                const session = getGroupGuidanceSessions().find(s => s.id == sessionId);
                if (!session) return;
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};

                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN BIMBINGAN KELOMPOK', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Deskripsi', 'Keterangan']],
                    body: [
                        ['Tanggal', formatDateIndonesian(session.tanggal)],
                        ['Aspek Layanan', session.aspekLayanan || ''],
                        ['Tujuan Layanan', session.tujuanLayanan || '']
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] }, // slate-600
                    styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });
                yPos = doc.autoTable.previous.finalY + 10;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Nama Siswa', 'Kelas']],
                    body: session.students.map((s, i) => [i + 1, s.namaSiswa, s.kelas]),
                    theme: 'grid', styles: { fontSize: 10 },
                    headStyles: { fillColor: [71, 85, 105] } // slate-600
                });

                let signY = doc.autoTable.previous.finalY + 15;
                const centerX = doc.internal.pageSize.width / 2;
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(session.tanggal)}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save(`Bimbingan_Kelompok_${session.tanggal}.pdf`);
            }
            function exportGroupGuidanceToExcel(sessionId) {
                const item = getGroupGuidanceSessions().find(s => s.id == sessionId);
                if (!item) return;
                const students = item.students.map(s => s.namaSiswa).join(', ');
                const data = [{
                    "Tanggal": item.tanggal, "Aspek Layanan": item.aspekLayanan,
                    "Tujuan": item.tujuanLayanan, "Anggota": students
                }];
                const headers = ["Tanggal", "Aspek Layanan", "Tujuan", "Anggota"];
                exportToExcel(data, headers, `BimbinganKelompok_${item.tanggal}`);
            }
            function exportGroupCounselingToPDF(sessionId) {
                const { jsPDF } = window.jspdf;
                const session = getGroupCounselingSessions().find(s => s.id == sessionId);
                if (!session) return;
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};

                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN KONSELING KELOMPOK', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                doc.autoTable({
                    startY: yPos,
                    body: [
                        ['Tanggal', `: ${formatDateIndonesian(session.tanggal)}`],
                        ['Identifikasi Masalah', `: ${session.identifikasiMasalah || ''}`],
                        ['Hasil', `: ${session.hasil || ''}`],
                        ['Status', `: ${session.status || ''}`]
                    ],
                    theme: 'plain', styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold', cellWidth: 50 } }
                });
                yPos = doc.autoTable.previous.finalY + 10;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Nama Siswa', 'Kelas']],
                    body: session.students.map((s, i) => [i + 1, s.namaSiswa, s.kelas]),
                    theme: 'grid', styles: { fontSize: 10 },
                    headStyles: { fillColor: [71, 85, 105] }
                });

                let signY = doc.autoTable.previous.finalY + 15;
                const centerX = doc.internal.pageSize.width / 2;
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(session.tanggal)}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save(`Konseling_Kelompok_${session.tanggal}.pdf`);
            }
            function exportGroupCounselingToExcel(sessionId) {
                const item = getGroupCounselingSessions().find(s => s.id == sessionId);
                if (!item) return;
                const students = item.students.map(s => s.namaSiswa).join(', ');
                const data = [{
                    "Tanggal": item.tanggal, "Masalah": item.identifikasiMasalah, "Status": item.status,
                    "Hasil": item.hasil, "Anggota": students
                }];
                const headers = ["Tanggal", "Masalah", "Status", "Hasil", "Anggota"];
                exportToExcel(data, headers, `KonselingKelompok_${item.tanggal}`);
            }
            
            // --- FUNGSI BARU UNTUK PDF YANG ERROR ---

            function exportJournalToPDF(journalId) {
                const { jsPDF } = window.jspdf;
                const journal = getJournals().find(j => j.id == journalId);
                if (!journal) return;
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN JURNAL KEGIATAN HARIAN', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const data = [
                    ['Tanggal', `: ${formatDateIndonesian(journal.tanggal)}`],
                    ['Semester', `: ${journal.semester || '-'}`],
                    ['Uraian Kegiatan', `: ${journal.kegiatan || '-'}`],
                    ['Catatan Kejadian', `: ${journal.catatan || '-'}`],
                    ['Tindak Lanjut', `: ${journal.tindakLanjut || '-'}`],
                    ['Keterangan', `: ${journal.keterangan || '-'}`],
                ];

                doc.autoTable({
                    startY: yPos,
                    body: data,
                    theme: 'plain',
                    styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
                    columnStyles: { 0: { fontStyle: 'bold', cellWidth: 50 } }
                });

                let signY = doc.autoTable.previous.finalY + 20;
                if(doc.internal.pageSize.height < signY + 30) { doc.addPage(); signY = 20; }
                const signX = doc.internal.pageSize.width - 60;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(journal.tanggal)}`, signX, signY);
                doc.text(`Guru BK,`, signX, signY + 7); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signX, signY); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signX, signY);

                doc.save(`Jurnal_${journal.tanggal}.pdf`);
            }

            function exportMailOutToPDF(mailId) {
                const { jsPDF } = window.jspdf;
                const mail = getOutgoingMail().find(m => m.id == mailId);
                if(!mail) return;
                const student = getStudents().find(s => s.id == mail.studentId) || {};
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const pageWidth = doc.internal.pageSize.width;
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(mail.tanggalSurat)}`, pageWidth - 20, yPos, { align: 'right' });
                yPos += 10;

                doc.text(`Nomor      : ${mail.nomorSurat || '.........................'}`, 20, yPos);
                yPos += 5;
                doc.text(`Lampiran : ${mail.lampiran || '-'}`, 20, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'bold');
                doc.text(`Perihal      : ${mail.perihal || 'Panggilan Orang Tua/Wali'}`, 20, yPos);
                yPos += 10;
                doc.setFont('helvetica', 'normal');
                
                doc.text(`Kepada Yth.`, 20, yPos);
                yPos += 5;
                doc.text(`Bapak/Ibu Orang Tua/Wali dari siswa:`, 20, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'bold');
                doc.text(student.namaSiswa || '.........................', 30, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`di -`, 20, yPos);
                yPos += 5;
                doc.text(`       Tempat`, 20, yPos);
                yPos += 10;
                
                doc.text(`Dengan hormat,`, 20, yPos);
                yPos += 10;

                const bodyText = `Sehubungan dengan ${mail.alasanPemanggilan || 'permasalahan yang dialami oleh putra/putri Bapak/Ibu'}, kami mengharapkan kehadiran Bapak/Ibu di sekolah untuk dapat membicarakannya pada:`;
                const splitBody = doc.splitTextToSize(bodyText, pageWidth - 40);
                doc.text(splitBody, 20, yPos);
                yPos += (splitBody.length * 5) + 5;

                doc.text(`Hari/Tanggal`, 30, yPos); doc.text(`: ${mail.hariTanggalPertemuan || '.........................'}`, 70, yPos);
                yPos += 7;
                doc.text(`Waktu`, 30, yPos); doc.text(`: ${mail.waktuPertemuan || '.........................'}`, 70, yPos);
                yPos += 7;
                doc.text(`Tempat`, 30, yPos); doc.text(`: ${mail.tempatPertemuan || 'Ruang BK'}`, 70, yPos);
                yPos += 10;

                const closingText = `Mengingat pentingnya permasalahan ini, kami sangat mengharapkan kehadiran Bapak/Ibu tepat pada waktunya. Atas perhatian dan kerjasamanya, kami ucapkan terima kasih.`;
                const splitClosing = doc.splitTextToSize(closingText, pageWidth - 40);
                doc.text(splitClosing, 20, yPos);
                yPos += (splitClosing.length * 5) + 15;

                // --- Tanda Tangan (Tata Letak Diperbaiki) ---
                const signXLeft = 50; // Posisi untuk blok tanda tangan kiri
                const signXRight = pageWidth - 50; // Posisi untuk blok tanda tangan kanan
                let currentY = yPos;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                // Kolom Kiri: Wali Kelas
                doc.text('Wali Kelas,', signXLeft, currentY, { align: 'center' });

                // Kolom Kanan: Guru BK
                doc.text('Guru BK,', signXRight, currentY, { align: 'center' });
                
                currentY += 25; // Memberi spasi vertikal untuk area tanda tangan

                // Nama Wali Kelas (kiri)
                doc.setFont('helvetica', 'bold');
                doc.text(mail.namaWaliKelas || '(.......................................)', signXLeft, currentY, { align: 'center' });

                // Nama Guru BK (kanan)
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signXRight, currentY, { align: 'center' });
                currentY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signXRight, currentY, { align: 'center' });

                doc.save(`Surat_Panggilan_${student.namaSiswa}.pdf`);
            }

            function exportHomeVisitToPDF(visitId) {
                const { jsPDF } = window.jspdf;
                const visit = getHomeVisits().find(v => v.id == visitId);
                if (!visit) return;
                const student = getStudents().find(s => s.id == visit.studentId) || {};
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const kelasAsuhInfo = (schoolProfile.kelasAsuh || []).find(k => k.kelas === student.kelas) || {};

                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN KUNJUNGAN RUMAH (HOME VISIT)', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;

                const data = [
                    ['Tanggal Kunjungan', formatDateIndonesian(visit.tanggal)],
                    ['Waktu', visit.waktu || '-'],
                    ['Nama Siswa', student.namaSiswa || '-'],
                    ['Kelas', student.kelas || '-'],
                    ['Petugas Kunjungan', visit.petugas || '-'],
                    ['Uraian Hasil', visit.hasil || '-'],
                    ['Tindak Lanjut', visit.tindakLanjut || '-'],
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [['Aspek Kunjungan', 'Deskripsi']],
                    body: data,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] },
                    styles: { fontSize: 10, overflow: 'linebreak' },
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });
                
                let currentY = doc.autoTable.previous.finalY + 20;
                if(doc.internal.pageSize.height < currentY + 40) { doc.addPage(); currentY = 20; }
                
                const pageWidth = doc.internal.pageSize.width;
                const signXLeft = 50;
                const signXRight = pageWidth - 50;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                // Kolom Kiri: Wali Kelas
                doc.text('Mengetahui,', signXLeft, currentY, { align: 'center' });
                doc.text('Wali Kelas,', signXLeft, currentY + 5, { align: 'center' });

                // Kolom Kanan: Guru BK
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(visit.tanggal)}`, signXRight, currentY, { align: 'center' });
                doc.text('Guru BK,', signXRight, currentY + 5, { align: 'center' });
                
                currentY += 30; // Spasi untuk tanda tangan

                // Nama Wali Kelas (kiri)
                doc.setFont('helvetica', 'bold');
                doc.text(kelasAsuhInfo.wali || '(.......................................)', signXLeft, currentY, { align: 'center' });
                
                // Nama Guru BK (kanan)
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signXRight, currentY, { align: 'center' });
                currentY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signXRight, currentY, { align: 'center' });


                doc.save(`Kunjungan_Rumah_${student.namaSiswa}.pdf`);
            }

            function exportBehaviorContractToPDF(contractId) {
                const { jsPDF } = window.jspdf;
                const contract = getBehaviorContracts().find(v => v.id == contractId);
                if(!contract) return;
                const student = getStudents().find(s => s.id == contract.studentId) || {};
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('KONTRAK PERILAKU SISWA', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Pada hari ini, tanggal ${formatDateIndonesian(contract.tanggal)}, kami yang bertanda tangan di bawah ini:`, 20, yPos);
                yPos += 10;

                doc.text(`Nama Siswa`, 20, yPos); doc.text(`: ${student.namaSiswa || ''}`, 60, yPos); yPos += 7;
                doc.text(`Kelas`, 20, yPos); doc.text(`: ${student.kelas || ''}`, 60, yPos); yPos += 10;

                doc.text(`Dengan ini menyatakan setuju untuk membuat perjanjian dengan Guru BK terkait perubahan perilaku sebagai berikut:`, 20, yPos);
                yPos += 10;

                const contractData = [
                    ['Perilaku yang Akan Diubah', contract.deskripsiPerilaku || ''],
                    ['Tujuan Perubahan', contract.tujuanPerubahan || ''],
                    ['Rencana Tindakan Siswa', contract.rencanaTindakan || ''],
                    ['Konsekuensi', contract.konsekuensi || ''],
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Aspek', 'Deskripsi']],
                    body: contractData,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] },
                    styles: { fontSize: 10, overflow: 'linebreak' },
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });
                yPos = doc.autoTable.previous.finalY + 7;

                doc.text(`Kontrak ini berlaku hingga tanggal tinjauan pada ${formatDateIndonesian(contract.tanggalTinjauan)}.`, 20, yPos);
                yPos += 5;
                doc.text(`Demikian kontrak ini dibuat dengan kesadaran penuh dan tanpa paksaan dari pihak manapun.`, 20, yPos);
                yPos += 20;

                const pageWidth = doc.internal.pageSize.width;
                doc.text('Mengetahui,', (pageWidth/4), yPos, {align: 'center'});
                doc.text('Yang Membuat Perjanjian,', (pageWidth * 3/4), yPos, {align: 'center'});
                yPos += 5;
                doc.text('Guru BK', (pageWidth/4), yPos, {align: 'center'});
                doc.text('Siswa', (pageWidth * 3/4), yPos, {align: 'center'});
                yPos += 30;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', (pageWidth/4), yPos, {align: 'center'});
                doc.text(student.namaSiswa || '(.......................................)', (pageWidth * 3/4), yPos, {align: 'center'});
                yPos += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, (pageWidth/4), yPos, {align: 'center'});

                doc.save(`Kontrak_Perilaku_${student.namaSiswa}.pdf`);
            }
            
            function exportStudentPermitOutToPDF(permitId) {
                const { jsPDF } = window.jspdf;
                const permit = getStudentPermitsOut().find(v => v.id == permitId);
                if(!permit) return;
                const student = getStudents().find(s => s.id == permit.studentId) || {};
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('SURAT KETERANGAN IZIN', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const introText = 'Yang bertanda tangan di bawah ini, Guru Bimbingan dan Konseling menerangkan bahwa:';
                doc.text(introText, 20, yPos);
                yPos += 10;
                
                doc.text(`Nama`, 30, yPos); doc.text(`: ${student.namaSiswa || '.........................'}`, 70, yPos);
                yPos += 7;
                doc.text(`Kelas`, 30, yPos); doc.text(`: ${student.kelas || '.........................'}`, 70, yPos);
                yPos += 10;

                const bodyText = `Benar-benar siswa tersebut telah meminta izin untuk ${permit.alasan || 'keperluan tertentu'} selama ${permit.durasi || 'waktu tertentu'} pada tanggal ${formatDateIndonesian(permit.tanggalIzin)}.`;
                const splitBody = doc.splitTextToSize(bodyText, doc.internal.pageSize.width - 40);
                doc.text(splitBody, 20, yPos);
                yPos += (splitBody.length * 5) + 5;

                if (permit.keterangan) {
                    const keteranganText = `Keterangan: ${permit.keterangan}`;
                    const splitKeterangan = doc.splitTextToSize(keteranganText, doc.internal.pageSize.width - 40);
                    doc.text(splitKeterangan, 20, yPos);
                    yPos += (splitKeterangan.length * 5) + 5;
                }
                
                yPos += 5;
                const closingText = `Demikian surat keterangan ini dibuat untuk dipergunakan sebagaimana mestinya.`;
                doc.text(closingText, 20, yPos);
                yPos += 20;

                let signY = yPos;
                if(doc.internal.pageSize.height < signY + 30) { doc.addPage(); signY = 20; }
                const signX = doc.internal.pageSize.width - 60;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(permit.tanggalIzin)}`, signX, signY, {align: 'center'});
                doc.text(`Guru BK,`, signX, signY + 7, {align: 'center'}); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signX, signY, {align: 'center'}); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signX, signY, {align: 'center'});

                doc.save(`Surat_Izin_${student.namaSiswa}.pdf`);
            }

            function exportMailOutListToPDF() {
                const { jsPDF } = window.jspdf;
                const mails = getOutgoingMail();
                if (mails.length === 0) { showNotification('Tidak ada data untuk dicetak.', true); return; }
                const students = getStudents();
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF('l', 'mm', 'a4');
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI SURAT KELUAR', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = mails.map((mail, index) => {
                    const student = students.find(s => s.id == mail.studentId) || {};
                    return [index + 1, mail.tanggalSurat, mail.nomorSurat, student.namaSiswa, student.kelas, mail.perihal];
                });

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tgl Surat', 'No. Surat', 'Nama Siswa', 'Kelas', 'Perihal']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 20;
                if(doc.internal.pageSize.height < signY + 30) { doc.addPage(); signY = 20; }
                const signX = doc.internal.pageSize.width - 70;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, signX, signY, {align: 'center'});
                doc.text(`Guru BK,`, signX, signY + 7, {align: 'center'}); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signX, signY, {align: 'center'}); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signX, signY, {align: 'center'});
                
                doc.save('Rekap_Surat_Keluar.pdf');
            }

            function exportHomeVisitListToPDF() {
                const { jsPDF } = window.jspdf;
                const visits = getHomeVisits();
                if (visits.length === 0) { showNotification('Tidak ada data untuk dicetak.', true); return; }
                const students = getStudents();
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF('l', 'mm', 'a4');
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI KUNJUNGAN RUMAH', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = visits.map((visit, index) => {
                    const student = students.find(s => s.id == visit.studentId) || {};
                    return [index + 1, visit.tanggal, student.namaSiswa, student.kelas, visit.petugas, visit.hasil];
                });

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tgl Kunjungan', 'Nama Siswa', 'Kelas', 'Petugas', 'Uraian Hasil']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 20;
                if(doc.internal.pageSize.height < signY + 30) { doc.addPage(); signY = 20; }
                const signX = doc.internal.pageSize.width - 70;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, signX, signY, {align: 'center'});
                doc.text(`Guru BK,`, signX, signY + 7, {align: 'center'}); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signX, signY, {align: 'center'}); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signX, signY, {align: 'center'});
                
                doc.save('Rekap_Kunjungan_Rumah.pdf');
            }

            function exportBehaviorContractListToPDF() {
                const { jsPDF } = window.jspdf;
                const contracts = getBehaviorContracts();
                if (contracts.length === 0) { showNotification('Tidak ada data untuk dicetak.', true); return; }
                const students = getStudents();
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF('l', 'mm', 'a4');
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI KONTRAK PERILAKU', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = contracts.map((contract, index) => {
                    const student = students.find(s => s.id == contract.studentId) || {};
                    return [index + 1, contract.tanggal, student.namaSiswa, student.kelas, contract.deskripsiPerilaku, contract.status];
                });

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tgl Kontrak', 'Nama Siswa', 'Kelas', 'Perilaku yang Diubah', 'Status']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 20;
                if(doc.internal.pageSize.height < signY + 30) { doc.addPage(); signY = 20; }
                const signX = doc.internal.pageSize.width - 70;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, signX, signY, {align: 'center'});
                doc.text(`Guru BK,`, signX, signY + 7, {align: 'center'}); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signX, signY, {align: 'center'}); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signX, signY, {align: 'center'});
                
                doc.save('Rekap_Kontrak_Perilaku.pdf');
            }

            function exportStudentPermitOutListToPDF() {
                const { jsPDF } = window.jspdf;
                const permits = getStudentPermitsOut();
                if (permits.length === 0) { showNotification('Tidak ada data untuk dicetak.', true); return; }
                const students = getStudents();
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF('l', 'mm', 'a4');
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI SURAT IZIN KELUAR SISWA', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = permits.map((permit, index) => {
                    const student = students.find(s => s.id == permit.studentId) || {};
                    return [index + 1, permit.tanggalIzin, student.namaSiswa, student.kelas, permit.durasi, permit.alasan];
                });

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tgl Izin', 'Nama Siswa', 'Kelas', 'Durasi', 'Alasan']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 20;
                if(doc.internal.pageSize.height < signY + 30) { doc.addPage(); signY = 20; }
                const signX = doc.internal.pageSize.width - 70;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, signX, signY, {align: 'center'});
                doc.text(`Guru BK,`, signX, signY + 7, {align: 'center'}); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', signX, signY, {align: 'center'}); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, signX, signY, {align: 'center'});
                
                doc.save('Rekap_Surat_Izin_Keluar_Siswa.pdf');
            }

            // --- FUNGSI UPLOAD MASSAL ---
            function downloadExcelTemplate() {
                const headers = [
                    "namaSiswa", "nisn", "kelas", "jenisKelamin", "alamatSiswa",
                    "namaAyah", "hpAyah", "namaIbu", "hpIbu", "hpSiswa", "statusAnak"
                ];
                const worksheet = XLSX.utils.aoa_to_sheet([headers]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Template Siswa");
                XLSX.writeFile(workbook, "Template_Upload_Siswa.xlsx");
            }
            function handleBulkUpload() {
                const input = document.getElementById('bulkStudentUploadInput');
                const file = input.files[0];
                if (!file) {
                    showNotification('Silakan pilih berkas Excel terlebih dahulu.', true);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if (json.length === 0) {
                            showNotification('Berkas Excel kosong atau format tidak sesuai.', true);
                            return;
                        }

                        let students = getStudents();
                        let addedCount = 0;
                        json.forEach(row => {
                            if (row.namaSiswa && row.kelas) { // Required fields
                                const newStudent = { id: Date.now() + Math.random(), ...row };
                                students.push(newStudent);
                                addedCount++;
                            }
                        });
                        saveStudents(students);
                        renderStudentTable();
                        renderDashboard();
                        showNotification(`${addedCount} siswa berhasil ditambahkan dari berkas.`);
                    } catch (err) {
                        showNotification('Gagal memproses berkas. Pastikan formatnya benar.', true);
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
                input.value = ''; // Reset file input
            }

            function exportIndividualCounselingToPDF() {
                const { jsPDF } = window.jspdf;
                const sessions = getCounselingSessions();
                if (sessions.length === 0) {
                    showNotification('Tidak ada data untuk dicetak.', true);
                    return;
                }
                const students = getStudents();
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI KONSELING INDIVIDU', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = sessions.map((s, index) => {
                    const student = students.find(stud => stud.id == s.studentId) || {};
                    return [
                        index + 1,
                        s.tanggal || '',
                        student.namaSiswa || 'Siswa Dihapus',
                        student.kelas || '-',
                        s.identifikasiMasalah || '',
                        s.statusKonseling || ''
                    ];
                });

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tanggal', 'Nama Siswa', 'Kelas', 'Masalah', 'Status']],
                    body: tableBody,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }

                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });
                
                doc.save('Rekap_Konseling_Individu.pdf');
            }

            function exportConsultationListToPDF() {
                const { jsPDF } = window.jspdf;
                const sessions = getConsultations();
                if (sessions.length === 0) {
                    showNotification('Tidak ada data untuk dicetak.', true);
                    return;
                }
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI KONSULTASI', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = sessions.map((s, index) => [
                    index + 1,
                    s.tanggal || '',
                    s.namaKonsulti || '',
                    s.statusKonsulti || '',
                    s.uraianTopik || ''
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tanggal', 'Nama Konsulti', 'Status', 'Topik']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });
                
                doc.save('Rekap_Konsultasi.pdf');
            }

            function exportClassicalServiceListToPDF() {
                const { jsPDF } = window.jspdf;
                const services = getClassicalServices();
                if (services.length === 0) {
                    showNotification('Tidak ada data untuk dicetak.', true);
                    return;
                }
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI LAYANAN KLASIKAL', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = services.map((s, index) => [
                    index + 1,
                    s.tanggal || '',
                    s.topik || '',
                    s.sasaran || '',
                    s.bidangLayanan || ''
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tanggal', 'Topik Layanan', 'Sasaran', 'Bidang']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });
                
                doc.save('Rekap_Layanan_Klasikal.pdf');
            }

            function exportGroupGuidanceListToPDF() {
                const { jsPDF } = window.jspdf;
                const sessions = getGroupGuidanceSessions();
                if (sessions.length === 0) {
                    showNotification('Tidak ada data untuk dicetak.', true);
                    return;
                }
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI BIMBINGAN KELOMPOK', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = sessions.map((s, index) => [
                    index + 1,
                    s.tanggal || '',
                    s.aspekLayanan || '',
                    s.students.length
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tanggal', 'Aspek Layanan', 'Jumlah Siswa']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });
                
                doc.save('Rekap_Bimbingan_Kelompok.pdf');
            }

            function exportGroupCounselingListToPDF() {
                const { jsPDF } = window.jspdf;
                const sessions = getGroupCounselingSessions();
                if (sessions.length === 0) {
                    showNotification('Tidak ada data untuk dicetak.', true);
                    return;
                }
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI KONSELING KELOMPOK', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = sessions.map((s, index) => [
                    index + 1,
                    s.tanggal || '',
                    s.identifikasiMasalah || '',
                    s.students.length,
                    s.status || ''
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Tanggal', 'Identifikasi Masalah', 'Jumlah Siswa', 'Status']],
                    body: tableBody,
                    theme: 'grid', styles: { fontSize: 9 }, headStyles: { fillColor: [71, 85, 105] }
                });
                
                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });
                
                doc.save('Rekap_Konseling_Kelompok.pdf');
            }

            function exportStudentListToPDF() {
                const { jsPDF } = window.jspdf;
                const students = getStudents();
                if (students.length === 0) {
                    showNotification('Tidak ada data siswa untuk dicetak.', true);
                    return;
                }
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('DAFTAR PROFIL SISWA', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                const tableBody = students.map((s, index) => [
                    index + 1,
                    s.namaSiswa || '',
                    s.nisn || '-',
                    s.kelas || '-',
                    s.jenisKelamin || '-'
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Nama Siswa', 'NISN', 'Kelas', 'Jenis Kelamin']],
                    body: tableBody,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [71, 85, 105] } // slate-600
                });
                
                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save(`Daftar_Siswa.pdf`);
            }
            function exportGroupGuidanceToExcel(sessionId) {
                const item = getGroupGuidanceSessions().find(s => s.id == sessionId);
                if (!item) return;
                const students = item.students.map(s => s.namaSiswa).join(', ');
                const data = [{
                    "Tanggal": item.tanggal, 
                    "Aspek Layanan": item.aspekLayanan,
                    "Tujuan": item.tujuanLayanan, 
                    "Anggota": students
                }];
                const headers = ["Tanggal", "Aspek Layanan", "Tujuan", "Anggota"];
                exportToExcel(data, headers, `BimbinganKelompok_${item.tanggal}`);
            }
            function exportGroupCounselingToPDF(sessionId) {
                const { jsPDF } = window.jspdf;
                const session = getGroupCounselingSessions().find(s => s.id == sessionId);
                if (!session) return;
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};

                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN KONSELING KELOMPOK', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Deskripsi', 'Keterangan']],
                    body: [
                        ['Tanggal', formatDateIndonesian(session.tanggal)],
                        ['Identifikasi Masalah', session.identifikasiMasalah || ''],
                        ['Hasil', session.hasil || ''],
                        ['Status', session.status || '']
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] }, // slate-600
                    styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });
                yPos = doc.autoTable.previous.finalY + 10;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Nama Siswa', 'Kelas']],
                    body: session.students.map((s, i) => [i + 1, s.namaSiswa, s.kelas]),
                    theme: 'grid', styles: { fontSize: 10 },
                    headStyles: { fillColor: [71, 85, 105] }
                });

                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(session.tanggal)}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save(`Konseling_Kelompok_${session.tanggal}.pdf`);
            }
            function exportDashboardToPDF() {
                const { jsPDF } = window.jspdf;
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REKAPITULASI LAYANAN BIMBINGAN DAN KONSELING', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;

                const students = getStudents();
                const totalStudents = students.length;
                const maleStudents = students.filter(s => s.jenisKelamin === 'Laki-laki').length;
                const femaleStudents = totalStudents - maleStudents;
                
                const studentSummary = [
                    ["Total Siswa", totalStudents],
                    ["Siswa Laki-laki", maleStudents],
                    ["Siswa Perempuan", femaleStudents]
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [['Data Siswa', 'Jumlah']],
                    body: studentSummary,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] },
                    didDrawPage: (data) => {
                        yPos = data.cursor.y;
                    }
                });
                
                yPos = doc.autoTable.previous.finalY + 15;

                const layananData = [
                    [1, "Konseling Individu", getCounselingSessions().length],
                    [2, "Konsultasi", getConsultations().length],
                    [3, "Layanan Klasikal", getClassicalServices().length],
                    [4, "Bimbingan Kelompok", getGroupGuidanceSessions().length],
                    [5, "Konseling Kelompok", getGroupCounselingSessions().length],
                    [6, "Surat Keluar", getOutgoingMail().length],
                    [7, "Surat Masuk", getIncomingMail().length]
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [['No', 'Jenis Layanan / Kegiatan', 'Jumlah']],
                    body: layananData,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105] },
                    didDrawPage: (data) => {
                        yPos = data.cursor.y;
                    }
                });

                let signY = doc.autoTable.previous.finalY + 25;
                if(doc.internal.pageSize.height < signY + 40) { // check if signature fits
                     doc.addPage();
                     signY = 20;
                }

                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save('Rekapitulasi_Layanan_BK.pdf');
            }

            function exportStudentDetailToPDF(studentId) {
                const { jsPDF } = window.jspdf;
                const student = getStudents().find(s => s.id == studentId);
                if (!student) {
                    showNotification('Data siswa tidak ditemukan.', true);
                    return;
                }
                const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                const doc = new jsPDF();
                let yPos = drawPdfHeader(doc, schoolProfile);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('PROFIL DETAIL SISWA', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;

                const studentData = [
                    ['Nama Lengkap', `: ${student.namaSiswa || '-'}`],
                    ['NISN', `: ${student.nisn || '-'}`],
                    ['Kelas', `: ${student.kelas || '-'}`],
                    ['Jenis Kelamin', `: ${student.jenisKelamin || '-'}`],
                    ['Alamat', `: ${student.alamatSiswa || '-'}`],
                    ['Status dalam Keluarga', `: ${student.statusAnak || '-'}`],
                    ['No. HP Siswa', `: ${student.hpSiswa || '-'}`],
                    ['Nama Ayah', `: ${student.namaAyah || '-'}`],
                    ['No. HP Ayah', `: ${student.hpAyah || '-'}`],
                    ['Nama Ibu', `: ${student.namaIbu || '-'}`],
                    ['No. HP Ibu', `: ${student.hpIbu || '-'}`],
                ];

                doc.autoTable({
                    startY: yPos,
                    body: studentData,
                    theme: 'plain',
                    styles: { fontSize: 10 },
                    columnStyles: { 0: { fontStyle: 'bold', cellWidth: 50 } }
                });

                let signY = doc.autoTable.previous.finalY + 15;
                if(doc.internal.pageSize.height < signY + 40) { doc.addPage(); signY = 20; }
                const centerX = doc.internal.pageSize.width / 2;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${schoolProfile.asalSekolah || '..............'}, ${formatDateIndonesian(new Date())}`, centerX, signY, { align: 'center' });
                doc.text(`Guru BK,`, centerX, signY + 7, { align: 'center' }); signY += 32;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(schoolProfile.namaGuruBk || '(.......................................)', centerX, signY, { align: 'center' }); signY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP. ${schoolProfile.nipGuruBk || '-'}`, centerX, signY, { align: 'center' });

                doc.save(`Profil_${student.namaSiswa.replace(/\s+/g, '_')}.pdf`);
            }
            function exportGroupCounselingToExcel(sessionId) {
                const item = getGroupCounselingSessions().find(s => s.id == sessionId);
                if (!item) return;
                const students = item.students.map(s => s.namaSiswa).join(', ');
                const data = [{
                    "Tanggal": item.tanggal, "Masalah": item.identifikasiMasalah, "Status": item.status,
                    "Hasil": item.hasil, "Anggota": students
                }];
                const headers = ["Tanggal", "Masalah", "Status", "Hasil", "Anggota"];
                exportToExcel(data, headers, `KonselingKelompok_${item.tanggal}`);
            }

            // --- FUNGSI PENGHAPUSAN ---
            function confirmDeletion() {
                if (currentItemTypeToDelete === 'student') {
                    saveStudents(getStudents().filter(s => s.id != currentItemIdToDelete));
                    renderStudentTable();
                    saveCounselingSessions(getCounselingSessions().filter(s => s.studentId != currentItemIdToDelete));
                    renderCounselingTable();
                    showNotification('Data siswa dan riwayatnya berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'counseling') {
                    saveCounselingSessions(getCounselingSessions().filter(s => s.id != currentItemIdToDelete)); renderCounselingTable(); showNotification('Sesi konseling berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'consultation') {
                    saveConsultations(getConsultations().filter(c => c.id != currentItemIdToDelete)); renderConsultationTable(); showNotification('Sesi konsultasi berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'classicalService') {
                    saveClassicalServices(getClassicalServices().filter(s => s.id != currentItemIdToDelete)); renderClassicalServiceTable(); showNotification('Layanan klasikal berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'groupGuidance') {
                    saveGroupGuidanceSessions(getGroupGuidanceSessions().filter(s => s.id != currentItemIdToDelete)); renderGroupGuidanceTable(); showNotification('Bimbingan kelompok berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'groupCounseling') {
                    saveGroupCounselingSessions(getGroupCounselingSessions().filter(s => s.id != currentItemIdToDelete)); renderGroupCounselingTable(); showNotification('Konseling kelompok berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'journal') {
                    saveJournals(getJournals().filter(j => j.id != currentItemIdToDelete)); renderJournalTable(); showNotification('Catatan jurnal berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'mailOut') {
                    saveOutgoingMail(getOutgoingMail().filter(m => m.id != currentItemIdToDelete)); renderMailOutTable(); showNotification('Surat keluar berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'mailIn') {
                    saveIncomingMail(getIncomingMail().filter(m => m.id != currentItemIdToDelete)); renderMailInTable(); showNotification('Surat masuk berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'homeVisit') {
                    saveHomeVisits(getHomeVisits().filter(v => v.id != currentItemIdToDelete)); renderHomeVisitTable(); showNotification('Laporan kunjungan rumah berhasil dihapus.');
                } else if (currentItemTypeToDelete === 'behaviorContract') {
                    saveBehaviorContracts(getBehaviorContracts().filter(bc => bc.id != currentItemIdToDelete)); renderBehaviorContractTable(); showNotification('Kontrak perilaku berhasil dihapus.');
                }
                hideModal('deleteModal'); currentItemIdToDelete = null; currentItemTypeToDelete = ''; renderDashboard();
            }
            function showDeleteConfirmation(id, type) {
                currentItemIdToDelete = id; currentItemTypeToDelete = type;
                let itemText = '';
                if (type === 'student') itemText = 'siswa (dan semua riwayat terkait)';
                else if (type.includes('counseling')) itemText = 'sesi konseling';
                else if (type.includes('consultation')) itemText = 'sesi konsultasi';
                else if (type.includes('classical')) itemText = 'layanan klasikal';
                else if (type.includes('guidance')) itemText = 'bimbingan kelompok';
                else if (type.includes('journal')) itemText = 'catatan jurnal';
                else if (type.includes('mail')) itemText = 'data surat';
                else if (type.includes('homeVisit')) itemText = 'laporan kunjungan rumah';
                else if (type.includes('behaviorContract')) itemText = 'kontrak perilaku';
                else if (type.includes('studentPermitOut')) itemText = 'surat izin keluar';

                const content = `<div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm mx-auto border border-slate-700"><h3 class="text-lg font-bold text-slate-100 mb-4">Konfirmasi Hapus</h3><p class="text-slate-300 mb-6">Apakah Anda yakin ingin menghapus ${itemText} ini?</p><div class="flex justify-end space-x-4"><button class="cancel-modal-btn px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500">Batal</button><button id="confirmDeleteButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700">Hapus</button></div></div>`;
                showModal('deleteModal', content);
                document.getElementById('confirmDeleteButton').addEventListener('click', confirmDeletion);
            }

            // --- FUNGSI PENGATURAN ---
            function backupData() {
                const dataToBackup = { 
                    schoolProfile: JSON.parse(localStorage.getItem('schoolProfile')) || {}, 
                    students: getStudents(), 
                    counselingSessions: getCounselingSessions(),
                    consultations: getConsultations(),
                    classicalServices: getClassicalServices(),
                    groupGuidanceSessions: getGroupGuidanceSessions(),
                    groupCounselingSessions: getGroupCounselingSessions(),
                    journals: getJournals(),
                    outgoingMail: getOutgoingMail(),
                    incomingMail: getIncomingMail(),
                    homeVisits: getHomeVisits(),
                    behaviorContracts: getBehaviorContracts(),
                    studentPermitsOut: getStudentPermitsOut(),
                    appToken: localStorage.getItem('appToken') || '123456'
                };
                const dataStr = JSON.stringify(dataToBackup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                a.href = url; a.download = `backup_bk_${date}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Backup data berhasil diunduh.');
            }
            function handleRestoreFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.schoolProfile && Array.isArray(data.students)) {
                            localStorage.setItem('schoolProfile', JSON.stringify(data.schoolProfile));
                            saveStudents(data.students || []);
                            saveCounselingSessions(data.counselingSessions || []);
                            saveConsultations(data.consultations || []);
                            saveClassicalServices(data.classicalServices || []);
                            saveGroupGuidanceSessions(data.groupGuidanceSessions || []);
                            saveGroupCounselingSessions(data.groupCounselingSessions || []);
                            saveJournals(data.journals || []);
                            saveOutgoingMail(data.outgoingMail || []);
                            saveIncomingMail(data.incomingMail || []);
                            saveHomeVisits(data.homeVisits || []);
                            saveBehaviorContracts(data.behaviorContracts || []);
                            saveStudentPermitsOut(data.studentPermitsOut || []);
                            if(data.appToken) localStorage.setItem('appToken', data.appToken);
                            loadProfileData(); renderStudentTable(); renderCounselingTable(); renderConsultationTable(); renderClassicalServiceTable(); renderGroupGuidanceTable(); renderGroupCounselingTable(); renderMailOutTable(); renderMailInTable(); renderJournalTable(); renderHomeVisitTable(); renderBehaviorContractTable(); renderStudentPermitOutTable();
                            showNotification('Data berhasil dipulihkan.');
                            renderDashboard();
                        } else { throw new Error('Format berkas tidak valid.'); }
                    } catch (error) { showNotification('Gagal memulihkan data: ' + error.message, true); }
                };
                reader.readAsText(file);
                event.target.value = '';
            }
            function confirmDeleteAllData() {
                localStorage.clear();
                hideModal('deleteAllDataModal');
                showNotification('Semua data berhasil dihapus.');
                setTimeout(() => window.location.reload(), 1000);
            }
            function handleLogoUpload(event, previewId) {
                const file = event.target.files[0];
                if (!file || !file.type.startsWith('image/png')) {
                    showNotification('Silakan pilih berkas PNG.', true);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById(previewId);
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
            function saveLogos() {
                const logoKiriSrc = document.getElementById('logoKiriPreview').src;
                const logoKananSrc = document.getElementById('logoKananPreview').src;

                if (logoKiriSrc && logoKiriSrc.startsWith('data:image')) {
                     localStorage.setItem('schoolLogoLeft', logoKiriSrc);
                }
                if (logoKananSrc && logoKananSrc.startsWith('data:image')) {
                     localStorage.setItem('schoolLogoRight', logoKananSrc);
                }
                showNotification('Logo berhasil disimpan.');
            }
            function loadLogos() {
                const logoKiri = localStorage.getItem('schoolLogoLeft');
                const logoKanan = localStorage.getItem('schoolLogoRight');
                if (logoKiri) {
                    const preview = document.getElementById('logoKiriPreview');
                    preview.src = logoKiri;
                    preview.classList.remove('hidden');
                }
                if (logoKanan) {
                    const preview = document.getElementById('logoKananPreview');
                    preview.src = logoKanan;
                    preview.classList.remove('hidden');
                }
            }


            // --- INISIALISASI & EVENT LISTENERS ---
            function initializeApp() {
                setupNavigation();

                document.getElementById('logoutButton').addEventListener('click', () => {
                    window.location.reload();
                });

                // Dropdown Logic
                const dropdownButton = document.getElementById('layananBkDropdownButton');
                const dropdownContent = document.getElementById('layananBkDropdownContent');
                dropdownButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    dropdownContent.classList.toggle('hidden');
                });
                window.addEventListener('click', () => {
                    if (!dropdownContent.classList.contains('hidden')) {
                        dropdownContent.classList.add('hidden');
                    }
                });
                
                // Listeners Dashboard
                document.getElementById('printDashboardPdfButton').addEventListener('click', exportDashboardToPDF);

                // Listeners Profil Sekolah
                document.getElementById('schoolProfileForm').addEventListener('submit', saveProfileData);
                document.getElementById('editSchoolProfileButton').addEventListener('click', () => toggleSchoolProfileView(true));
                document.getElementById('cancelSchoolEditButton').addEventListener('click', () => { if (Object.keys(JSON.parse(localStorage.getItem('schoolProfile') || '{}')).length > 0) { loadProfileData(); toggleSchoolProfileView(false); } });
                document.getElementById('addKelasAsuhButton').addEventListener('click', addKelasAsuh);
                document.getElementById('addSemesterButton').addEventListener('click', addSemester);
                document.getElementById('kelasAsuhList').addEventListener('click', e => { if (e.target.classList.contains('delete-kelas-btn')) { deleteKelasAsuh(e.target.dataset.index); } });
                document.getElementById('semesterList').addEventListener('click', e => { if (e.target.classList.contains('delete-semester-btn')) { deleteSemester(e.target.dataset.index); } });
                document.getElementById('kelasAsuhList').addEventListener('input', e => { if (e.target.classList.contains('wali-kelas-input')) { kelasAsuhData[e.target.dataset.index].wali = e.target.value; } });

                // Listeners Profil Siswa
                document.getElementById('studentProfileForm').addEventListener('submit', handleStudentFormSubmit);
                document.getElementById('cancelEditButton').addEventListener('click', resetStudentForm);
                document.getElementById('studentListContainer').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-student-btn')) editStudent(id);
                    if (e.target.classList.contains('delete-student-btn')) showDeleteConfirmation(id, 'student');
                    if (e.target.classList.contains('detail-student-btn')) showStudentDetail(id);
                });
                document.getElementById('downloadTemplateLink').addEventListener('click', downloadExcelTemplate);
                document.getElementById('processBulkUploadButton').addEventListener('click', handleBulkUpload);
                document.getElementById('printStudentListPdfButton').addEventListener('click', exportStudentListToPDF);

                // Listeners Konseling Individu
                document.getElementById('printIndividualCounselingPdfButton').addEventListener('click', exportIndividualCounselingToPDF);
                document.getElementById('addNewCounselingButton').addEventListener('click', () => { resetCounselingForm(); toggleCounselingView(true); });
                document.getElementById('counselingForm').addEventListener('submit', handleCounselingFormSubmit);
                document.getElementById('cancelCounselingButton').addEventListener('click', () => { toggleCounselingView(false); });
                document.getElementById('counselingTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-counseling-btn')) editCounseling(id);
                    if (e.target.classList.contains('delete-counseling-btn')) showDeleteConfirmation(id, 'counseling');
                    if (e.target.classList.contains('detail-counseling-btn')) showCounselingDetail(id);
                });
                document.getElementById('counseling_studentId').addEventListener('change', e => {
                    const studentId = e.target.value;
                    const classInput = document.getElementById('counseling_studentClass');
                    if (studentId) {
                        const student = getStudents().find(s => s.id == studentId);
                        classInput.value = student ? student.kelas : '';
                    } else { classInput.value = ''; }
                });

                // Listeners Konsultasi
                document.getElementById('printConsultationListPdfButton').addEventListener('click', exportConsultationListToPDF);
                document.getElementById('addNewConsultationButton').addEventListener('click', () => { resetConsultationForm(); toggleConsultationView(true); });
                document.getElementById('consultationForm').addEventListener('submit', handleConsultationFormSubmit);
                document.getElementById('cancelConsultationButton').addEventListener('click', () => { toggleConsultationView(false); });
                document.getElementById('consultationTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-consultation-btn')) editConsultation(id);
                    if (e.target.classList.contains('delete-consultation-btn')) showDeleteConfirmation(id, 'consultation');
                    if (e.target.classList.contains('detail-consultation-btn')) showConsultationDetail(id);
                });

                // Listeners Layanan Klasikal
                document.getElementById('printClassicalServiceListPdfButton').addEventListener('click', exportClassicalServiceListToPDF);
                document.getElementById('addNewClassicalServiceButton').addEventListener('click', () => { resetClassicalServiceForm(); toggleClassicalServiceView(true); });
                document.getElementById('classicalServiceForm').addEventListener('submit', handleClassicalServiceFormSubmit);
                document.getElementById('cancelClassicalServiceButton').addEventListener('click', () => { toggleClassicalServiceView(false); });
                document.getElementById('classicalServiceTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-classical-btn')) editClassicalService(id);
                    if (e.target.classList.contains('delete-classical-btn')) showDeleteConfirmation(id, 'classicalService');
                    if (e.target.classList.contains('detail-classical-btn')) showClassicalServiceDetail(id);
                });

                // Listeners Bimbingan Kelompok
                document.getElementById('printGroupGuidanceListPdfButton').addEventListener('click', exportGroupGuidanceListToPDF);
                document.getElementById('addNewGroupGuidanceButton').addEventListener('click', () => { toggleGroupGuidanceView(true); });
                document.getElementById('groupGuidanceForm').addEventListener('submit', handleGroupGuidanceFormSubmit);
                document.getElementById('cancelGroupGuidanceButton').addEventListener('click', () => { toggleGroupGuidanceView(false); });
                document.getElementById('addGroupGuidanceStudentButton').addEventListener('click', () => {
                    const selector = document.getElementById('group_guidance_studentSelector');
                    const studentId = selector.value;
                    if (!studentId) return;
                    if (selectedStudentsForGuidance.some(s => s.id == studentId)) {
                        showNotification('Siswa sudah ditambahkan.', true);
                        return;
                    }
                    const student = getStudents().find(s => s.id == studentId);
                    if (student) {
                        selectedStudentsForGuidance.push({ id: student.id, namaSiswa: student.namaSiswa, kelas: student.kelas });
                        renderSelectedStudentsForGuidance();
                        selector.value = '';
                    }
                });
                document.getElementById('group_guidance_studentList').addEventListener('click', e => {
                    if (e.target.classList.contains('remove-guidance-student-btn')) {
                        selectedStudentsForGuidance.splice(e.target.dataset.index, 1);
                        renderSelectedStudentsForGuidance();
                    }
                });
                 document.getElementById('groupGuidanceTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-group-guidance-btn')) editGroupGuidance(id);
                    if (e.target.classList.contains('delete-group-guidance-btn')) showDeleteConfirmation(id, 'groupGuidance');
                    if (e.target.classList.contains('detail-group-guidance-btn')) showGroupGuidanceDetail(id);
                });
                
                // Listeners Konseling Kelompok
                document.getElementById('printGroupCounselingListPdfButton').addEventListener('click', exportGroupCounselingListToPDF);
                document.getElementById('addNewGroupCounselingButton').addEventListener('click', () => { toggleGroupCounselingView(true); });
                document.getElementById('groupCounselingForm').addEventListener('submit', handleGroupCounselingFormSubmit);
                document.getElementById('cancelGroupCounselingButton').addEventListener('click', () => { toggleGroupCounselingView(false); });
                document.getElementById('addGroupCounselingStudentButton').addEventListener('click', () => {
                    const selector = document.getElementById('group_counseling_studentSelector');
                    const studentId = selector.value;
                    if (!studentId) return;
                    if (selectedStudentsForCounseling.some(s => s.id == studentId)) {
                        showNotification('Siswa sudah ditambahkan.', true);
                        return;
                    }
                    const student = getStudents().find(s => s.id == studentId);
                    if (student) {
                        selectedStudentsForCounseling.push({ id: student.id, namaSiswa: student.namaSiswa, kelas: student.kelas });
                        renderSelectedStudentsForCounseling();
                        selector.value = '';
                    }
                });
                document.getElementById('group_counseling_studentList').addEventListener('click', e => {
                    if (e.target.classList.contains('remove-counseling-student-btn')) {
                        selectedStudentsForCounseling.splice(e.target.dataset.index, 1);
                        renderSelectedStudentsForCounseling();
                    }
                });
                 document.getElementById('groupCounselingTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-group-counseling-btn')) editGroupCounseling(id);
                    if (e.target.classList.contains('delete-group-counseling-btn')) showDeleteConfirmation(id, 'groupCounseling');
                    if (e.target.classList.contains('detail-group-counseling-btn')) showGroupCounselingDetail(id);
                });

                // Listeners Jurnal
                document.getElementById('printJournalListPdfButton').addEventListener('click', exportJournalListToPDF);
                document.getElementById('addNewJournalButton').addEventListener('click', () => { resetJournalForm(); toggleJournalView(true); });
                document.getElementById('journalForm').addEventListener('submit', handleJournalFormSubmit);
                document.getElementById('cancelJournalButton').addEventListener('click', () => { toggleJournalView(false); });
                document.getElementById('journalTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-journal-btn')) editJournal(id);
                    if (e.target.classList.contains('delete-journal-btn')) showDeleteConfirmation(id, 'journal');
                    if (e.target.classList.contains('detail-journal-btn')) showJournalDetail(id);
                });

                // Listeners Surat Keluar/Masuk (Mail Section)
                const mailTabs = [
                    { btn: 'showOutgoingMailBtn', content: 'outgoingMailContent' },
                    { btn: 'showIncomingMailBtn', content: 'incomingMailContent' },
                    { btn: 'showHomeVisitBtn', content: 'homeVisitContent' },
                    { btn: 'showBehaviorContractBtn', content: 'behaviorContractContent' },
                    { btn: 'showStudentPermitOutBtn', content: 'studentPermitOutContent' }
                ];

                mailTabs.forEach(clickedTab => {
                    document.getElementById(clickedTab.btn).addEventListener('click', () => {
                        // Loop through all tabs to set their state
                        mailTabs.forEach(tab => {
                            const button = document.getElementById(tab.btn);
                            const content = document.getElementById(tab.content);
                            const isActive = tab.btn === clickedTab.btn;

                            // Toggle visibility and active classes
                            content.classList.toggle('hidden', !isActive);
                            button.classList.toggle('active', isActive);
                            button.classList.toggle('bg-slate-700', isActive);
                            button.classList.toggle('bg-slate-900/50', !isActive);
                        });
                        
                        // Populate dropdowns if needed when a tab is activated
                        if (clickedTab.btn === 'showHomeVisitBtn') {
                            const visits = getHomeVisits();
                            toggleHomeVisitView(visits.length === 0 && getStudents().length > 0);
                            populateHomeVisitStudentDropdown();
                        } else if (clickedTab.btn === 'showBehaviorContractBtn') {
                            const contracts = getBehaviorContracts();
                            toggleBehaviorContractView(contracts.length === 0 && getStudents().length > 0);
                            populateBehaviorContractStudentDropdown();
                        } else if (clickedTab.btn === 'showStudentPermitOutBtn') {
                            const permits = getStudentPermitsOut();
                            toggleStudentPermitOutView(permits.length === 0 && getStudents().length > 0);
                            populateStudentPermitOutStudentDropdown();
                        }
                    });
                });
                
                document.getElementById('addNewMailOutButton').addEventListener('click', () => { resetMailOutForm(); toggleMailOutView(true); });
                document.getElementById('mailOutForm').addEventListener('submit', handleMailOutFormSubmit);
                document.getElementById('cancelMailOutButton').addEventListener('click', () => { toggleMailOutView(false); });
                document.getElementById('mailOutTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-mailOut-btn')) editMailOut(id);
                    if (e.target.classList.contains('delete-mailOut-btn')) showDeleteConfirmation(id, 'mailOut');
                    if (e.target.classList.contains('detail-mailOut-btn')) showMailOutDetail(id);
                });
                document.getElementById('mailOut_studentId').addEventListener('change', e => {
                    const studentId = e.target.value;
                    const nisnInput = document.getElementById('mailOut_nisn');
                    const kelasInput = document.getElementById('mailOut_kelas');
                    const waliKelasInput = document.getElementById('mailOut_namaWaliKelas');
                    
                    if (studentId) {
                        const student = getStudents().find(s => s.id == studentId);
                        const schoolProfile = JSON.parse(localStorage.getItem('schoolProfile')) || {};
                        const kelasAsuh = (schoolProfile.kelasAsuh || []).find(k => k.kelas === student.kelas);
                        nisnInput.value = student ? student.nisn : '';
                        kelasInput.value = student ? student.kelas : '';
                        waliKelasInput.value = kelasAsuh ? kelasAsuh.wali : 'Belum diisi';
                    } else {
                        nisnInput.value = '';
                        kelasInput.value = '';
                        waliKelasInput.value = '';
                    }
                });
                
                document.getElementById('addNewMailInButton').addEventListener('click', () => { resetMailInForm(); toggleMailInView(true); });
                document.getElementById('mailInForm').addEventListener('submit', handleMailInFormSubmit);
                document.getElementById('cancelMailInButton').addEventListener('click', () => { toggleMailInView(false); });
                document.getElementById('mailInTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-mailIn-btn')) editMailIn(id);
                    if (e.target.classList.contains('delete-mailIn-btn')) showDeleteConfirmation(id, 'mailIn');
                    if (e.target.classList.contains('detail-mailIn-btn')) showMailInDetail(id);
                });

                // Listeners Kunjungan Rumah
                document.getElementById('addNewHomeVisitButton').addEventListener('click', () => { resetHomeVisitForm(); toggleHomeVisitView(true); });
                document.getElementById('homeVisitForm').addEventListener('submit', handleHomeVisitFormSubmit);
                document.getElementById('cancelHomeVisitButton').addEventListener('click', () => { toggleHomeVisitView(false); });
                document.getElementById('homeVisitTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-homeVisit-btn')) editHomeVisit(id);
                    if (e.target.classList.contains('delete-homeVisit-btn')) showDeleteConfirmation(id, 'homeVisit');
                    if (e.target.classList.contains('detail-homeVisit-btn')) showHomeVisitDetail(id);
                });
                document.getElementById('homeVisit_studentId').addEventListener('change', e => {
                    const studentId = e.target.value;
                    const nisnInput = document.getElementById('homeVisit_nisn');
                    const kelasInput = document.getElementById('homeVisit_kelas');
                    if (studentId) {
                        const student = getStudents().find(s => s.id == studentId);
                        nisnInput.value = student ? student.nisn : '';
                        kelasInput.value = student ? student.kelas : '';
                    } else {
                        nisnInput.value = '';
                        kelasInput.value = '';
                    }
                });

                // Listeners Kontrak Perilaku
                document.getElementById('addNewBehaviorContractButton').addEventListener('click', () => { resetBehaviorContractForm(); toggleBehaviorContractView(true); });
                document.getElementById('behaviorContractForm').addEventListener('submit', handleBehaviorContractFormSubmit);
                document.getElementById('cancelBehaviorContractButton').addEventListener('click', () => { toggleBehaviorContractView(false); });
                document.getElementById('behaviorContractTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-behaviorContract-btn')) editBehaviorContract(id);
                    if (e.target.classList.contains('delete-behaviorContract-btn')) showDeleteConfirmation(id, 'behaviorContract');
                    if (e.target.classList.contains('detail-behaviorContract-btn')) showBehaviorContractDetail(id);
                });
                document.getElementById('behaviorContract_studentId').addEventListener('change', e => {
                    const studentId = e.target.value;
                    const kelasInput = document.getElementById('behaviorContract_kelas');
                    if (studentId) {
                        const student = getStudents().find(s => s.id == studentId);
                        kelasInput.value = student ? student.kelas : '';
                    } else {
                        kelasInput.value = '';
                    }
                });

                // Listeners Surat Izin Keluar Siswa
                document.getElementById('addNewStudentPermitOutButton').addEventListener('click', () => { resetStudentPermitOutForm(); toggleStudentPermitOutView(true); });
                document.getElementById('studentPermitOutForm').addEventListener('submit', handleStudentPermitOutFormSubmit);
                document.getElementById('cancelStudentPermitOutButton').addEventListener('click', () => { toggleStudentPermitOutView(false); });
                document.getElementById('studentPermitOutTableBody').addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    if (e.target.classList.contains('edit-studentPermitOut-btn')) editStudentPermitOut(id);
                    if (e.target.classList.contains('delete-studentPermitOut-btn')) showDeleteConfirmation(id, 'studentPermitOut');
                    if (e.target.classList.contains('detail-studentPermitOut-btn')) showStudentPermitOutDetail(id);
                });
                document.getElementById('studentPermitOut_studentId').addEventListener('change', e => {
                    const studentId = e.target.value;
                    const kelasInput = document.getElementById('studentPermitOut_kelas');
                    if (studentId) {
                        const student = getStudents().find(s => s.id == studentId);
                        kelasInput.value = student ? student.kelas : '';
                    } else {
                        kelasInput.value = '';
                    }
                });

                // Listeners untuk tombol rekap PDF baru
                document.getElementById('printMailOutListPdfButton').addEventListener('click', exportMailOutListToPDF);
                document.getElementById('printHomeVisitListPdfButton').addEventListener('click', exportHomeVisitListToPDF);
                document.getElementById('printBehaviorContractListPdfButton').addEventListener('click', exportBehaviorContractListToPDF);
                document.getElementById('printStudentPermitOutListPdfButton').addEventListener('click', exportStudentPermitOutListToPDF);


                // Listeners Pengaturan
                document.getElementById('saveTokenButton').addEventListener('click', () => {
                    const newToken = document.getElementById('newTokenInput').value;
                    if (newToken) {
                        localStorage.setItem('appToken', newToken);
                        showNotification('Token berhasil disimpan.');
                        document.getElementById('newTokenInput').value = '';
                    } else { showNotification('Token tidak boleh kosong.', true); }
                });
                document.getElementById('backupButton').addEventListener('click', backupData);
                document.getElementById('restoreButton').addEventListener('click', () => document.getElementById('restoreFileInput').click());
                document.getElementById('restoreFileInput').addEventListener('change', handleRestoreFile);
                document.getElementById('deleteAllButton').addEventListener('click', () => {
                    const content = `<div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm mx-auto border border-slate-700"><h3 class="text-lg font-bold text-slate-100 mb-4">Hapus Semua Data?</h3><p class="text-slate-300 mb-6">Tindakan ini akan menghapus SEMUA data secara permanen dan tidak bisa diurungkan. Yakin ingin melanjutkan?</p><div class="flex justify-end space-x-4"><button class="cancel-modal-btn px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500">Batal</button><button id="confirmDeleteAllButton" class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700">Ya, Hapus Semua</button></div></div>`;
                    showModal('deleteAllDataModal', content);
                    document.getElementById('confirmDeleteAllButton').addEventListener('click', confirmDeleteAllData);
                });
                document.getElementById('logoKiriInput').addEventListener('change', (e) => handleLogoUpload(e, 'logoKiriPreview'));
                document.getElementById('logoKananInput').addEventListener('change', (e) => handleLogoUpload(e, 'logoKananPreview'));
                document.getElementById('saveLogosButton').addEventListener('click', saveLogos);
                
                // Panggil render awal
                displayCurrentDate();
                renderDashboard();
                loadProfileData();
                renderStudentTable();
                renderCounselingTable();
                renderConsultationTable();
                renderClassicalServiceTable();
                renderGroupGuidanceTable();
                renderGroupCounselingTable();
                renderMailOutTable();
                renderMailInTable();
                renderJournalTable();
                renderHomeVisitTable();
                renderBehaviorContractTable();
                renderStudentPermitOutTable();
                loadLogos();
            }
            
            // Inisialisasi Aplikasi
            setupLogin();
        });
    </script>
</body>
</html>






